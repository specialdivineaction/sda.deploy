{"version":3,"sources":["scripts/app.js"],"names":["angular","module","workspaceRepositoryProvider","vwise","workspaceRepositoryFactory","panelContentMediatorRegistry","$http","$q","pouchDB","db","provider","NgWorkspaceRepository","$inject","declare","name","$get","mediatorRegistry","WorkspaceRepository","call","this","workspaces","Cache","panels","prototype","Object","create","listWorkspaceIds","allDocs","include_docs","then","result","rows","filter","row","doc","type","map","id","createWorkspace","title","UUID","uuid4","workspace","Workspace","saveWorkspace","TypeError","dto","_id","_rev","marshallWorkspace","put","response","ok","Error","rev","getWorkspace","reject","repo","fetch","get","unmarshallWorkspace","removeWorkspace","remove","createPanel","mediator","content","vprops","panel","Panel","p","savePanel","marshallPanel","getPanel","panelId","unmarshallPanel","removePanel","vwiseWorkspace","directive","restrict","templateUrl","scope","controller","WorkspaceController","controllerAs","$scope","thingDropped","evt","ui","itemScope","draggable","item","offset","element","target","context","xPosition","position","left","yPosition","top","width","height","background","contentMediators","findContentMediators","length","contentP","initPanelData","createNotePanel","x","y","note","workspaceClicked","ctrlKey","clientX","clientY","vm","workPanelDirective","worksRepo","linkFunc","el","attrs","createExpandCollapseButton","toggleCollapse","button","icon","origSize","panelLabel","outerWidth","outerHeight","label","find","handler","addActionButton","getTitle","work","titles","editions","forEach","edition","workId","require","relationships","link","volumePanelDirective","volume","getEdition","editionId","editionPanelDirective","volumes","personPanelDirective","_","attr","person","at","NAME_KEYS","n","trim","identity","join","PersonPanelController","peopleRepo","relationshipsRepo","activate","worksP","getWorksAuthored","works","relatedP","getRelatedPeople","related","relatedPeople","authorId","searchByAuthor","$promise","items","relnsPs","getRelationships","relnsP","all","relnss","chain","flatten","groupBy","group","identifier","reverse","groups","clone","flatMap","value","groupPs","authorIdsPs","entity","authorIds","authors","authorIdsP","authorIdss","uniq","authorPs","author","uri","search","normRelnsP","relns","normRelns","normalizeRelationships","worksContentMediatorFactory","Mediator","PanelContentMediator","loadWork","loadRelationships","currentUri","results","reln","entities","refParams","volumeId","matches","obj","unmarshall","marshall","panelData","getTemplate","factory","volumesContentMediatorFactory","loadVolume","getVolume","peopleContentMediatorFactory","loadPerson","passthruContentMediatorFactory","panelContentMediatorRegistryFactory","PanelContentMediatorRegistry","noteContentMediatorFactory","hasOwnProperty","editionsContentMediatorFactory","loadEdition","internetArchiveContentMediatorFactory","hathitrustContentMediatorFactory","googleBooksContentMediatorFactory","vwisePanel","$compile","$el","controllers","panelController","getInfoArea","getStatusArea","vp","panelScope","$new","$watch","color","rgb","hextorgb","foreground","calculateForeground","save","template","contentMediator","contentArea","html","contents","replace","PanelController","spec","actionButtons","push","ix","indexOf","splice","addPropertyButton","propertyButtons","closePanel","movePanel","Math","max","stopMove","setPosition","activatePanel","startResize","resizing","resizePanel","$apply","stopResize","setSize","stopPropagation","hex","match","r","parseInt","g","b","pow","lum","iaReader","$sce","properties","src","trustAsResourceUrl","hathitrustReader","params","htid","seq","queryString","key","url","READER_URL","contenteditable","ngModel","$render","getTrustedHtml","$viewValue","on","$setViewValue","workspaceRepository","$stateParams","$log","$timeout","$mdSidenav","$mdToast","hotkeys","workspaceIdP","workspaceId","when","ids","workspaceP","bindTo","add","combo","description","callback","sidebarFocused","searchQuery","focus","toggle","query","tagAll","arr","loading","peopleResults","worksResults","property","showSimple","activeItems","debounce","runBlock","peopleContentMediator","worksContentMediator","editionsContentMediator","volumesContentMediator","googleBooksContentMediator","hathitrustContentMediator","internetArchiveContentMediator","noteContentMediator","passthruContentMediator","register","run","constant","config","googleBooksApiProvider","configure","preventLoad","worksRepoProvider","worksRepoFactory","$resource","findAll","restResource","q","aid","getWork","isUndefined","adaptWork","editionResource","adaptEdition","volumeResource","adaptVolume","createWork","createEdition","createVolume","arguments","saveWork","apply","saveEdition","saveVolume","$update","$save","deleteWork","dataItem","adaptCommon","toLowerCase","role","otherAuthors","copies","getTitleByTypePreference","types","isArray","reduce","found","update","method","getAll","relationshipsRepoProvider","relationshipsRepoFactory","getTypes","options","typesCache","force","typeResource","tcPromise","defineProperty","getType","createRelationship","relnResource","adaptRelationship","createProvenance","provenance","adaptProvenance","createAnchor","anchor","adaptAnchor","findById","isString","queryOpts","typeId","direction","start","off","saveRelationship","deleteRelationship","relatedEntities","targetEntities","creatorUris","entryUris","relationship","isReverse","some","targetField","resolveEntityUri","normReln","entityPs","relnsByTypeDir","fwd","typeGroups","typeGroupPs","kvMap","dirs","isDirected","reverseTitle","concat","ENTITY_URI","exec","makeVolumeEntity","makeEditionEntity","makeWorkEntity","labelP","formatTitle","editionName","volumeNumber","entityP","subtitle","o","cb","keys","k","arrs","flattened","prop","peopleRepoProvider","peopleRepoFactory","createPerson","adaptPerson","createMeta","meta","adaptMeta","createName","adaptName","createEvent","adaptEvent","createDateDescription","dateDescription","savePerson","personId","deletePerson","altNames","birth","death","links","date","trcPersonEditorDirective","PersonEditorController","addName","newName","removeName","addEvent","newEvent","removeEvent","trcNameEditorDirective","NameEditorController","roles","trcEventEditorDirective","event","extend","API","loadGoogleBooks","googleBooksScriptLoader","load","transport","v","language","$window","$document","getScriptUrl","includeScript","omitOptions","omit","scriptId","scriptElem","getElementById","parentNode","removeChild","round","random","appendTo","isGoogleBooksLoaded","isDefined","google","books","deferred","defer","resolve","promise","randomizedFunctionName","usedConfiguration","manualLoad","undefined","googleBookReader","googleBooksApi","googleBooksApiManualLoader","viewer","DefaultViewer","$on","resize","service","debug","routerConfig","$stateProvider","$urlRouterProvider","state","otherwise","moment","$logProvider","$mdThemingProvider","debugEnabled","definePalette","50","100","200","300","400","500","600","700","800","900","A100","A200","A400","A700","contrastDefaultColor","contrastDarkColors","theme","primaryPalette","accentPalette","$templateCache"],"mappings":"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","file":"scripts/app-af55b4ea08.js","sourcesContent":["(function () {\n  'use strict';\n\n  angular\n    .module('vwise', [\n      'ngSanitize',\n      'google.books',\n      'cfp.hotkeys',\n      'trcWorks',\n      'trcBio'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .provider('workspaceRepository', workspaceRepositoryProvider);\n\n  /** @ngInject */\n  function workspaceRepositoryProvider(vwise) {\n    var NgWorkspaceRepository = declare(vwise);\n\n    var provider = {\n      db: {\n        name: 'vwise'\n      },\n      $get: workspaceRepositoryFactory\n    };\n\n    return provider;\n\n    /** @ngInject */\n    function workspaceRepositoryFactory(panelContentMediatorRegistry, $http, $q, pouchDB) {\n      var db = pouchDB(provider.db);\n      return new NgWorkspaceRepository(panelContentMediatorRegistry, db, $q);\n    }\n  }\n\n  /**\n   * Declares and returns the NgWorkspaceRepository class.\n   * Required protoypical inheritance of vwise.WorkspaceRepository makes this class definition verbose but necessary.\n   * Ideally (and eventually) this should be done as an ES6 class in a separate file and loaded via an import statement.\n   * @param  {vwise} vwise\n   * @return {Class.<NgWorkspaceRepository>}\n   */\n  function declare(vwise) {\n    /**\n     * Angularized Workspace Repository powered via PouchDB; makes use of $q services (must be injected at construction)\n     * @class\n     * @extends {vwise.WorkspaceRepository}\n     */\n    function NgWorkspaceRepository(mediatorRegistry, db, $q) {\n      vwise.WorkspaceRepository.call(this, mediatorRegistry);\n\n      // injected services and configuration options\n      this.$q = $q;\n      this.db = db;\n\n      /**\n       * A cache for storing loaded workspace instances\n       * @type {vwise.Cache.<Promise.<Workspace>}\n       */\n      this.workspaces = new vwise.Cache;\n\n      /**\n      * A cache for storing loaded panel instances\n      * @type {vwise.Cache.<Promise.<Panel>}\n      */\n      this.panels = new vwise.Cache;\n    }\n\n    NgWorkspaceRepository.prototype = Object.create(vwise.WorkspaceRepository.prototype);\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.listWorkspaceIds = function listWorkspaceIds() {\n      return this.db.allDocs({ include_docs: true }).then(function (result) {\n        return result.rows\n          .filter(function (row) {\n            return row.doc && row.doc.type === 'workspace';\n          })\n          .map(function (row) {\n            return row.id;\n          });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.createWorkspace = function createWorkspace(title) {\n      var id = vwise.UUID.uuid4();\n      var workspace = new vwise.Workspace(id, this);\n\n      if (title) {\n        workspace.title = title;\n      }\n\n      return this.saveWorkspace(workspace);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.saveWorkspace = function saveWorkspace(workspace) {\n      if (!(workspace instanceof vwise.Workspace)) {\n        throw new TypeError('expected instance of Workspace');\n      }\n\n      var dto = {\n        _id: workspace._id || workspace.id,\n        _rev: workspace._rev,\n        type: 'workspace',\n        workspace: this.marshallWorkspace(workspace)\n      };\n\n      // prefer saved pouchdb options, but fall back to vwise api options\n      return this.db.put(dto)\n        .then(function (response) {\n          if (!response.ok) {\n            throw new Error('unable to save workspace');\n          }\n\n          // save pouchdb options for later usage\n          workspace._id = response.id;\n          workspace._rev = response.rev;\n\n          return workspace;\n        });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.getWorkspace = function getWorkspace(id) {\n      if (!id) {\n        return this.$q.reject(new Error('no id provided'));\n      }\n\n      var repo = this;\n      return this.workspaces.fetch(id, function () {\n        return repo.db.get(id).then(function (dto) {\n          return repo.unmarshallWorkspace(dto.workspace).then(function (workspace) {\n            workspace._id = dto._id;\n            workspace._rev = dto._rev;\n            return workspace;\n          });\n        });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.removeWorkspace = function removeWorkspace(workspace) {\n      return this.db.remove(workspace);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.createPanel = function createPanel(mediator, workspace, content, vprops) {\n      var id = vwise.UUID.uuid4();\n      var repo = this;\n      var panel = new vwise.Panel(id, mediator, workspace, content, vprops, function (p) {\n        repo.savePanel(p);\n      });\n\n      return this.savePanel(panel);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.savePanel = function savePanel(panel) {\n      if (!(panel instanceof vwise.Panel)) {\n        throw new TypeError('expected instance of Panel');\n      }\n\n      var dto = {\n        _id: panel._id || panel.id,\n        _rev: panel._rev,\n        type: 'panel',\n        panel: this.marshallPanel(panel)\n      };\n\n      return this.db.put(dto)\n        .then(function (response) {\n          if (!response.ok) {\n            throw new Error('unable to save panel');\n          }\n\n          // save pouchdb options for later usage\n          panel._id = response.id;\n          panel._rev = response.rev;\n\n          return panel;\n        });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.getPanel = function getPanel(panelId, workspace) {\n      if (!panelId) {\n        return this.$q.reject(new Error('no id provided'));\n      }\n\n      var repo = this;\n      return this.panels.fetch(panelId, function () {\n        return repo.db.get(panelId).then(function (dto) {\n          return repo.unmarshallPanel(dto.panel, workspace).then(function (panel) {\n            panel._id = dto._id;\n            panel._rev = dto._rev;\n            return panel;\n          });\n        });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.removePanel = function removePanel(panel, workspace) {\n      if (workspace) {\n        workspace.removePanel(panel);\n      }\n\n      return this.db.remove(panel);\n    };\n\n    return NgWorkspaceRepository;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('vwiseWorkspace', vwiseWorkspace);\n\n  /** @ngInject */\n  function vwiseWorkspace() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/workspace/workspace.html',\n      scope: {\n        workspace: '='\n      },\n      controller: WorkspaceController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n  }\n\n  /** @ngInject */\n  function WorkspaceController($scope, panelContentMediatorRegistry) {\n    var vm = this;\n\n    vm.thingDropped = thingDropped;\n    vm.workspaceClicked = workspaceClicked;\n\n    /**\n     * Drop callback for when something is droppen on the workspace content ariea\n     * @param  {Event}  evt DOM Event\n     * @param  {Object} ui  jQuery UI draggable callback data\n     */\n    function thingDropped(evt, ui) {\n      // get scope of object that was dropped\n      var itemScope = ui.draggable.scope();\n\n      // here's the data object of the panel we want to create\n      // HACK: need a better way to pass a vwise droppable item in...\n      var item = itemScope.item;\n\n      // if no item is available (e.g. if a panel was dropped)\n      if (!item) {\n        return;\n      }\n\n      var offset = angular.element(evt.target).offset();\n\n      // set initial panel attributes\n      var context = {\n        xPosition: ui.position.left - offset.left,\n        yPosition: ui.position.top - offset.top,\n        width: 600,\n        height: 400,\n        background: '#ffffff'\n      };\n\n      // who is capable of handling the dropped item\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(item, context);\n      // $log.debug('found ' + contentMediators.length + ' matching content mediator(s).');\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n\n      if (!mediator) {\n        return;\n      }\n\n      var contentP = mediator.initPanelData(item, context);\n      contentP.then(function (content) {\n        return $scope.workspace.createPanel(mediator, content, context);\n      });\n    }\n\n    /**\n     * Creates a new note panel at the desired position\n     * @param {integer} x\n     * @param {integer} y\n     */\n    function createNotePanel(x, y) {\n      var note = {\n        note: ''\n      };\n\n      var context = {\n        xPosition: x,\n        yPosition: y\n      };\n\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(note, context);\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n      $scope.workspace.createPanel(mediator, note, context);\n    }\n\n    function workspaceClicked(evt) {\n      if (evt.ctrlKey) {\n        var offset = angular.element(evt.target).offset();\n        createNotePanel(evt.clientX - offset.left, evt.clientY - offset.top);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('workPanel', workPanelDirective);\n\n  /** @ngInject */\n  function workPanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      require: '^^vwisePanel',\n      templateUrl: 'app/vwise/components/work-panel/work-panel.html',\n      scope: {\n        work: '=',\n        relationships: '=',\n        vprops: '='\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attrs, panel) {\n      panel.addActionButton(createExpandCollapseButton());\n\n      scope.title = worksRepo.getTitle(scope.work.titles);\n\n      scope.work.editions.forEach(function (edition) {\n        edition.type = 'edition';\n        edition.workId = scope.work.id;\n      });\n\n      /**\n       * @return {object}\n       */\n      function createExpandCollapseButton() {\n        var origSize = {\n          width: scope.vprops.width,\n          height: scope.vprops.height\n        };\n\n        var panelLabel = el.find('.panel-label');\n\n        var button = {\n          label: 'collapse',\n          icon: 'expand_less',\n          handler: toggleCollapse\n        };\n\n        return button;\n\n        function toggleCollapse() {\n          if (button.icon === 'expand_less') {\n            origSize.width = scope.vprops.width;\n            origSize.height = scope.vprops.height;\n            scope.vprops.width = panelLabel.outerWidth() + 1;\n            scope.vprops.height = panelLabel.outerHeight();\n            button.label = 'expand';\n            button.icon = 'expand_more';\n          } else {\n            scope.vprops.width = origSize.width;\n            scope.vprops.height = origSize.height;\n            button.label = 'collapse';\n            button.icon = 'expand_less';\n          }\n        }\n      }\n    }\n\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('volumePanel', volumePanelDirective);\n\n  /** @ngInject */\n  function volumePanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/work-panel/volume-panel.html',\n      scope: {\n        volume: '=',\n        workId: '@',\n        editionId: '@'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      scope.title = worksRepo.getTitle(scope.volume.titles);\n\n      scope.edition = worksRepo.getEdition(scope.workId, scope.editionId);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('editionPanel', editionPanelDirective);\n\n  /** @ngInject */\n  function editionPanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/work-panel/edition-panel.html',\n      scope: {\n        edition: '=',\n        workId: '@'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      scope.title = worksRepo.getTitle(scope.edition.titles);\n\n      scope.edition.volumes.forEach(function (volume) {\n        volume.type = 'volume';\n        volume.workId = scope.workId;\n        volume.editionId = scope.edition.id;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('personPanel', personPanelDirective);\n\n  var NAME_KEYS = ['title', 'givenName', 'middleName', 'familyName', 'suffix'];\n\n  /** @ngInject */\n  function personPanelDirective(_) {\n    var directive = {\n      restrict: 'E',\n      require: '^^vwisePanel',\n      templateUrl: 'app/vwise/components/person-panel/person-panel.html',\n      scope: {\n        person: '=',\n        vprops: '='\n      },\n      link: linkFunc,\n      controller: PersonPanelController,\n      controllerAs: 'panel'\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attr, panel) {\n      panel.addActionButton(createExpandCollapseButton());\n\n      var name = scope.person.name;\n\n      scope.name = name.label || _.at(name, NAME_KEYS)\n        .map(function (n) { return n.trim(); })\n        .filter(_.identity)\n        .join(' ');\n\n      /**\n       * @return {object}\n       */\n      function createExpandCollapseButton() {\n        var origSize = {\n          width: scope.vprops.width,\n          height: scope.vprops.height\n        };\n\n        var panelLabel = el.find('.panel-label');\n\n        var button = {\n          label: 'collapse',\n          icon: 'expand_less',\n          handler: toggleCollapse\n        };\n\n        return button;\n\n        function toggleCollapse() {\n          if (button.icon === 'expand_less') {\n            origSize.width = scope.vprops.width;\n            origSize.height = scope.vprops.height;\n            scope.vprops.width = panelLabel.outerWidth() + 10;\n            scope.vprops.height = panelLabel.outerHeight();\n            button.label = 'expand';\n            button.icon = 'expand_more';\n          } else {\n            scope.vprops.width = origSize.width;\n            scope.vprops.height = origSize.height;\n            button.label = 'collapse';\n            button.icon = 'expand_less';\n          }\n        }\n      }\n    }\n\n    /** @ngInject */\n    function PersonPanelController($scope, $q, worksRepo, peopleRepo, relationshipsRepo) {\n      var vm = this;\n\n      vm.works = [];\n\n      activate();\n\n      function activate() {\n        var id = $scope.person.id;\n\n        var worksP = getWorksAuthored(id);\n        worksP.then(function (works) {\n          vm.works = works;\n        });\n\n        var relatedP = worksP.then(function (works) {\n          return getRelatedPeople(works);\n        });\n\n        relatedP.then(function (related) {\n          vm.relatedPeople = related;\n        });\n      }\n\n      function getWorksAuthored(authorId) {\n        var result = worksRepo.searchByAuthor(authorId);\n        return result.$promise.then(function () {\n          result.items.forEach(function (work) {\n            work.type = 'work';\n          });\n\n          return result.items;\n        });\n      }\n\n      function getRelatedPeople(works) {\n        // fetch relationships for all works\n        /** @type Promise.<TypeGroup[]>[] */\n        var relnsPs = works.map(function (work) {\n          return getRelationships(work.id);\n        });\n\n        // combine grouped relationships for all works into a single set of grouped relationships\n        /** @type Promise.<TypeGroup[]> */\n        var relnsP = $q.all(relnsPs).then(function (relnss) {\n          return _.chain(relnss)    // Stream.<TypeGroup[]>\n            .flatten()              // Stream.<TypeGroup>\n            .groupBy(function (group) {\n              return group.type.identifier + '-' + (group.reverse ? 'rev' : 'fwd');\n            })                      // Stream.<String, TypeGroup[]>\n            .map(function (groups) {\n              var group = _.clone(groups[0]);\n              group.relationships = _.flatMap(groups, 'relationships');\n              return group;\n            })                      // Stream.<TypeGroup>\n            .value();\n        });\n\n        // resolve related entities in all relationships to a set of authors\n        var relatedPeople = relnsP.then(function (groups) {\n          /** @type Promise.<TypeGroup>[] */\n          var groupPs = groups.map(function (group) {\n            /** @type Promise.<string[]>[] */\n            var authorIdsPs = _.chain(group.relationships)  // Stream.<NormalizedRelationship>\n            .flatMap('entities')                            // Stream.<Entity>\n            .map('entity')                                  // Stream.<Work|Edition|Volume>\n            .map(function (entity) {\n              return entity.$promise.then(function (entity) {\n                var authorIds = _.map(entity.authors, 'authorId');\n                return authorIds;\n              });\n            })                                              // Stream.<Promise.<string[]>>\n            .value();\n\n            /** @type Promise.<string[]> */\n            var authorIdsP = $q.all(authorIdsPs).then(function (authorIdss) {\n              return _.chain(authorIdss)\n                .flatten()\n                .filter()\n                .uniq()\n                .value();\n            });\n\n            /** @type Promise.<Person[]> */\n            group.relationships = authorIdsP.then(function (authorIds) {\n              /** @type Promise.<Person>[] */\n              var authorPs = authorIds.map(function (id) {\n                var author = peopleRepo.get(id);\n                author.$promise.then(function () {\n                  author.type = 'person';\n                });\n                return author.$promise;\n              });\n\n              return $q.all(authorPs);\n            });\n\n            return $q.all(group);\n          });\n\n          return $q.all(groupPs);\n        });\n\n        return relatedPeople;\n      }\n\n      /**\n       * Fetches relationships for the given work.\n       * @param  {string} workId\n       * @return {Promise.<TypeGroup[]>}\n       */\n      function getRelationships(workId) {\n        var uri = 'works/' + workId;\n        var result = relationshipsRepo.search(uri);\n\n        var normRelnsP = result.$promise.then(function (relns) {\n          var normRelns = relationshipsRepo.normalizeRelationships(relns, uri, worksRepo);\n          return normRelns.$promise;\n        });\n\n        return normRelnsP;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('worksContentMediator', worksContentMediatorFactory);\n\n  /** @ngInject */\n  function worksContentMediatorFactory($q, vwise, worksRepo, relationshipsRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'works', 'Works Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'work' && obj.id;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return $q.all({\n        id: obj.id,\n        work: loadWork(obj.id),\n        relationships: loadRelationships(obj.id)\n      });\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return $q.all({\n        id: dto.id,\n        work: loadWork(dto.id),\n        relationships: loadRelationships(dto.id)\n      });\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'work',\n        id: panelData.id\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<work-panel work=\"content.work\" relationships=\"content.relationships\" vprops=\"vprops\" flex layout=\"column\"></work-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadWork(id) {\n      var work = worksRepo.get(id);\n      return work.$promise;\n    }\n\n    function loadRelationships(workId) {\n      var currentUri = 'works/' + workId;\n      var results = relationshipsRepo.search(currentUri);\n      return results.$promise.then(function () {\n        var relationships = relationshipsRepo.normalizeRelationships(results, currentUri, worksRepo);\n        return relationships.$promise.then(function () {\n\n          relationships.forEach(function (group) {\n            group.relationships.forEach(function (reln) {\n              reln.entities.forEach(function (entity) {\n\n                entity.entity.$promise.then(function () {\n                  entity.title = worksRepo.getTitle(entity.entity.titles);\n                });\n\n                switch(entity.type) {\n                  case 'work':\n                    entity.id = entity.refParams.workId;\n                    break;\n                  case 'edition':\n                    entity.workId = entity.refParams.workId;\n                    entity.id = entity.refParams.editionId;\n                    break;\n                  case 'volume':\n                    entity.workId = entity.refParams.workId;\n                    entity.editionId = entity.refParams.editionId;\n                    entity.id = entity.refParams.volumeId;\n                    break;\n                }\n              });\n            });\n          });\n\n          return relationships;\n        });\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('volumesContentMediator', volumesContentMediatorFactory);\n\n  /** @ngInject */\n  function volumesContentMediatorFactory(vwise, worksRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'volumes', 'Volumes Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'volume' && obj.id && obj.workId && obj.editionId;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadVolume(obj.workId, obj.editionId, obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadVolume(dto.workId, dto.editionId, dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'volume',\n        id: panelData.id,\n        workId: panelData.workId,\n        editionId: panelData.editionId\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<volume-panel volume=\"content\" edition-id=\"{{content.editionId}}\" work-id=\"{{content.workId}}\" flex layout=\"column\"></volume-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadVolume(workId, editionId, volumeId) {\n      var volume = worksRepo.getVolume(workId, editionId, volumeId);\n      return volume.$promise.then(function () {\n        volume.workId = workId;\n        volume.editionId = editionId;\n        return volume;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('peopleContentMediator', peopleContentMediatorFactory);\n\n  /** @ngInject */\n  function peopleContentMediatorFactory(vwise, peopleRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'people', 'People Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'person' && obj.id;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadPerson(obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadPerson(dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'person',\n        id: panelData.id\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<person-panel person=\"content\" vprops=\"vprops\" flex layout=\"column\"></person-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadPerson(id) {\n      var person = peopleRepo.get(id);\n      return person.$promise;\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('passthruContentMediator', passthruContentMediatorFactory);\n\n  /** @ngInject */\n  function passthruContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'passthru', 'Pass-Through Debug Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches() {\n      return true;\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('panelContentMediatorRegistry', panelContentMediatorRegistryFactory);\n\n  /** @ngInject */\n  function panelContentMediatorRegistryFactory(vwise) {\n    return new vwise.PanelContentMediatorRegistry();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('noteContentMediator', noteContentMediatorFactory);\n\n  /** @ngInject */\n  function noteContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'notes', 'Note Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.hasOwnProperty('note');\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<div ng-model=\"content.note\" contenteditable flex></div>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('editionsContentMediator', editionsContentMediatorFactory);\n\n  /** @ngInject */\n  function editionsContentMediatorFactory(vwise, worksRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'editions', 'Editions Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'edition' && obj.id && obj.workId;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadEdition(obj.workId, obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadEdition(dto.workId, dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'edition',\n        id: panelData.id,\n        workId: panelData.workId\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<edition-panel edition=\"content\" work-id=\"{{content.workId}}\" flex layout=\"column\"></edition-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadEdition(workId, editionId) {\n      var edition = worksRepo.getEdition(workId, editionId);\n      return edition.$promise.then(function () {\n        edition.workId = workId;\n        return edition;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('internetArchiveContentMediator', internetArchiveContentMediatorFactory);\n\n  /** @ngInject */\n  function internetArchiveContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'ia-reader', 'Internet Archive Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'internetarchive';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<ia-reader properties=\"content.properties\" flex></ia-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('hathitrustContentMediator', hathitrustContentMediatorFactory);\n\n  /** @ngInject */\n  function hathitrustContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'ht-reader', 'HathiTrust Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'hathitrust';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<hathitrust-reader properties=\"content.properties\" flex></hathitrust-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('googleBooksContentMediator', googleBooksContentMediatorFactory);\n\n  /** @ngInject */\n  function googleBooksContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'gb-reader', 'Google Books Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'googlebooks';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<google-book-reader properties=\"content.properties\" flex></google-book-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('vwisePanel', vwisePanel);\n\n  /** @ngInject */\n  function vwisePanel($compile) {\n    var directive = {\n      restrict: 'E',\n      require: ['^^vwiseWorkspace', 'vwisePanel'],\n      templateUrl: 'app/vwise/components/panel/panel.html',\n      replace: true,\n      scope: {\n        panel: '='\n      },\n      link: linkFunc,\n      controller: PanelController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    function linkFunc($scope, $el, attr, controllers) {\n      // var workspaceController = controllers[0];\n      var panelController = controllers[1];\n\n      // define overridable content areas on controller\n      panelController.getInfoArea = function () {\n        return $el.find('.panel-area-left');\n      };\n\n      panelController.getStatusArea = function () {\n        return $el.find('.panel-area-bottom')\n      };\n\n      var panel = panelController.panel\n\n      // shorthand for use in template\n      $scope.vp = panel.vprops;\n\n      var panelScope = $scope.$new(true);\n      panelScope.content = panel.content;\n      panelScope.vprops = panel.vprops;\n\n      panelScope.$watch('vprops.background', function (color) {\n        var rgb = hextorgb(color);\n        panel.vprops.foreground = calculateForeground(rgb);\n      });\n\n      // NOTE: vprop updates are saved automatically when panel API is called.\n      //       content updates need to be saved manually since they are modified in-place.\n      panelScope.$watch('content', function () {\n        panel.save();\n      }, true);\n\n      var template = panel.contentMediator.getTemplate();\n\n      var contentArea = $el.find('.content');\n      contentArea.html(template);\n      $compile(contentArea.contents())(panelScope);\n    }\n  }\n\n  /** @ngInject */\n  function PanelController($scope) {\n    var vm = this;\n\n    vm.resizing = false;\n    vm.actionButtons = [];\n    vm.propertyButtons = [];\n    vm.panel = $scope.panel;\n\n    vm.addActionButton = addActionButton;\n    vm.addPropertyButton = addPropertyButton;\n    vm.closePanel = closePanel;\n    vm.startResize = startResize;\n    vm.resizePanel = resizePanel;\n    vm.stopResize = stopResize;\n    vm.movePanel = movePanel;\n    vm.stopMove = stopMove;\n    vm.activatePanel = activatePanel;\n\n    function addActionButton(spec) {\n      vm.actionButtons.push(spec);\n\n      return function () {\n        var ix = vm.actionButtons.indexOf(spec);\n        if (ix >= 0) {\n          vm.actionButtons.splice(ix, 1);\n        }\n      };\n    }\n\n    function addPropertyButton(spec) {\n      vm.propertyButtons.push(spec);\n\n      return function () {\n        var ix = vm.propertyButtons.indexOf(spec);\n        if (ix >= 0) {\n          vm.propertyButtons.splice(ix, 1);\n        }\n      };\n    }\n\n    function closePanel() {\n      vm.panel.remove();\n    }\n\n    function movePanel(evt, ui) {\n      vm.panel.vprops.xPosition = ui.position.left;\n      vm.panel.vprops.yPosition = Math.max(0, ui.position.top);\n    }\n\n    function stopMove(evt, ui) {\n      // TODO: jQuery UI supports 'containment' option...\n      var top = Math.max(0, ui.position.top);\n\n      vm.panel.setPosition(ui.position.left, top);\n      activatePanel();\n    }\n\n    function startResize() {\n      vm.resizing = true;\n    }\n\n    function resizePanel(evt, ui) {\n      var width = ui.position.left;\n      var height = ui.position.top;\n\n      $scope.$apply(function () {\n        vm.panel.vprops.width = Math.max(0, width);\n        vm.panel.vprops.height = Math.max(0, height);\n      });\n    }\n\n    function stopResize(evt, ui) {\n      vm.resizing = false;\n\n      var width = ui.position.left;\n      var height = ui.position.top;\n\n      $scope.$apply(function () {\n        vm.panel.setSize(Math.max(0, width), Math.max(0, height));\n      });\n    }\n\n    function activatePanel(evt) {\n      vm.panel.activate();\n\n      if (evt && evt.stopPropagation) {\n        evt.stopPropagation();\n      }\n    }\n  }\n\n  /**\n   * Convert a CSS hex color string to rgb percentage values\n   * @param  {string} hex\n   * @return {Object.<string, float>}\n   */\n  function hextorgb(hex) {\n    var match = hex.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);\n\n    if (!match) {\n      return;\n    }\n\n    return {\n      r: parseInt(match[1], 16) / 255,\n      g: parseInt(match[2], 16) / 255,\n      b: parseInt(match[3], 16) / 255\n    };\n  }\n\n  /**\n   * Calculate a good contrasting foreground color (black/white) given an rgb background color\n   * @param {Object.<string, float>} r, g, and b color percentage points\n   * @return {string} rgba foreground color spec\n   */\n  function calculateForeground(rgb) {\n    // Foreground calculation from http://stackoverflow.com/a/3943023\n\n    // calculate luminance coefficient\n    // see https://en.wikipedia.org/wiki/Luma_(video)#Rec._601_luma_versus_Rec._709_luma_coefficients\n    var r = (rgb.r <= 0.03928) ? rgb.r / 12.92 : Math.pow((rgb.r + 0.055) / 1.055, 2.4);\n    var g = (rgb.g <= 0.03928) ? rgb.g / 12.92 : Math.pow((rgb.g + 0.055) / 1.055, 2.4);\n    var b = (rgb.b <= 0.03928) ? rgb.b / 12.92 : Math.pow((rgb.b + 0.055) / 1.055, 2.4);\n\n    var lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;\n\n    // set contrast color based on W3C recommendations\n    // see https://www.w3.org/TR/WCAG20/\n\n    // panel.vprops.foreground = (lum > 0.179) ? '#000000' : '#ffffff';\n    // adjusted so that #808080 is the transition point between FG colors\n    return (lum > 0.215) ? 'rgba(0,0,0,0.87)' : 'rgba(255,255,255,0.87)';\n  }\n\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('vwise')\n      .directive('iaReader', iaReader);\n\n   /** @ngInject */\n   function iaReader($sce) {\n      var directive = {\n         restrict: 'E',\n         template: '<iframe ng-src=\"{{src}}\">',\n         replace: true,\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope) {\n        scope.$watch('properties', function(properties) {\n           // TODO add page link\n            //  <iframe class=\"reader flex\" src=\"https://archive.org/stream/essayinanswertom00adamiala?ui=embed#page/n5/mode/2up\" frameborder=\"0\"></iframe>\n           scope.src = $sce.trustAsResourceUrl('https://archive.org/stream/' + properties.id + '?ui=embed#mode/2up');\n        });\n      }\n   }\n\n})();\n\n(function () {\n   'use strict';\n\n   var READER_URL = 'https://babel.hathitrust.org/cgi/pt';\n\n   angular\n      .module('vwise')\n      .directive('hathitrustReader', hathitrustReader);\n\n   /** @ngInject */\n   function hathitrustReader($sce, _) {\n      var directive = {\n         restrict: 'E',\n         template: '<iframe ng-src=\"{{src}}\">',\n         replace: true,\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope) {\n         scope.$watch('properties', function (properties) {\n            var params = {\n               id: properties.htid,\n               ui: 'embed'\n            };\n\n            if (properties.seq) {\n               params.seq = properties.seq;\n            }\n\n            var queryString = _.map(params, function (value, key) {\n               return key + '=' + value;\n            }).join(';');\n\n            var url = READER_URL + '?' + queryString;\n\n            scope.src = $sce.trustAsResourceUrl(url);\n         });\n      }\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('contenteditable', contenteditable);\n\n  /** @ngInject */\n  function contenteditable($sce) {\n    var directive = {\n      restrict: 'A',\n      require: '?ngModel',\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc($scope, $el, attrs, ngModel) {\n      if (!ngModel) {\n        return;\n      }\n\n      ngModel.$render = function () {\n        $el.html($sce.getTrustedHtml(ngModel.$viewValue || ''));\n      };\n\n      $el.on('blur keyup change', function () {\n        $scope.$apply(function () {\n          ngModel.$setViewValue($el.html());\n        });\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .controller('WorkspaceController', WorkspaceController);\n\n  /** @ngInject */\n  function WorkspaceController(panelContentMediatorRegistry, workspaceRepository, $stateParams, $log, $scope, $timeout, $mdSidenav, $mdToast, hotkeys, _, $q, peopleRepo, worksRepo) {\n    var vm = this;\n\n    vm.workspace = null;\n\n    vm.activeItems = [];\n    vm.searchQuery = '';\n    vm.sidebarFocused = true;\n\n    vm.search = _.debounce(search, 300);\n\n    activate();\n\n    function activate() {\n      // lookup workspace by id || get first workspace || create new workspace\n      var workspaceIdP = $stateParams.workspaceId\n        ? $q.when($stateParams.workspaceId)\n        : workspaceRepository.listWorkspaceIds().then(function (ids) {\n          return ids.length > 0 ? ids[0] : null;\n        });\n\n      var workspaceP = workspaceIdP\n        .then(function (id) {\n          return workspaceRepository.getWorkspace(id);\n        })\n        .catch(function () {\n          return workspaceRepository.createWorkspace();\n        });\n\n      workspaceP.then(function (workspace) {\n        vm.workspace = workspace;\n      });\n\n      hotkeys.bindTo($scope)\n        .add({\n          combo: 'ctrl+\\\\',\n          description: 'Toggle Sidebar',\n          callback: function () {\n            vm.sidebarFocused = !vm.sidebarFocused;\n          }\n        })\n        .add({\n          combo: '/',\n          description: 'Search',\n          callback: function () {\n            vm.searchQuery = '';\n            if (vm.sidebarFocused) {\n              $timeout(function () {\n                // prevent key event from typing in field\n                angular.element('#searchQuery').focus();\n              });\n            } else {\n              $mdSidenav('left').toggle();\n            }\n          }\n        })\n        .add({\n          combo: 'n',\n          description: 'Create a new note panel',\n          callback: function () {\n            createNotePanel(100, 100);\n          }\n        });\n    }\n\n    function search(query) {\n      vm.loading = true;\n\n      // TODO delegate to registered external search/content providers\n\n      vm.peopleResults = peopleRepo.search(query);\n      vm.worksResults = worksRepo.search(query);\n\n      function tagAll(key, value) {\n        return function (arr) {\n          arr.forEach(function (obj) {\n            obj[key] = value;\n          });\n          return arr;\n        };\n      }\n\n      $q.all([\n        vm.peopleResults.$promise.then(_.property('items')).then(tagAll('type', 'person')),\n        vm.worksResults.$promise.then(_.property('items')).then(tagAll('type', 'work'))\n      ])\n        .then(function () {\n          vm.loading = false;\n        }, function () {\n          $mdToast.showSimple('Unable to load search results');\n        });\n    }\n\n    /**\n     * Creates a new note panel at the desired position\n     * @param {integer} x\n     * @param {integer} y\n     */\n    function createNotePanel(x, y) {\n      var note = {\n        note: ''\n      };\n\n      var context = {\n        xPosition: x,\n        yPosition: y\n      };\n\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(note, context);\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n      vm.workspace.createPanel(mediator, note, context);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .run(runBlock);\n\n  /** @ngInject */\n  function runBlock(panelContentMediatorRegistry, peopleContentMediator, worksContentMediator, editionsContentMediator, volumesContentMediator, googleBooksContentMediator, hathitrustContentMediator, internetArchiveContentMediator, noteContentMediator, passthruContentMediator) {\n    panelContentMediatorRegistry.register(peopleContentMediator);\n    panelContentMediatorRegistry.register(worksContentMediator);\n    panelContentMediatorRegistry.register(editionsContentMediator);\n    panelContentMediatorRegistry.register(volumesContentMediator);\n    panelContentMediatorRegistry.register(googleBooksContentMediator);\n    panelContentMediatorRegistry.register(hathitrustContentMediator);\n    panelContentMediatorRegistry.register(internetArchiveContentMediator);\n    panelContentMediatorRegistry.register(noteContentMediator);\n    panelContentMediatorRegistry.register(passthruContentMediator);\n  }\n\n})();\n\n/*global vwise:false*/\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .constant('vwise', vwise);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .config(config);\n\n  /** @ngInject */\n  function config(googleBooksApiProvider) {\n    googleBooksApiProvider.configure({ preventLoad: true });\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcWorks', [\n      'ngResource'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcWorks')\n    .provider('worksRepo', worksRepoProvider);\n\n  /**\n   * This functionality is already being implemented as a standalone trc-biblio module. The code is\n   * used here as an interim until the Bower build/dependency workflow has been finalized.\n   *\n   * @return {angular.provider}\n   */\n  function worksRepoProvider() {\n    var provider = {};\n    provider.url = '/api/works';\n    provider.$get = worksRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function worksRepoFactory($resource, _) {\n      var restResource = $resource(provider.url + '/:workId', { workId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var editionResource = $resource(provider.url + '/:workId/editions/:editionId', { editionId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var volumeResource = $resource(provider.url + '/:workId/editions/:editionId/volumes/:volumeId', { volumeId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var repo = {};\n      repo.getAll = findAll;\n      repo.search = search;\n      repo.searchByAuthor = searchByAuthor;\n      repo.get = getWork;\n      repo.getWork = getWork;\n      repo.getEdition = getEdition;\n      repo.getVolume = getVolume;\n      repo.create = createWork;\n      repo.createWork = createWork;\n      repo.createEdition = createEdition;\n      repo.createVolume = createVolume;\n      repo.save = save;\n      repo.saveWork = saveWork;\n      repo.saveEdition = saveEdition;\n      repo.saveVolume = saveVolume;\n      repo.delete = deleteWork;\n      repo.getTitle = getTitleByTypePreference;\n      return repo;\n\n      /**\n       * Retrieves a listing of all works\n       *\n       * @return {WorkProxy[]}\n       */\n      function findAll() {\n        return search('');\n      }\n\n      /**\n       * Search for works by query\n       *\n       * @return {SearchResultSet}\n       */\n      function search(query) {\n        return restResource.get({ q: query, max: 50 });\n      }\n\n      /**\n       * Search for works by author\n       *\n       * @return {SearchResultSet}\n       */\n      function searchByAuthor(authorId) {\n        return restResource.get({ aid: authorId, max: 50 });\n      }\n\n      /**\n       * Retrieves a work object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Work.$promise.\n       *\n       * @param {string} workId\n       * @return {Work}\n       */\n      function getWork(workId) {\n        if (angular.isUndefined(workId)) {\n          throw new TypeError('Invalid ID provided to getWork');\n        }\n\n        var work = restResource.get({ workId: workId });\n\n        work.$promise.then(adaptWork);\n\n        return work;\n      }\n\n      /**\n       * Retrieves an edition object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Edition.$promise.\n       *\n       * @param {string} workId\n       * @param {string} editionId\n       * @return {Edition}\n       */\n      function getEdition(workId, editionId) {\n        if (angular.isUndefined(workId) || angular.isUndefined(editionId)) {\n          throw new TypeError('Invalid IDs provided to getEdition');\n        }\n\n        var edition = editionResource.get({ workId: workId, editionId: editionId });\n\n        edition.$promise.then(adaptEdition);\n\n        return edition;\n      }\n\n      /**\n       * Retrieves a volume object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Volume.$promise.\n       *\n       * @param {string} workId\n       * @param {string} editionId\n       * @param {string} volumeId\n       * @return {Volume}\n       */\n      function getVolume(workId, editionId, volumeId) {\n        if (angular.isUndefined(workId) || angular.isUndefined(editionId) || angular.isUndefined(volumeId)) {\n          throw new TypeError('Invalid IDs provided to getVolume');\n        }\n\n        var volume = volumeResource.get({ workId: workId, editionId: editionId, volumeId: volumeId });\n\n        volume.$promise.then(adaptVolume);\n\n        return volume;\n      }\n\n      /**\n       * Creates a new work instance\n       *\n       * @return {Work}\n       */\n      function createWork() {\n        var work = new restResource();\n        adaptWork(work);\n        work.titles.push({});\n        work.authors.push({});\n        return work;\n      }\n\n      /**\n       * Creates a new edition instance\n       *\n       * @return {Edition}\n       */\n      function createEdition() {\n        var edition = new editionResource();\n        return adaptEdition(edition);\n      }\n\n      /**\n       * Creates a new volume instance\n       *\n       * @return {Volume}\n       */\n      function createVolume() {\n        var volume = new volumeResource();\n        return adaptVolume(volume);\n      }\n\n      /**\n       * Dispatch method for saving works, editions, and volumes\n       *\n       * @deprecated use saveWork, saveEdition, or saveVolume directly\n       * @return {Promise}\n       */\n      function save() {\n        switch (arguments.length) {\n          case 1: return saveWork.apply(null, arguments);\n          case 2: return saveEdition.apply(null, arguments);\n          case 3: return saveVolume.apply(null, arguments);\n        }\n        throw new TypeError('Unexpected arguments to worksRepo#save');\n      }\n\n      /**\n       * Saves a work instance back to the server\n       *\n       * @param {Work} work\n       * @return {Promise.<Work>}\n       */\n      function saveWork(work) {\n        if (!(work instanceof restResource)) {\n          throw new Error('work was not created by this repo');\n        }\n\n        // ngResource automatically updates the model to reflect any server changes (e.g. setting IDs for the work/edtions/volumes/copies).\n        return work.id\n          ? work.$update()\n          : work.$save();\n      }\n\n      /**\n       * Saves an edition instance back to the server\n       *\n       * @param  {string} workId\n       * @param  {Edition} edition\n       * @return {Promise.<Edition>}\n       */\n      function saveEdition(workId, edition) {\n        if (!workId) {\n          throw new Error('no work id provided');\n        }\n\n        if (!(edition instanceof editionResource)) {\n          throw new Error('edition was not created by this repo');\n        }\n\n        return edition.id\n          ? edition.$update({ workId: workId })\n          : edition.$save({ workId: workId });\n      }\n\n      /**\n       * Saves a volume instance back to the server\n       *\n       * @param  {string} workId\n       * @param  {string} editionId\n       * @param  {Volume} volume\n       * @return {Promise.<Volume>}\n       */\n      function saveVolume(workId, editionId, volume) {\n        if (!workId) {\n          throw new Error('no work id provided');\n        }\n\n        if (!editionId) {\n          throw new Error('no edition id provided');\n        }\n\n        if (!(volume instanceof volumeResource)) {\n          throw new Error('volume was not created by this repo');\n        }\n\n        return volume.id\n          ? volume.$update({ workId: workId, editionId: editionId })\n          : volume.$save({ workId: workId, editionId: editionId });\n      }\n\n      /**\n       * Deletes a work instance from the server\n       *\n       * @param  {string} id\n       */\n      function deleteWork(workId) {\n        var dataItem = restResource.delete({ id: workId });\n        return dataItem.$promise;\n      }\n\n      /**\n       * Ensure that aggregate fields common to all work/edition/volume entities exist and are formatted correctly\n       *\n       * @param  {Work|Edition|Volume} entity\n       * @return {Work|Edition|Volume}\n       */\n      function adaptCommon(entity) {\n        if (!entity.titles) {\n          entity.titles = [];\n        } else {\n          entity.titles.forEach(function (title) {\n            title.type = title.type.toLowerCase();\n          });\n        }\n\n        if (!entity.authors) {\n          entity.authors = [];\n        } else {\n          entity.authors.forEach(function (author) {\n            author.role = author.role.toLowerCase();\n          });\n        }\n\n        if (!entity.otherAuthors) {\n          entity.otherAuthors = [];\n        } else {\n          entity.otherAuthors.forEach(function (author) {\n            author.role = author.role.toLowerCase();\n          });\n        }\n\n        if (!entity.copies) {\n          entity.copies = [];\n        }\n\n        return entity;\n      }\n\n      /**\n       * Ensure that work aggregate fields exist and are formatted correctly\n       *\n       * @param  {Work} work\n       * @return {Work}\n       */\n      function adaptWork(work) {\n        adaptCommon(work);\n\n        if (!work.editions) {\n          work.editions = [];\n        } else {\n          work.editions.forEach(adaptEdition);\n        }\n\n        return work;\n      }\n\n      /**\n       * Ensure that edition aggregate fields exist and are formatted correctly\n       *\n       * @param  {Edition} edition\n       * @return {Edition}\n       */\n      function adaptEdition(edition) {\n        adaptCommon(edition);\n\n        if (!edition.volumes) {\n          edition.volumes = [];\n        } else {\n          edition.volumes.forEach(adaptVolume);\n        }\n\n        return edition;\n      }\n\n      /**\n       * Ensure that volume aggregate fields exist and are formatted correctly\n       *\n       * @param  {Volume} volume\n       * @return {Volume}\n       */\n      function adaptVolume(volume) {\n        adaptCommon(volume);\n\n        return volume;\n      }\n\n      /**\n       * Retrieves the first available title of the given type or falsey if no title can be found.\n       * If multiple types are given, returns the title corresponding to the first type for which a title is found.\n       *\n       * @param  {Title[]}         titles\n       * @param  {string|string[]} types\n       * @return {Title}\n       */\n      function getTitleByTypePreference(titles, types) {\n        if (angular.isUndefined(types)) {\n          types = ['short', 'canonical', 'bibliographic'];\n        } else if (!angular.isArray(types)) {\n          types = [types];\n        }\n\n        return types.reduce(function (found, type) {\n          return found || _.find(titles, { type: type });\n        }, null);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcReln', [\n      'ngResource'\n    ]);\n\n})();\n\n// NOTE: this entire API model *WILL* eventually change\n\n/**\n * @typedef Relationship\n * @type {object}\n * @property {string}     id                  - A unique identifier for this relationship\n * @property {string}     typeId              - The ID of the RelationshipType of this relationship\n * @property {string}     description         - A detailed description of this relationship\n * @property {string}     descriptionMimeType - MIME type string of the description\n * @property {Provenance} provenance          - Metadata about the relationship record\n * @property {Anchor[]}   relatedEntities     - A set of \"source\" anchors\n * @property {Anchor[]}   targetEntities      - A set of \"target\" anchors\n */\n\n/**\n * @typedef RelationshipType\n * @type {object}\n * @property {string}  identifier   - A unique identifier for this type\n * @property {string}  title        - A label to display for this type\n * @property {string}  reverseTitle - If this type is directed, the label to display for reverse relationships\n * @property {string}  description  - A more detailed description of this type\n * @property {boolean} isDirected   - Whether this type is directed (true) or undirected (false)\n */\n\n/**\n * @typedef Provenance\n * @type {object}\n * @property {string[]} creatorUris  - URIs to people/authors of this relationship\n * @property {string}   dateCreated  - an ISO 8601 date representation of when the record was created\n * @property {string}   dateModified - an ISO 8601 date representation of when the record was last modified\n */\n\n/**\n * @typedef Anchor\n * @type {object}\n * @property {string[]} entryUris[] - URIs to work/edition/volume\n */\n\n/**\n * @typedef TypeGroup\n * @type {object}\n * @property {string}                   label         - Potentially directed display label for group\n * @property {RelationshipType}         type          - The type corresponding to this group\n * @property {boolean}                  reverse       - For directed types, pecifies the directionality of relationships in this group\n * @property {NormalizedRelationship[]} relationships - Relationships of the same type and direction\n */\n\n/**\n * @typedef NormalizedRelationship\n * @type {object}\n * @property {string}                           id          - The id of the original relationship\n * @property {string}                           typeId      - The relationship's type id\n * @property {boolean}                          reverse     - Whether this relationship is in the reverse type direction\n * @property {string}                           description - A description of this relationship\n * @property {Entity[]}                         entities    - A set of target entities referenced by this relationship\n * @property {Promise.<NormalizedRelationship>} $promise    - Resolves to the normalized promise when all asynchronous data has been set\n */\n\n/**\n * @typedef Entity\n * @type {object}\n * @property {string}              label               - A display label for the entity\n * @property {string}              type                - One of 'work', 'edition', or 'volume'\n * @property {object}              refParams           - Reference parameters for resolving the entity\n * @property {string}              refParams.workId    - The entity's work id\n * @property {string}              refParams.editionId - If an edition or volume, the entity's edition id\n * @property {string}              refParams.volumeId  - If a volume, the entity's volume id\n * @property {Work|Edition|Volume} entity              - The entity itself\n * @property {Promise.<Entity>}    $promise            - Resolves to the entity when all asynchronous data has been set\n */\n\n(function () {\n  'use strict';\n\n  var ENTITY_URI = /^works\\/([^\\/]+)(?:\\/editions\\/([^\\/]+)(?:\\/volumes\\/([^\\/]+))?)?$/i;\n\n  angular\n    .module('trcReln')\n    .provider('relationshipsRepo', relationshipsRepoProvider);\n\n  function relationshipsRepoProvider() {\n    var provider = {};\n    provider.url = '/api/relationships';\n    provider.$get = relationshipsRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function relationshipsRepoFactory($q, $resource) {\n      var typeResource = $resource(provider.url + '/types/:id', { id: '@identifier' });\n      var relnResource = $resource(provider.url + '/:id', { id: '@id' }, {\n        update: { method: 'PUT' }\n      });\n\n      var typesCache = null;\n\n      var repo = {};\n      repo.getTypes = getTypes;\n      repo.getType = getType;\n      repo.createRelationship = createRelationship;\n      repo.createProvenance = createProvenance;\n      repo.createAnchor = createAnchor;\n      repo.get = findById;\n      repo.search = search;\n      repo.save = saveRelationship;\n      repo.delete = deleteRelationship;\n      repo.normalizeRelationships = normalizeRelationships;\n      return repo;\n\n      /**\n       * Fetches relationship types from the server, caching them in the process.\n       * The returned array will be populated when the request resolves.\n       * The underlying promise is available on the $promise property.\n       *\n       * @param  {object} options\n       * @param  {boolean} options.force Discard cache (if set) and refetch\n       * @return {object.<string,RelationshipType>}\n       */\n      function getTypes(options) {\n        options = options || {};\n\n        if (!typesCache || options.force) {\n          var types = typeResource.query();\n\n          typesCache = {};\n\n          var tcPromise = types.$promise.then(function () {\n            types.forEach(function (type) {\n              typesCache[type.identifier] = type;\n            });\n            return typesCache;\n          });\n\n          // add $promise as a non-enumerable property\n          Object.defineProperty(typesCache, '$promise', {\n            value: tcPromise\n          });\n        }\n\n        return typesCache;\n      }\n\n      /**\n       * Fetches a type by ID\n       *\n       * @param  {string} id\n       * @return {Promise.<RelationshipType>}\n       */\n      function getType(id) {\n        var types = getTypes();\n\n        return types.$promise.then(function (types) {\n          return types[id];\n        });\n      }\n\n      /**\n       * Creates a new empty relationship instance\n       *\n       * @return {Relationship}\n       */\n      function createRelationship() {\n        var reln = new relnResource();\n        return adaptRelationship(reln);\n      }\n\n      /**\n       * Creates a new empty provenance model\n       *\n       * @return {Provenance}\n       */\n      function createProvenance() {\n        var provenance = {};\n        return adaptProvenance(provenance);\n      }\n\n      /**\n       * Creates a new empty anchor model\n       *\n       * @return {Anchor}\n       */\n      function createAnchor() {\n        var anchor = {};\n        return adaptAnchor(anchor);\n      }\n\n      /**\n       * Retrieves a relationship from the server by ID.\n       * The returned model will be populated once the request succeeds.\n       * The underlying promise can be accessed via the $promise property.\n       *\n       * @param  {string} id\n       * @return {Relationship}\n       */\n      function findById(id) {\n        return relnResource.get({ id: id });\n      }\n\n      /**\n       * Find all relationships matching the given criteria.\n       * @param  {object|string} options\n       * @property {string} options.uri (default if options is a string)\n       * @property {string} options.typeId\n       * @property {string} options.direction \"from\" (out-relationships), \"to\" (in-relationships), or \"any\"\n       * @property {integer} options.start\n       * @property {integer} options.max\n       * @return {Relationship[]}\n       */\n      function search(options) {\n        if (!options) {\n          throw new Error('no options provided')\n        }\n\n        if (angular.isString(options)) {\n          // treat single string as an entity URL\n          options = { uri: options };\n        }\n\n        var queryOpts = {};\n\n        if (options.uri) {\n          queryOpts.entity = options.uri;\n        }\n\n        if (options.typeId) {\n          queryOpts.type = options.typeId;\n        }\n\n        if (options.direction) {\n          queryOpts.direction = options.direction;\n        }\n\n        if (options.start) {\n          queryOpts.off = options.start;\n        }\n\n        if (options.max) {\n          queryOpts.max = options.max;\n        }\n\n        return relnResource.query(queryOpts);\n      }\n\n      /**\n       * Saves a relationship back to the server.\n       *\n       * @param  {Relationship} reln\n       * @return {Promise} resolves on successful save\n       */\n      function saveRelationship(reln) {\n        if (!(reln instanceof relnResource)) {\n          throw new Error('Relationship was not created by this repo');\n        }\n\n        return reln.id\n          ? reln.$update()\n          : reln.$save();\n      }\n\n      /**\n       * Deletes a relationship from the server via the REST API.\n       *\n       * @param  {string} id\n       * @return {Promise} resolves on success\n       */\n      function deleteRelationship(id) {\n        var response = relnResource.delete({ id: id });\n        return response.$promise\n      }\n\n      /**\n       * Ensures aggregate fields on a relationship are set appropriately\n       *\n       * @param  {Relationship} reln\n       * @return {Relationship}\n       */\n      function adaptRelationship(reln) {\n        if (!reln.provenance) {\n          reln.provenance = createProvenance();\n        }\n\n        if (!reln.relatedEntities) {\n          reln.relatedEntities = [];\n        }\n\n        if (!reln.targetEntities) {\n          reln.targetEntities = [];\n        }\n\n        return reln;\n      }\n\n      /**\n       * Ensures aggregate fields on a provenance model are set appropriately\n       *\n       * @param  {Provenance} provenance\n       * @return {Provenance}\n       */\n      function adaptProvenance(provenance) {\n        if (!provenance.creatorUris) {\n          provenance.creatorUris = [];\n        }\n\n        return provenance;\n      }\n\n      /**\n       * Ensures aggregate fields on an anchor model are set appropriately\n       *\n       * @param  {Anchor} anchor\n       * @return {Anchor}\n       */\n      function adaptAnchor(anchor) {\n        if (!anchor.entryUris) {\n          anchor.entryUris = [];\n        }\n\n        return anchor;\n      }\n\n      /**\n       * Normalizes relationships into type groups that are more suitable for display in the UI\n       *\n       * @param  {Relationship[]} relationships\n       * @return {TypeGroup[]}\n       */\n      function normalizeRelationships(relationships, currentUri, worksRepo) {\n        var normRelns = relationships.map(function (relationship) {\n          var isReverse = relationship.targetEntities.some(function (anchor) {\n            return anchor.entryUris.some(function (uri) {\n              return uri === currentUri;\n            });\n          });\n\n          var targetField = isReverse ? 'relatedEntities' : 'targetEntities';\n\n          var entities = flatMap(relationship[targetField], property('entryUris'))\n            .map(function (uri) {\n              return resolveEntityUri(uri, worksRepo);\n            });\n\n          var normReln = {\n            id: relationship.id,\n            typeId: relationship.typeId,\n            reverse: isReverse,\n            description: relationship.description,\n            entities: entities\n          };\n\n          var entityPs = entities.map(property('$promise'));\n\n          Object.defineProperty(normReln, '$promise', {\n            value: $q.all(entityPs).then(constant(normReln))\n          });\n\n          return normReln;\n        });\n\n        var relnsByTypeDir = {};\n\n        normRelns.forEach(function (relationship) {\n          var typeId = relationship.typeId;\n\n          if (!relnsByTypeDir.hasOwnProperty(typeId)) {\n            relnsByTypeDir[typeId] = {\n              fwd: [],\n              rev: []\n            };\n          }\n\n          relnsByTypeDir[typeId][relationship.reverse ? 'rev' : 'fwd'].push(relationship);\n        });\n\n        var typeGroups = [];\n\n        var typeGroupPs = kvMap(relnsByTypeDir, function (dirs, typeId) {\n          return getType(typeId).then(function (type) {\n            if (type.isDirected) {\n              // add forward group\n              if (dirs.fwd.length > 0) {\n                typeGroups.push({\n                  label: type.title,\n                  type: type,\n                  reverse: false,\n                  relationships: dirs.fwd\n                });\n              }\n\n              // add reverse group\n              if (dirs.rev.length > 0) {\n                typeGroups.push({\n                  label: type.reverseTitle,\n                  type: type,\n                  reverse: true,\n                  relationships: dirs.rev\n                });\n              }\n            } else {\n              // combine forward/reverse and add as a single group\n              var group = dirs.fwd.concat(dirs.rev);\n              if (group.length > 0) {\n                typeGroups.push({\n                  label: type.title,\n                  type: type,\n                  relationships: group\n                });\n              }\n            }\n          });\n        });\n\n        Object.defineProperty(typeGroups, '$promise', {\n          value: $q.all(typeGroupPs).then(constant(typeGroups))\n        });\n\n        return typeGroups;\n      }\n    }\n  }\n\n  /**\n   * Resolves an entity URI into a uniform container for the referenced entity.\n   * @param  {string} uri\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function resolveEntityUri(uri, worksRepo) {\n    var match = ENTITY_URI.exec(uri);\n\n    if (!match) {\n      return null;\n    }\n\n    if (match[1] && match[2] && match[3]) {\n      return makeVolumeEntity(match[1], match[2], match[3], worksRepo);\n    } else if (match[1] && match[2]) {\n      return makeEditionEntity(match[1], match[2], worksRepo);\n    } else if (match[1]) {\n      return makeWorkEntity(match[1], worksRepo);\n    }\n\n    return null;\n  }\n\n  /**\n   * Creates an entity for a volume.\n   * @param  {string} workId\n   * @param  {string} editionId\n   * @param  {string} volumeId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeVolumeEntity(workId, editionId, volumeId, worksRepo) {\n    var edition = worksRepo.getEdition(workId, editionId);\n    var volume = worksRepo.getVolume(workId, editionId, volumeId);\n\n    var entity = {\n      type: 'volume',\n      refParams: {\n        workId: workId,\n        editionId: editionId,\n        volumeId: volumeId\n      },\n      entity: volume\n    };\n\n    var labelP = volume.$promise.then(function () {\n      var title = worksRepo.getTitle(volume.titles, ['short', 'canonical', 'bibliographic']);\n      var label = formatTitle(title);\n\n      return edition.$promise.then(function () {\n        return label + '. ' + edition.editionName + '. Volume ' + volume.volumeNumber;\n      }, function () {\n        return label + '. [Unknown edition]. Volume ' + volume.volumeNumber;\n      });\n    });\n\n    var entityP = labelP.then(function (label) {\n      entity.label = label;\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Creates an entity for an edition.\n   * @param  {string} workId\n   * @param  {string} editionId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeEditionEntity(workId, editionId, worksRepo) {\n    var edition = worksRepo.getEdition(workId, editionId);\n\n    var entity = {\n      type: 'edition',\n      refParams: {\n        workId: workId,\n        editionId: editionId\n      },\n      entity: edition\n    };\n\n    var entityP = edition.$promise.then(function () {\n      var title = worksRepo.getTitle(edition.titles, ['short', 'canonical', 'bibliographic']);\n      entity.label = formatTitle(title) + '. ' + edition.editionName;\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Creates an entity for a work.\n   * @param  {string} workId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeWorkEntity(workId, worksRepo) {\n    var work = worksRepo.getWork(workId);\n\n    var entity = {\n      type: 'work',\n      refParams: {\n        workId: workId\n      },\n      entity: work\n    };\n\n    var entityP = work.$promise.then(function () {\n      var title = worksRepo.getTitle(work.titles, ['short', 'canonical', 'bibliographic']);\n      entity.label = formatTitle(title);\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Formats a bibliographic entity's title into a title string\n   * @param  {Title} title\n   * @return {string}\n   */\n  function formatTitle(title) {\n    if (!title) {\n      return '';\n    }\n\n    return title.title + (title.subtitle ? ': ' + title.subtitle : '');\n  }\n\n  // UTILITY FUNCTIONS\n\n  /**\n   * @param {object} o\n   * @return {function}\n   */\n  function constant(o) {\n    return function () {\n      return o;\n    };\n  }\n\n  /**\n   * Maps over an object's key/value pairs\n   * @param {object.<string, object>} obj\n   * @param {function} cb\n   * @return {array}\n   */\n  function kvMap(obj, cb) {\n    return Object.keys(obj)\n      .filter(function (k) {\n        return obj.hasOwnProperty(k);\n      })\n      .map(function (k) {\n        return cb(obj[k], k);\n      });\n  }\n\n  /**\n   * Flattens an array of arrays by one level\n   * @param {array[]} arrs\n   * @return {array}\n   */\n  function flatten(arrs) {\n    return arrs.reduce(function (flattened, arr) {\n      return flattened.concat(arr);\n    }, []);\n  }\n\n  /**\n   * @param {array} arr\n   * @param {function} cb\n   * @return {array}\n   */\n  function flatMap(arr, cb) {\n    return flatten(arr.map(cb));\n  }\n\n  /**\n   * @param {string} prop\n   * @return {function}\n   */\n  function property(prop) {\n    return function (o) {\n      return o[prop];\n    };\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio', [\n      'ngResource'\n    ]);\n\n})();\n\n/**\n * Data model representing a person returned by the TRC REST API\n * @typedef Person\n * @type {object}\n * @property {string}           id       - a unique identifier for this person; assigned upon creation\n * @property {EntryMeta}        meta     - metadata about the record and its history in the system\n * @property {PersonName}       name     - primary name used to identify this person\n * @property {PersonName[]}     altNames - other names by which this person is known\n * @property {?HistoricalEvent} birth    - the date and location this person was born; may be null if unknown\n * @property {?HistoricalEvent} death    - the date and location this person was born; may be null if unknown or still alive\n * @property {string}           summary  - an HTML summary of the person and his or her significance\n */\n\n/**\n * Simplified, lightweight representation of a person for use in search results\n * @typedef Person\n * @type {object}\n * @property {string}     id             - a unique identifier for the person\n * @property {EntryMeta}  meta           - metadata about the record and its history in the system\n * @property {PersonName} name           - structured name representation\n * @property {string}     label          - formatted name to display\n * @property {string}     summaryExcerpt - a leading excerpt from the full summary\n */\n\n/**\n * Metadata about a TRC entry\n * @typedef EntryMeta\n * @type {object}\n * @property {string}                      slug         - a short, unique identifier intended to be more human-readable than the id\n * @property {integer}                     version      - a monotonically increasing version number incremented on each change\n * @property {object.<string, SimpleLink>} links        - links to related resources; keyed by link role\n * @property {string}                      lastModified - ISO 8601 timestamp of the last modification date\n */\n\n/**\n * Container for linking to related entities\n * @typedef SimpleLink\n * @type {object}\n * @property {string} uri  - a URI representing the linked item\n * @property {string} type - MIME type of the related linked item\n */\n\n/**\n * Structured form of a person's name\n * @typedef PersonName\n * @type {object}\n * @property {string} role        - clarifies the use of this name\n * @property {string} label       - a simple representation of this name for display purposes\n * @property {?string} title      - title of address\n * @property {?string} givenName  - given or first name\n * @property {?string} middleName - middle name\n * @property {?string} familyName - family or last name\n * @property {?string} suffix     - a suffix (e.g. 'Jr' or 'III')\n */\n\n/**\n * Event with a date/time, location, and descriptive information\n * @typedef HistoricalEvent\n * @type {object}\n * @property {string}          id          - a unique identifier for this event\n * @property {string}          title       - a brief title of the event for display purposes\n * @property {string}          description - a detailed summary of the event\n * @property {string}          location    - the location in which the event took place\n * @property {DateDescription} date        - the date the event took place\n */\n\n/**\n * Container for encapsulating human-readable and machine-readable forms of a date.\n * @typedef DateDescription\n * @type {object}\n * @property {string} calendar    - machine-readable ISO 8601 timestamp\n * @property {string} description - human-readable description of this date\n */\n\n/**\n * Container for search results\n * @typedef PersonSearchResultSet\n * @type {object}\n * @property {SimplePerson[]} items  - search results\n * @property {string}         qs     - query string that gives the current set of search results\n * @property {?string}        qsNext - query string that gives next set of search results or null if this is the last set\n * @property {?string}        qsPrev - query string that gives preceding set of search results or null if this is the first set\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .provider('peopleRepo', peopleRepoProvider);\n\n\n  function peopleRepoProvider() {\n    var provider = {};\n    provider.url = '/api/people';\n    provider.$get = peopleRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function peopleRepoFactory($q, $resource) {\n      var restResource = $resource(provider.url + '/:id', null, {\n        'update': { method: 'PUT' }\n      });\n\n      var repo = {};\n      repo.create = createPerson;\n      repo.createName = createName;\n      repo.createEvent = createEvent;\n      repo.get = findById;\n      repo.search = search;\n      repo.save = savePerson;\n      repo.delete = deletePerson;\n      return repo;\n\n      /**\n       * Creates a new empty person instance.\n       *\n       * @return {Person}\n       */\n      function createPerson() {\n        var person = new restResource();\n        return adaptPerson(person);\n      }\n\n      /**\n       * Creates a new empty entry metadata instance\n       *\n       * @return {EntryMeta}\n       */\n      function createMeta() {\n        var meta = {};\n        return adaptMeta(meta);\n      }\n\n      /**\n       * Creates a new empty name instance\n       *\n       * @return {PersonName}\n       */\n      function createName() {\n        var name = {};\n        return adaptName(name);\n      }\n\n      /**\n       * Creates a new historical event instance\n       *\n       * @return {HistoricalEvent}\n       */\n      function createEvent() {\n        var evt = {};\n        return adaptEvent(evt);\n      }\n\n      /**\n       * Creates a date/description instance\n       *\n       * @return {DateDescription}\n       */\n      function createDateDescription() {\n        var dateDescription = {};\n        return dateDescription;\n      }\n\n      /**\n       * Retrieves a person object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promise is available on Person.$promise.\n       *\n       * @param  {string} id\n       * @return {Person}\n       */\n      function findById(id) {\n        return restResource.get({ id: id });\n      }\n\n      /**\n       * Retrieves a serch result set of people who match the given query.\n       *\n       * @param {string} query\n       * @return {PersonSearchResultSet}\n       */\n      function search(query) {\n        return restResource.get({ q: query });\n      }\n\n      /**\n       * Saves a person model to the REST API.\n       *\n       * If no ID is provided on the person model, the API will create save the model as a new\n       * person. Otherwise, the API will attempt to update the existing person model with that ID.\n       *\n       * @param {Person} person\n       * @return {Promise.<Person>} - resolves to the saved person on success\n       */\n      function savePerson(person) {\n        var response;\n        if (person.id) {\n          response = restResource.update({ id: person.id }, person);\n        } else {\n          response = restResource.save(null, person);\n        }\n\n        return response.$promise.then(function (personId) {\n          person.id = personId.id;\n          return person;\n        });\n      }\n\n      /**\n       * Deletes a person on the server via the REST API.\n       *\n       * @param {Person|string} idOrPerson\n       * @return {Promise} - resolves on success\n       */\n      function deletePerson(id) {\n        var response = restResource.delete({ id: id });\n        return response.$promise;\n      }\n\n      /**\n       * Populates a person with aggregate fields\n       *\n       * @param  {Person} person\n       * @return {Person}\n       */\n      function adaptPerson(person) {\n        if (!person.meta) {\n          person.meta = createMeta();\n        } else {\n          adaptMeta(person.meta);\n        }\n\n        if (!person.name) {\n          person.name = createName();\n        } else {\n          adaptName(person.name);\n        }\n\n        if (!person.altNames) {\n          person.altNames = [];\n        } else {\n          person.altNames.forEach(adaptName);\n        }\n\n        if (!person.birth) {\n          person.birth = createEvent();\n        } else {\n          adaptEvent(person.birth);\n        }\n\n        if (!person.death) {\n          person.death = createEvent();\n        } else {\n          adaptEvent(person.death);\n        }\n\n        return person\n      }\n\n      /**\n       * Ensure that entry metadata aggregate fields exist and are formatted correctly.\n       *\n       * @param  {EntryMeta} meta\n       * @return {EntryMeta}\n       */\n      function adaptMeta(meta) {\n        if (!meta.links) {\n          meta.links = {};\n        }\n\n        return meta;\n      }\n\n      /**\n       * Ensure that name aggregate fields exist and are formatted correctly\n       * @param  {PersonName} name\n       * @return {PersonName}\n       */\n      function adaptName(name) {\n        // no aggregate fields yet...\n        return name;\n      }\n\n      /**\n       * Ensure that event aggregate fields exist and are formatted correctly.\n       *\n       * @param  {HistoricalEvent} evt\n       * @return {HistoricalEvent}\n       */\n      function adaptEvent(evt) {\n        if (!evt.date) {\n          evt.date = createDateDescription();\n        }\n\n        return evt;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcPersonEditor', trcPersonEditorDirective);\n\n  /** @ngInject */\n  function trcPersonEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/person-editor.html',\n      scope: {\n        person: '=ngModel'\n      },\n      controller: PersonEditorController,\n      controllerAs: 'personEditor'\n    };\n\n    return directive;\n\n    /** @ngInject */\n    function PersonEditorController($scope, peopleRepo) {\n      var vm = this;\n\n      vm.addName = addName;\n      vm.removeName = removeName;\n      vm.addEvent = addEvent;\n      vm.removeEvent = removeEvent;\n\n      /**\n       * Adds a name to the current person model.\n       */\n      function addName() {\n        var newName = peopleRepo.createName();\n        $scope.person.altNames.push(newName);\n      }\n\n      /**\n       * Removes the name at the specified index from the current person model.\n       *\n       * @param {integer} ix\n       */\n      function removeName(ix) {\n        $scope.person.altNames.splice(ix, 1);\n      }\n\n      /**\n       * Adds an event to the current person model.\n       *\n       * @param {string} key - 'birth' or 'death'\n       */\n      function addEvent(key) {\n        var newEvent = peopleRepo.createEvent();\n        $scope.person[key] = newEvent;\n      }\n\n      /**\n       * Removes the event from the current person model.\n       *\n       * @param {string} key - 'birth' or 'death'\n       */\n      function removeEvent(key) {\n        $scope.person[key] = null;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcNameEditor', trcNameEditorDirective);\n\n  /** @ngInject */\n  function trcNameEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/name-editor.html',\n      scope: {\n        name: '=ngModel'\n      },\n      controller: NameEditorController,\n      controllerAs: 'nameEditor'\n    };\n\n    return directive;\n\n    function NameEditorController() {\n      var vm = this;\n\n      vm.roles = [\n        { value: 'canonical', label: 'Canonical Name' },\n        { value: 'pseudonym', label: 'Pseudonym' },\n        { value: 'maiden', label: 'Maiden Name' },\n        { value: 'designation', label: 'Honorary Designation' },\n        { value: 'nickname', label: 'Nickname' },\n        { value: 'phonetic', label: 'Phonetic Name' }\n      ];\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcEventEditor', trcEventEditorDirective);\n\n  /** @ngInject */\n  function trcEventEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/event-editor.html',\n      scope: {\n        event: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books', []);\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .provider('googleBooksApi', googleBooksApiProvider);\n\n   function googleBooksApiProvider() {\n      var API = {};\n\n      API.options = {\n         transport: 'https',\n         v: 0,\n         language: 'en',\n         preventLoad: false\n      };\n\n      API.configure = configure;\n      API.$get = loadGoogleBooks;\n\n      return API;\n\n      function configure(options) {\n         angular.extend(API.options, options);\n      }\n\n      /** @ngInject */\n      function loadGoogleBooks(googleBooksScriptLoader) {\n         return googleBooksScriptLoader.load(API.options);\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .factory('googleBooksScriptLoader', googleBooksScriptLoader);\n\n   /** @ngInject */\n   function googleBooksScriptLoader($window, $document, $q, _) {\n      var scriptId = undefined;\n      var usedConfiguration = undefined;\n\n      return {\n         load: load,\n         manualLoad: manualLoad\n      };\n\n      /**\n       * Get script URL for loading Google Books API\n       *\n       * @param {object} options\n       * @return {string}\n       */\n      function getScriptUrl(options) {\n         if (options.transport === 'auto') {\n            return '//www.google.com/books/api.js?';\n         } else {\n            return options.transport + '://www.google.com/books/api.js?';\n         }\n      }\n\n      function includeScript(options) {\n         var omitOptions = ['transport', 'preventLoad', 'randomizedFunctionName'];\n\n         var query = _.map(_.omit(options, omitOptions), function (v, k) { return k + '=' + v });\n\n         if (scriptId) {\n            var scriptElem = $document.getElementById(scriptId)\n            scriptElem.parentNode.removeChild(scriptElem);\n         } else {\n            scriptId = 'gbooks_load_' + Math.round(Math.random() * 1000);\n         }\n\n         query = query.join('&');\n         angular.element('<script>', {\n            id: scriptId,\n            type: 'text/javascript',\n            src: getScriptUrl(options) + query\n         }).appendTo(angular.element('body'));\n      }\n\n      function isGoogleBooksLoaded() {\n         return angular.isDefined($window.google) && angular.isDefined($window.google.books);\n      }\n\n      function load(options) {\n         var deferred = $q.defer();\n\n         if (isGoogleBooksLoaded()) {\n            deferred.resolve($window.google.books);\n            return deferred.promise;\n         }\n\n         var randomizedFunctionName = 'onGoogleBooksReady' + Math.round(Math.random() * 1000);\n         options.callback = randomizedFunctionName;\n\n         $window[randomizedFunctionName] = function () {\n            $window[randomizedFunctionName] = null;\n            deferred.resolve($window.google.books);\n         }\n\n         if (!options.preventLoad) {\n            includeScript(options);\n         }\n\n         usedConfiguration = options;\n         usedConfiguration.randomizedFunctionName = randomizedFunctionName;\n\n         return deferred.promise;\n      }\n\n      function manualLoad() {\n         var config = usedConfiguration;\n\n         if (!isGoogleBooksLoaded()) {\n            includeScript(config);\n         } else if ($window[config.randomizedFunctionName]) {\n            $window[config.randomizedFunctionName]();\n         }\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .directive('googleBookReader', googleBookReader);\n\n   /** @ngInject */\n   function googleBookReader(googleBooksApi, googleBooksApiManualLoader) {\n      var directive = {\n         restrict: 'E',\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope, el) {\n         googleBooksApiManualLoader.load();\n         googleBooksApi.then(function (books) {\n            var viewer = new books.DefaultViewer(el.get(0));\n\n            scope.$watch('properties', function (properties) {\n               viewer.load(properties.id);\n            });\n\n            scope.$on('resize', function () {\n               viewer.resize();\n            });\n         });\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .service('googleBooksApiManualLoader', googleBooksApiManualLoader);\n\n   /** @ngInject */\n   function googleBooksApiManualLoader(googleBooksScriptLoader) {\n      var API = {};\n\n      API.load = load;\n\n      return API;\n\n      function load() {\n         googleBooksScriptLoader.manualLoad();\n      }\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb', [\n      'ngAnimate',\n      'ngCookies',\n      'ngSanitize',\n      'ngMessages',\n      'ngAria',\n      'ngResource',\n      'ui.router',\n      'ngMaterial',\n      'trcBio',\n      'trcReln',\n      'trcWorks',\n      'ngDragDrop',\n      'pouchdb',\n      'vwise'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .run(runBlock);\n\n  /** @ngInject */\n  function runBlock($log) {\n    $log.debug('runBlock end');\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .config(routerConfig);\n\n  /** @ngInject */\n  function routerConfig($stateProvider, $urlRouterProvider) {\n    $stateProvider\n      .state('vwise', {\n        url: '/',\n        templateUrl: 'app/vwise/workspace.html',\n        controller: 'WorkspaceController',\n        controllerAs: 'vm'\n      });\n\n    $urlRouterProvider.otherwise('/');\n  }\n\n})();\n\n/* global _:false, moment:false */\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .constant('_', _)\n    .constant('moment', moment);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .config(config);\n\n  /** @ngInject */\n  function config($logProvider, /* toastrConfig, */ $mdThemingProvider, worksRepoProvider, peopleRepoProvider, relationshipsRepoProvider) {\n    // Enable log\n    $logProvider.debugEnabled(true);\n\n    $mdThemingProvider.definePalette('darkBrown', {\n      '50': '#595c59',\n      '100': '#4c4f4c',\n      '200': '#404240',\n      '300': '#333533',\n      '400': '#272827',\n      '500': '#1a1b1a',\n      '600': '#0d0e0d',\n      '700': '#010101',\n      '800': '#000000',\n      '900': '#000000',\n      'A100': '#e0f0e0',\n      'A200': '#565956',\n      'A400': '#7e837e',\n      'A700': '#000000',\n\n      contrastDefaultColor: 'light',\n      contrastDarkColors: ['A100']\n    });\n\n    $mdThemingProvider.definePalette('copper', {\n      '50': '#d4b190',\n      '100': '#cca47e',\n      '200': '#c5976b',\n      '300': '#be8a59',\n      '400': '#b67e47',\n      '500': '#a47140',\n      '600': '#926439',\n      '700': '#7f5832',\n      '800': '#6d4b2b',\n      '900': '#5b3e23',\n      'A100': '#dcc3ab',\n      'A200': '#a47140',\n      'A400': '#48321c',\n      'A700': '#272927',\n\n      contrastDefaultColor: 'light',\n      contrastDarkColors: ['50', '100', '200', 'A100']\n    });\n\n    $mdThemingProvider.theme('default')\n      .primaryPalette('darkBrown')\n      .accentPalette('copper');\n\n\n    worksRepoProvider.url = '/api/catalog/works';\n    peopleRepoProvider.url = '/api/catalog/people';\n    relationshipsRepoProvider.url = '/api/catalog/relationships';\n  }\n\n})();\n\nangular.module(\"sdaAdminWeb\").run([\"$templateCache\", function($templateCache) {$templateCache.put(\"app/trc-bio/event-editor.html\",\"<div class=form-group><label class=control-label for=event-title>Title</label><input type=text id=event-title name=event-title class=\\\"form-control event-title\\\" ng-model=event.title></div><div class=form-group><label class=control-label for=event-description>Description</label><textarea id=event-description name=event-description class=\\\"form-control event-description\\\" ng-model=event.description></textarea></div><div class=form-group><label class=control-label for=event-location>Location</label><input type=text id=event-location name=event-location class=\\\"form-control event-location\\\" ng-model=event.location></div><div class=form-group><label class=control-label for=event-date>Date</label><input type=text id=event-date name=event-date class=\\\"form-control event-date\\\" ng-model=event.date.description><!-- TODO add datepicker --></div>\");\n$templateCache.put(\"app/trc-bio/name-editor.html\",\"<div class=form-group class=name-role><label class=control-label for=name-role>Role</label><select id=name-role name=name-role class=\\\"form-control name-role\\\" ng-model=name.role><option ng-repeat=\\\"role in nameEditor.roles\\\" value={{role.value}}>{{role.label}}</option></select></div><div class=form-group class=name-structure><label class=control-label>Structured Name</label><input type=text class=name-title placeholder=title ng-model=name.title> <input type=text class=name-given placeholder=given ng-model=name.givenName> <input type=text class=name-middle placeholder=middle ng-model=name.middleName> <input type=text class=name-family placeholder=family ng-model=name.familyName> <input type=text class=name-suffix placeholder=suffix ng-model=name.suffix></div><div class=form-group class=name-label><label for=label>Display Label</label><input type=text placeholder=label ng-model=name.label></div>\");\n$templateCache.put(\"app/trc-bio/person-editor.html\",\"<div class=form-group><label for=person-name>Primary Name</label><trc-name-editor id=person-name ng-model=person.name></trc-name-editor></div><div class=form-group><label for=person-altnames>Alternate Names</label><div ng-repeat=\\\"name in person.altNames\\\"><trc-name-editor id=person-altnames ng-model=name></trc-name-editor><button ng-click=personEditor.removeName($index)>&minus;</button></div><button ng-click=personEditor.addName()>+</button></div><div class=form-group><label for=person-birth>Birth</label><div ng-if=person.birth><trc-event-editor id=person-birth ng-model=person.birth></trc-event-editor><button ng-click=\\\"personEditor.removeEvent(\\'birth\\')\\\">&minus;</button></div><div ng-if=!person.birth><button ng-click=\\\"personEditor.addEvent(\\'birth\\')\\\">+</button></div></div><div class=form-group><label for=person-death>Death</label><div ng-if=person.death><trc-event-editor id=person-death ng-model=person.death></trc-event-editor><button ng-click=\\\"personEditor.removeEvent(\\'death\\')\\\">&minus;</button></div><div ng-if=!person.death><button ng-click=\\\"personEditor.addEvent(\\'death\\')\\\">+</button></div></div><div class=form-group><label class=control-label for=person-summary>Summary</label><textarea id=person-summary name=person-summary class=\\\"form-control person-summary\\\" ng-model=person.summary></textarea></div>\");\n$templateCache.put(\"app/vwise/workspace.html\",\"<div layout=column flex><md-toolbar><div class=md-toolbar-tools><md-button class=\\\"md-accent md-icon-button\\\" ng-click=vm.openMenu() title=\\\"toggle menu\\\" hide-gt-sm><md-icon>menu</md-icon></md-button><img class=logo src=assets/images/sda-logo-light.png><h2><span>Visual Workspace</span></h2></div></md-toolbar><div layout=row flex><md-sidenav md-component-id=left class=md-sidenav-left layout=column md-is-locked-open=vm.sidebarFocused><form layout=row flex=none><md-input-container flex><label for=searchQuery>Search</label><md-icon>search</md-icon><input type=search name=searchQuery id=searchQuery ng-model=vm.searchQuery ng-change=vm.search(vm.searchQuery) required md-sidenav-focus></md-input-container></form><md-content flex><div ng-if=vm.loading layout=row layout-align=center><md-progress-circular md-mode=indeterminate></md-progress-circular></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.peopleResults &amp;&amp; vm.peopleResults.items.length == 0 &amp;&amp; vm.worksResults &amp;&amp; vm.worksResults.items.length == 0\\\" layout=row layout-padding><p>No results for \\\"{{vm.searchQuery}}\\\".</p></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.peopleResults &amp;&amp; vm.peopleResults.items.length > 0\\\"><md-subheader>People</md-subheader><md-list><md-list-item ng-repeat=\\\"item in vm.peopleResults.items\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span>{{item.label}}</span></div></md-list-item></md-list></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.worksResults &amp;&amp; vm.worksResults.items.length > 0\\\"><md-subheader>Works</md-subheader><md-list><md-list-item ng-repeat=\\\"item in vm.worksResults.items\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span>{{item.label}}</span></div></md-list-item></md-list></div></md-content></md-sidenav><vwise-workspace workspace=vm.workspace flex layout=column></vwise-workspace></div></div>\");\n$templateCache.put(\"app/vwise/components/panel/panel.html\",\"<div class=panel ng-class=\\\"{ resizing: vm.resizing }\\\" ng-style=\\\"{ left: vp.xPosition, top: vp.yPosition, zIndex: vp.zPosition, width: vp.width, height: vp.height }\\\" jqyoui-draggable=\\\"{ onDrag: \\'vm.movePanel()\\', onStop: \\'vm.stopMove()\\' }\\\" ng-click=vm.activatePanel($event) data-jqyoui-options=\\\"{ handle: \\'.drag-handle\\' }\\\" data-drag=true layout=column><div class=\\\"panel-control drag-handle\\\" layout=column layout-align=\\\"center center\\\"><md-icon>open_with</md-icon></div><button class=\\\"panel-control close\\\" ng-click=vm.closePanel($event) layout=column layout-align=\\\"center center\\\"><md-icon>close</md-icon></button><div class=\\\"panel-control resize-handle\\\" ng-style=\\\"{ left: vp.width, top: vp.height }\\\" jqyoui-draggable=\\\"{ onStart: \\'vm.startResize()\\', onDrag: \\'vm.resizePanel()\\', onStop:\\'vm.stopResize()\\'}\\\" data-drag=true layout=column layout-align=\\\"center center\\\"><md-icon>crop</md-icon></div><div class=\\\"panel-control panel-area panel-area-top\\\" layout=row layout-align=\\\"end center\\\"><button ng-repeat=\\\"button in vm.actionButtons\\\" ng-click=button.handler($event) title={{button.label}} layout=column layout-align=\\\"center center\\\"><md-icon ng-if=button.icon>{{button.icon}}</md-icon><span ng-if=!button.icon>{{button.label}}</span></button></div><div class=\\\"panel-control panel-area panel-area-right\\\" layout=column layout-align=\\\"start center\\\"><button ng-repeat=\\\"button in vm.propertyButtons\\\" ng-click=button.handler($event) title={{button.label}} layout=column layout-align=\\\"center center\\\"><md-icon ng-if=button.icon>{{button.icon}}</md-icon><span ng-if=!button.icon>{{button.label}}</span></button></div><div class=\\\"panel-control panel-area panel-area-bottom\\\"></div><div class=\\\"panel-control panel-area panel-area-left\\\"></div><div class=content flex layout=column></div></div>\");\n$templateCache.put(\"app/vwise/components/person-panel/person-panel.html\",\"<div class=panel-person flex layout=column><h1><span class=\\\"panel-label name\\\">{{name}}</span></h1><md-tabs flex><md-tab ng-if=person.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=person.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"panel.works &amp;&amp; panel.works.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in panel.works\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.label}}</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"panel.relatedPeople &amp;&amp; panel.relatedPeople.length > 0\\\"><md-tab-label><md-icon>link</md-icon></md-tab-label><md-tab-body><div ng-repeat=\\\"group in panel.relatedPeople\\\"><h3>{{group.label}}</h3><md-list><md-list-item ng-repeat=\\\"item in group.relationships\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.name.label}}</div></md-list-item></md-list></div></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/edition-panel.html\",\"<div class=panel-edition flex layout=column><h1><span class=authors><span class=author ng-repeat=\\\"author in edition.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span> <span class=edition-name>{{edition.editionName}}.</span></h1><md-tabs flex><md-tab ng-if=edition.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=edition.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"edition.volumes.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in edition.volumes\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>Volume {{item.volumeNumber}} ({{item.publicationInfo.date.description}})</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"edition.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in edition.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/volume-panel.html\",\"<div class=panel-volume flex layout=column><h1><span class=authors><span class=author ng-repeat=\\\"author in volume.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span> <span class=edition-name>{{edition.editionName}}.</span> <span class=volume-name>Volume {{volume.volumeNumber}}.</span></h1><md-tabs flex><md-tab ng-if=volume.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=volume.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"volume.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in volume.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/work-panel.html\",\"<div class=panel-work flex layout=column><h1><span class=panel-label><span class=authors><span class=author ng-repeat=\\\"author in work.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span></span></h1><md-tabs flex><md-tab ng-if=work.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=work.summary></div></md-tab-body></md-tab><md-tab><md-tab-label><md-icon>link</md-icon></md-tab-label><md-tab-body><div ng-repeat=\\\"group in relationships\\\"><h3>{{group.label}}</h3><md-list><div ng-repeat=\\\"relationship in group.relationships\\\"><md-list-item ng-repeat=\\\"item in relationship.entities\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span class=authors><span class=author ng-repeat=\\\"author in item.entity.authors\\\">{{author.lastName}}.</span></span> <span class=title>{{item.title.title}}{{item.title.subtitle ? \\': \\' : \\'\\'}}<span ng-if=item.title.subtitle class=subtitle>{{item.title.subtitle}}</span></span></div></md-list-item></div></md-list></div></md-tab-body></md-tab><md-tab ng-if=\\\"work.editions.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in work.editions\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.editionName}} ({{item.publicationInfo.date.description}})</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"work.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in work.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/workspace/workspace.html\",\"<div flex jqyoui-droppable=\\\"{stack: true, onDrop:\\'vm.thingDropped()\\'}\\\" data-drop=true class=workspace ng-click=vm.workspaceClicked($event)><vwise-panel ng-repeat=\\\"panel in workspace.panels track by panel.id\\\" panel=panel></vwise-panel></div>\");}]);"],"sourceRoot":"/source/"}