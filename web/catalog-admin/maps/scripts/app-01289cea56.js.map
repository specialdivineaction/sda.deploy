{"version":3,"sources":["scripts/app.js"],"names":["angular","module","titleEditorDirective","directive","restrict","templateUrl","scope","title","publicationInfoEditorDirective","pubInfo","copyEditorDirective","copy","controller","CopyEditorController","controllerAs","$scope","activate","addHandler","HathiTrustRefHandler","GoogleBooksRefHandler","InternetArchiveRefHandler","handler","vm","refHandlers","id","parseProperties","type","url","properties","copyForm","$setValidity","this","setProperties","handle","parsed","parseUrl","seq","path","substr","pageNo","fragment","match","length","makePropertiesObject","src","display","hostname","query","lastIndexOf","urlappend","subquery","parseQueryString","htid","section","printsec","page","pg","parser","document","createElement","href","toString","protocol","host","port","pathname","search","hash","sep","isString","flags","indexOf","kvpairs","split","forEach","pair","ix","key","value","decodeURIComponent","URIError","hasOwnProperty","isArray","push","$inject","authorRefEditorDirective","AuthorRefEditorController","peopleRepo","ref","authorId","author","get","$promise","then","linkAuthorSearchText","name","label","setLinkedAuthor","person","getResults","resultSet","items","authorRoles","workspaceRepositoryProvider","vwise","workspaceRepositoryFactory","panelContentMediatorRegistry","$http","$q","pouchDB","db","provider","NgWorkspaceRepository","declare","$get","mediatorRegistry","WorkspaceRepository","call","workspaces","Cache","panels","prototype","Object","create","listWorkspaceIds","allDocs","include_docs","result","rows","filter","row","doc","map","createWorkspace","UUID","uuid4","workspace","Workspace","saveWorkspace","TypeError","dto","_id","_rev","marshallWorkspace","put","response","ok","Error","rev","getWorkspace","reject","repo","fetch","unmarshallWorkspace","removeWorkspace","remove","createPanel","mediator","content","vprops","panel","Panel","p","savePanel","marshallPanel","getPanel","panelId","unmarshallPanel","removePanel","vwiseWorkspace","WorkspaceController","thingDropped","evt","ui","itemScope","draggable","item","offset","element","target","context","xPosition","position","left","yPosition","top","width","height","background","contentMediators","findContentMediators","contentP","initPanelData","createNotePanel","x","y","note","workspaceClicked","ctrlKey","clientX","clientY","workPanelDirective","worksRepo","linkFunc","el","attrs","createExpandCollapseButton","toggleCollapse","button","icon","origSize","panelLabel","outerWidth","outerHeight","find","addActionButton","getTitle","work","titles","editions","edition","workId","require","relationships","link","volumePanelDirective","volume","getEdition","editionId","editionPanelDirective","volumes","personPanelDirective","_","attr","at","NAME_KEYS","n","trim","identity","join","PersonPanelController","relationshipsRepo","worksP","getWorksAuthored","works","relatedP","getRelatedPeople","related","relatedPeople","searchByAuthor","relnsPs","getRelationships","relnsP","all","relnss","chain","flatten","groupBy","group","identifier","reverse","groups","clone","flatMap","groupPs","authorIdsPs","entity","authorIds","authors","authorIdsP","authorIdss","uniq","authorPs","uri","normRelnsP","relns","normRelns","normalizeRelationships","worksContentMediatorFactory","Mediator","PanelContentMediator","loadWork","loadRelationships","currentUri","results","reln","entities","refParams","volumeId","matches","obj","unmarshall","marshall","panelData","getTemplate","factory","volumesContentMediatorFactory","loadVolume","getVolume","peopleContentMediatorFactory","loadPerson","passthruContentMediatorFactory","panelContentMediatorRegistryFactory","PanelContentMediatorRegistry","noteContentMediatorFactory","editionsContentMediatorFactory","loadEdition","internetArchiveContentMediatorFactory","hathitrustContentMediatorFactory","googleBooksContentMediatorFactory","vwisePanel","$compile","$el","controllers","panelController","getInfoArea","getStatusArea","vp","panelScope","$new","$watch","color","rgb","hextorgb","foreground","calculateForeground","save","template","contentMediator","contentArea","html","contents","replace","PanelController","spec","actionButtons","splice","addPropertyButton","propertyButtons","closePanel","movePanel","Math","max","stopMove","setPosition","activatePanel","startResize","resizing","resizePanel","$apply","stopResize","setSize","stopPropagation","hex","r","parseInt","g","b","pow","lum","iaReader","$sce","trustAsResourceUrl","hathitrustReader","params","queryString","READER_URL","contenteditable","ngModel","$render","getTrustedHtml","$viewValue","on","$setViewValue","workEditorItemDirective","$log","error","WorkEditorItemController","loaded","workEditorDirective","WorkEditorController","model","focused","createEdition","cloneDeep","deleteEdition","volumeEditorDirective","editionEditorDirective","EditionEditorController","createVolume","publicationInfo","deleteVolume","nameEditorDirective","eventEditorDirective","event","treeCategorizationEditor","scopeId","scheme","TreeCategorizationController","$mdDialog","$mdToast","$state","articlesRepo","categorizationService","info","getScopedRepo","overviews","handleAssociateEntry","$event","node","linkArticle","article","nodes","reference","openEditor","values","go","articlePromise","linkPromise","handleRemoveEntry","handleCreateChild","parent","onCreate","newCategoryDialog","prompt","placeholder","cancel","targetEvent","show","handleDeleteNode","msg","removeCatgorizationDialog","confirm","htmlContent","showSimple","ArticleEditorSectionController","ArticleEditorController","$stateParams","$mdBottomSheet","refsRepoFactory","references","refsRepo","cleanArticleHandler","$watchCollection","cleanRefsHandler","alert","editFootnote","footnote","newFootnote","newReferences","createRefCollection","config","clickOutsideToClose","locals","promise","footnotes","updatedReferences","merge","compact","cleanReferences","cleanFootnotes","refsRepoUrl","getReferencesEndpoint","getRepo","body","abstractEditor","extend","CKEDITOR_CONFIG","removeButtons","editor","toolbarGroups","format_tags","extraPlugins","mathJaxLib","ZoteroTestController","types","categorizationRepoProvider","categorizationRepoFactory","$resource","ScopedRepository","getCategorization","schemesResource","createCategorization","description","removeCategorization","getNode","schemeId","nodeId","getNodeChildren","createNode","options","data","nodeChilrenResource","childIds","children","removeNode","removeRefs","nodeResource","remove_refs","moveNode","updateNode","linkEntry","entryRef","associatedEntryResource","update","unlinkEntry","getChildren","move","unlink","method","summaryEditorDirective","summary","SummaryEditDialogController","close","hide","stripTagsFilter","stripTags","String","NavbarController","$mdSidenav","toggleSidenav","toggle","component","bindings","sidenavId","guessDateFactory","moment","guessDate","str","INFER_FORMATS","dateEditorDirective","calendarAutoSet","dateDescription","date","calendar","format","DataContainerController","watch","fn","unregister","listeners","set","newValue","FootnoteEditDialogController","done","ckeditorFootnotesDirective","$document","requires","insertFootnoteCommand","fire","FOOTNOTE_COMMAND_NAME","command","createFootnote","backlinkId","anchorIdPrefix","ckeditorBibliography","ctrl","insertHtml","ckeditorFootnotesAnchorIdPrefix","ckeditor","instance","scopeValueExpr","ckeditorFootnotes","$eval","addCommand","async","allowedContent","requiredContent","exec","addButton","toolbar","ckeditorBibliographyDirective","refsRenderer","citationEditDialog","insertCitationCommand","CITATION_COMMAND_NAME","newReference","citation","createCitation","citations","render","rendered","refs","CitationEditorController","$filter","zotero","account","getUserAccount","ZOTERO_USER_ACCOUNT_ID","ZOTERO_USER_ACCOUNT_API_KEY","groupP","when","getGroup","ZOTERO_GROUP_ID","groupLibraryP","getLibrary","warn","library","resultsP","searchItems","adaptItem","wrapItem","zItem","createBiblioItem","creators","adaptCreator","meta","pick","fields","omit","zCreator","role","creatorType","firstName","lastName","labelP","renderBiblioItem","addCitationItem","citationItem","referencedBibItem","bibliography","renderCitationItemLabel","clearForm","selectBiblioItem","itemContainer","activeCitationItem","editCitationItem","biblioItem","biblioItemContainer","selectedBiblioItem","searchText","renderedP","createZoteroItem","zoteroItem","cancelZoteroItem","saveZoteroItem","zItemP","saveItem","biblioItemP","itemContainerP","locatorTypes","LOCATOR_TYPES","edit","CitationEditDialogFactory","CitationEditDialogController","bibliographyDirective","watcher","collection","ShowWorkController","$timeout","bcTitle","relationshipsPromise","refsEndpointUrl","loading","getCurrentUri","editBibInfo","dialog","dialogPromise","updatedWork","saveWork","showSavedToast","editSummary","updatedSummary","editBibliography","addEdition","textContent","savePromise","editionName","saveEdition","addCopy","editCopy","copies","updatedCopy","deleteCopy","openRelationship","relationship","addRelationship","createRelationship","updatedRelationship","deleteRelationship","confirmPromise","deletePromise","deleteWork","showSuccessToast","message","workLabel","toast","simple","showErrorToast","subtitle","confirmDialog","WorkEditDialogController","addAuthor","field","authorRef","deleteAuthor","addTitle","deleteTitle","ShowVolumeController","getWork","workTitle","updatedVolume","saveVolume","copyToEdition","origCopy","newCopy","VolumeEditDialogController","RelationshipEditDialogController","getTypes","createAnchor","targetEntities","self","entryUris","relatedEntities","descriptionMimeType","rawTypes","defineProperty","isDirected","reverseTitle","setType","typeId","isReverse","swap","selectWork","workProxy","targets","workUri","editionUri","editionTitle","volumeUri","volumeTitle","volumeNumber","selectedTarget","setTarget","selectedType","ShowEditionController","updatedEdition","addVolume","copyToWork","EditionEditDialogController","CopyEditDialogController","ZoteroEditorController","getItemTypes","typeFilter","selectType","itemType","getFields","getCreatorRoles","roles","itemTypeSearchText","ZoteroCreatorFieldController","creator","ZoteroFactory","getDefaultBaseUrl","toJson","workspaceRepository","hotkeys","workspaceIdP","workspaceId","ids","workspaceP","bindTo","add","combo","callback","sidebarFocused","searchQuery","focus","tagAll","arr","peopleResults","worksResults","property","activeItems","debounce","runBlock","peopleContentMediator","worksContentMediator","editionsContentMediator","volumesContentMediator","googleBooksContentMediator","hathitrustContentMediator","internetArchiveContentMediator","noteContentMediator","passthruContentMediator","register","run","constant","googleBooksApiProvider","configure","preventLoad","worksRepoProvider","worksRepoFactory","findAll","restResource","q","aid","isUndefined","adaptWork","editionResource","adaptEdition","volumeResource","adaptVolume","createWork","arguments","apply","$update","$save","isObject","dataItem","adaptCommon","toLowerCase","getTitleByTypePreference","reduce","found","getAll","tasksRepoProvider","tasksRepoFactory","getAllTasks","taskResource","getTask","taskId","getWorkflow","workflowResource","getItems","stageId","itemResource","stage","start","transition","sourceStage","targetStage","itemId","comments","resp","relationshipsRepoProvider","relationshipsRepoFactory","typesCache","force","typeResource","tcPromise","getType","relnResource","adaptRelationship","createProvenance","provenance","adaptProvenance","anchor","adaptAnchor","findById","queryOpts","direction","off","saveRelationship","creatorUris","some","targetField","resolveEntityUri","normReln","entityPs","relnsByTypeDir","fwd","typeGroups","typeGroupPs","kvMap","dirs","concat","ENTITY_URI","makeVolumeEntity","makeEditionEntity","makeWorkEntity","formatTitle","entityP","o","cb","keys","k","arrs","flattened","prop","CSL","referencesRepositoryFactoryProvider","referencesRepositoryFactoryFactory","createRepository","endpoint","getReferences","refsResource","saveReferences","compactRefs","compactRefCollection","res","deleteReferences","generate","mergeReferences","a","newRef","keyBy","mapValues","validateRefCollection","itemIds","invalidItemIds","propertyOf","isValidRefCollection","errors","validate","isValid","ReferenceRendererServiceFactory","refsAdapter","citeproc","renderReference","styleId","cslReferenceP","adapterConfigP","adapt","citeprocP","cslReference","load","paramsP","renderP","renderCiteproc","cslBiblioItemP","adaptBiblioItem","cslBiblioItem","cslBibliographyP","cslBibliography","updateItems","renderedCitations","appendCitationCluster","makeBibliography","bibliography_errors","entryIds","entry_ids","entrySpacing","entryspacing","hangingIndent","hangingindent","lineSpacing","linespacing","maxOffset","maxoffset","secondFieldAlign","bibstart","bibend","refsAdapterFactory","adaptReference","adaptCitation","makeCslBibliogaphyItemAdapter","trcCitation","citationID","citationItems","trcCitationItem","locator","locatorType","suppress-author","suppressAuthor","adaptField","cslField","getCslField","itemTypeMapping","raw","cslItem","getItemTypeMapping","cslCreatorFields","getCslCreators","zItemType","itemMappings","source","zField","cslFieldDef","cslFieldMeta","trcCreators","cslCreators","trcCreator","cslCreatorFieldDef","creatorTypes","cslCreator","given","family","literal","cslCreatorField","adapter","citeprocProvider","addLocale","localeId","supplier","localeSuppliers","addStyle","styleSuppliers","citeprocFactory","$injector","getEngine","bibliographyItemSupplier","getBibliographyItem","style","loadStyle","locales","localesP","getLocale","lang","citeprocSys","retrieveLocale","retrieveItem","Engine","defaultLocale","loadLocale","loadedLocales","localeSupplier","invoke","loadedStyles","styleSupplier","loadLocales","peopleRepoProvider","peopleRepoFactory","createPerson","adaptPerson","createMeta","adaptMeta","createName","adaptName","createEvent","adaptEvent","createDateDescription","savePerson","personId","deletePerson","altNames","birth","death","links","trcPersonEditorDirective","PersonEditorController","addName","newName","removeName","addEvent","newEvent","removeEvent","trcNameEditorDirective","NameEditorController","trcEventEditorDirective","articlesRepoProvider","articlesRepoFactory","articleId","createArticle","articleResource","articleType","mimeType","getArticle","saveArticle","deleteArticle","fullContent","citeId","footnoteId","TaskController","tasksRepo","tasks","openMenu","ShowTaskController","task","workflow","worklistPromises","stages","worklistPromise","fetchStage","focusItem","stopImmediatePropagation","entityId","transitionItem","updatedItem","worklists","stageOrder","slideToggle","duration","slideToggleDuration","active","stop","slideDown","slideUp","ShowPersonController","personRefsUrl","editBioInfo","updatedPerson","editEvent","updatedEvent","nameLabel","PersonEditDialogController","deleteName","nameRoles","EventEditDialogController","MainController","API","loadGoogleBooks","googleBooksScriptLoader","transport","v","language","$window","getScriptUrl","includeScript","omitOptions","scriptId","scriptElem","getElementById","parentNode","removeChild","round","random","appendTo","isGoogleBooksLoaded","isDefined","google","books","deferred","defer","resolve","randomizedFunctionName","usedConfiguration","manualLoad","undefined","googleBookReader","googleBooksApi","googleBooksApiManualLoader","viewer","DefaultViewer","$on","resize","service","debug","routerConfig","$stateProvider","$urlRouterProvider","state","views","main","otherwise","$logProvider","$mdThemingProvider","categorizationServiceProvider","debugEnabled","definePalette","50","100","200","300","400","500","600","700","800","900","A100","A200","A400","A700","contrastDefaultColor","contrastDarkColors","theme","primaryPalette","accentPalette","$templateCache"],"mappings":"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","file":"scripts/app-01289cea56.js","sourcesContent":["(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb', [\n      'ngAnimate',\n      'ngCookies',\n      // 'ngTouch',\n      'ngSanitize',\n      'ngMessages',\n      'ngAria',\n      'ngResource',\n      'ui.router',\n      'ckeditor',\n      'ngMaterial',\n      'ngDragDrop',\n      'pouchdb',\n      'slideToggle',\n      'trcCore',\n      'trcWorks',\n      'trcTasks',\n      'trcBio',\n      'trcReln',\n      'trcRefs',\n      'trcArticles',\n      'vwise',\n      'zotero'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('titleEditor', titleEditorDirective);\n\n  /** @ngInject */\n  function titleEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/title-editor/title-editor.html',\n      scope: {\n        title: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('publicationInfoEditor', publicationInfoEditorDirective);\n\n  /** @ngInject */\n  function publicationInfoEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/publication-info-editor/publication-info-editor.html',\n      scope: {\n        pubInfo: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('copyEditor', copyEditorDirective);\n\n  /** @ngInject */\n  function copyEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/copy-editor/copy-editor.html',\n      scope: {\n        copy: '=ngModel'\n      },\n      controller: CopyEditorController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n  }\n\n  /** @ngInject */\n  function CopyEditorController($scope) {\n    var vm = this;\n\n    vm.refHandlers = {};\n    vm.setProperties = parseProperties;\n\n    activate();\n\n    function activate() {\n      addHandler(HathiTrustRefHandler());\n      addHandler(GoogleBooksRefHandler());\n      addHandler(InternetArchiveRefHandler());\n    }\n\n    function addHandler(handler) {\n      vm.refHandlers[handler.id] = handler;\n    }\n\n    function parseProperties(type, url) {\n      if (vm.refHandlers[type]) {\n        $scope.copy.properties = vm.refHandlers[type](url);\n      }\n\n      $scope.copyForm.url.$setValidity(type, $scope.copy.properties != null);\n    }\n  }\n\n  // https://archive.org/details/essayinanswertom00adamiala\n  // <iframe src='https://archive.org/stream/essayinanswertom00adamiala?ui=embed#page/n7/mode/1up' width='480px' height='430px' frameborder='0' ></iframe>\n  // TODO add support for resources from OpenLibrary\n  // https://openlibrary.org/books/OL7186607M/An_essay_in_answer_to_Mr._Hume's_Essay_on_miracles.\n\n  /**\n   * A reference parse handler to support digital copies from the Internet\n   * Archive.\n   */\n  function InternetArchiveRefHandler() {\n    function handle(url) {\n      var parsed = parseUrl(url);\n      if (!parsed) {\n        return null;\n      }\n\n      var id, seq;\n\n      if (parsed.path.substr(0, 8) === '/stream/') {\n        id = parsed.path.substr(8);\n\n        var pageNo = parsed.fragment.match(/page\\/([^\\/]+)/);\n        if (pageNo && pageNo.length >= 2) {\n          seq = pageNo[1];\n        }\n      }\n\n      return makePropertiesObject(url, id, seq);\n    }\n\n    handle.id = 'internetarchive';\n    handle.display = 'Internet Archive';\n\n    /**\n     * Constructs an object literal that represents the stored-properties\n     * to associate with an InternetArchive digital copy.\n     *\n     * @param  {string} src The source URL from which the properties were parsed.\n     * @param  {string} id  The identifier used to uniquely reference a\n     *                      particular digial copy at the Internet Archive.\n     * @param  {string} seq The sequence number that identifies the page to be\n     *                      used as the initial page of this digital copy.\n     * @return {object}     The object literal of properties to be associated\n     *                      with this digital copy.\n     */\n    function makePropertiesObject(src, id, seq) {\n      if (!id) {\n        return null;\n      }\n\n      return {\n        src: src,\n        id: id,\n        seq: seq\n      };\n    }\n\n    return handle;\n  }\n\n  function HathiTrustRefHandler() {\n    function handle(url) {\n      var parsed = parseUrl(url);\n      if (!parsed) {\n        return null;\n      }\n\n      var id, seq;\n\n      switch (parsed.hostname) {\n        case 'babel.hathitrust.org':\n          id = parsed.query.id;\n          seq = parsed.query.seq;\n          break;\n\n        case 'hdl.handle.net':\n          id = parsed.path.substr(parsed.path.lastIndexOf('/') + 1);\n\n          if (!parsed.query.urlappend) {\n            break;\n          }\n\n          var subquery = parseQueryString(parsed.query.urlappend);\n          if (!subquery) {\n            break;\n          }\n          seq = subquery.seq;\n          break;\n      }\n\n      if (!id) {\n        return null;\n      }\n\n      return {\n        src: url,\n        htid: id,\n        seq: seq\n      };\n    }\n\n    handle.id = 'hathitrust';\n    handle.display = 'HathiTrust';\n\n    return handle;\n  }\n\n  function GoogleBooksRefHandler() {\n    function handle(url) {\n      var parsed = parseUrl(url);\n      if (!parsed) {\n        return null;\n      }\n\n      switch (parsed.hostname) {\n        case 'books.google.com':\n          var id = parsed.query.id;\n          var section = parsed.query.printsec;\n          var page = parsed.query.pg;\n          break;\n      }\n\n      if (!id) {\n        return null;\n      }\n\n      return {\n        src: url,\n        id: id,\n        section: section,\n        page: page\n      };\n    }\n\n    handle.id = 'googlebooks';\n    handle.display = 'Google Books';\n\n    return handle;\n  }\n\n  /**\n   * Parses a URL string into its components\n   *\n   * @param  {string} url\n   * @return {URL}\n   */\n  function parseUrl(url) {\n    if (!url) {\n      return null;\n    }\n\n    // eslint-disable-next-line angular/document-service\n    var parser = document.createElement('a');\n    parser.href = url;\n\n    return {\n      toString: function() {\n        return url;\n      },\n      protocol: parser.protocol,\n      host: parser.host,\n      hostname: parser.hostname,\n      port: parser.port,\n      path: parser.pathname,\n      query: parseQueryString(parser.search),\n      fragment: parser.hash\n    };\n  }\n\n  /**\n   * Parses a query string into key/value pairs\n   *\n   * @param {string} query\n   * @return {object.<string,any>}\n   */\n  function parseQueryString(query, sep) {\n    if (!query || !angular.isString(query)) {\n      return {};\n    }\n\n    // remove leading '?'\n    if (query[0] === '?') {\n      query = query.substr(1);\n    }\n\n    // attempt to auto-detect separator\n    if (!sep) {\n      // auto-detection \"bitmask\"\n      // 0 = none detected -- prefer '&'\n      // 1 = only ';' detected -- use it\n      // 2 = only '&' detected -- use it\n      // 3 = both detected -- prefer '&'\n      var flags = (query.indexOf(';') >= 0 ? 1 : 0) + (query.indexOf('&') >= 0 ? 2 : 0);\n      sep = flags === 1 ? ';' : '&';\n    }\n\n    var parsed = {};\n\n    var kvpairs = query.split(sep);\n    kvpairs.forEach(function (pair) {\n      var ix = pair.indexOf('=');\n      var key = pair;\n      var value = null;\n\n      if (!key) {\n        return;\n      }\n\n      if (ix >= 0) {\n        key = pair.substr(0, ix);\n        value = pair.substr(ix + 1);\n      }\n\n      try {\n        key = decodeURIComponent(key);\n        value = decodeURIComponent(value);\n      } catch (URIError) {\n        return;\n      }\n\n      // TODO: handle key array/map notation\n\n      if (parsed.hasOwnProperty(key)) {\n        // convert repeated keys into an array\n        if (angular.isArray(parsed[key])) {\n          parsed[key].push(value);\n        } else {\n          parsed[key] = [parsed[key], value];\n        }\n      } else {\n        parsed[key] = value;\n      }\n    });\n\n    return parsed;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('authorRefEditor', authorRefEditorDirective);\n\n  /** @ngInject */\n  function authorRefEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/author-ref-editor/author-ref-editor.html',\n      scope: {\n        ref: '=ngModel'\n      },\n      controller: AuthorRefEditorController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    /** @ngInject */\n    function AuthorRefEditorController($scope, peopleRepo) {\n      var vm = this;\n\n      vm.linkAuthorSearchText = '';\n      vm.authorRoles = [\n        'author',\n        'editor',\n        'translator',\n        'other'\n      ];\n\n      vm.setLinkedAuthor = setLinkedAuthor;\n      vm.getResults = getResults;\n\n      activate();\n\n      function activate() {\n        if ($scope.ref.authorId) {\n          var author = peopleRepo.get($scope.ref.authorId);\n          author.$promise.then(function () {\n            vm.linkAuthorSearchText = author.name.label;\n          })\n        }\n      }\n\n      function setLinkedAuthor(person) {\n        $scope.ref.authorId = person.id;\n      }\n\n      function getResults(query) {\n        var resultSet = peopleRepo.search(query);\n        return resultSet.$promise.then(function () {\n          return resultSet.items;\n        });\n      }\n\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise', [\n      'ngSanitize',\n      'google.books',\n      'cfp.hotkeys',\n      'trcWorks',\n      'trcBio'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .provider('workspaceRepository', workspaceRepositoryProvider);\n\n  /** @ngInject */\n  function workspaceRepositoryProvider(vwise) {\n    var NgWorkspaceRepository = declare(vwise);\n\n    var provider = {\n      db: {\n        name: 'vwise'\n      },\n      $get: workspaceRepositoryFactory\n    };\n\n    return provider;\n\n    /** @ngInject */\n    function workspaceRepositoryFactory(panelContentMediatorRegistry, $http, $q, pouchDB) {\n      var db = pouchDB(provider.db);\n      return new NgWorkspaceRepository(panelContentMediatorRegistry, db, $q);\n    }\n  }\n\n  /**\n   * Declares and returns the NgWorkspaceRepository class.\n   * Required protoypical inheritance of vwise.WorkspaceRepository makes this class definition verbose but necessary.\n   * Ideally (and eventually) this should be done as an ES6 class in a separate file and loaded via an import statement.\n   * @param  {vwise} vwise\n   * @return {Class.<NgWorkspaceRepository>}\n   */\n  function declare(vwise) {\n    /**\n     * Angularized Workspace Repository powered via PouchDB; makes use of $q services (must be injected at construction)\n     * @class\n     * @extends {vwise.WorkspaceRepository}\n     */\n    function NgWorkspaceRepository(mediatorRegistry, db, $q) {\n      vwise.WorkspaceRepository.call(this, mediatorRegistry);\n\n      // injected services and configuration options\n      this.$q = $q;\n      this.db = db;\n\n      /**\n       * A cache for storing loaded workspace instances\n       * @type {vwise.Cache.<Promise.<Workspace>}\n       */\n      this.workspaces = new vwise.Cache;\n\n      /**\n      * A cache for storing loaded panel instances\n      * @type {vwise.Cache.<Promise.<Panel>}\n      */\n      this.panels = new vwise.Cache;\n    }\n\n    NgWorkspaceRepository.prototype = Object.create(vwise.WorkspaceRepository.prototype);\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.listWorkspaceIds = function listWorkspaceIds() {\n      return this.db.allDocs({ include_docs: true }).then(function (result) {\n        return result.rows\n          .filter(function (row) {\n            return row.doc && row.doc.type === 'workspace';\n          })\n          .map(function (row) {\n            return row.id;\n          });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.createWorkspace = function createWorkspace(title) {\n      var id = vwise.UUID.uuid4();\n      var workspace = new vwise.Workspace(id, this);\n\n      if (title) {\n        workspace.title = title;\n      }\n\n      return this.saveWorkspace(workspace);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.saveWorkspace = function saveWorkspace(workspace) {\n      if (!(workspace instanceof vwise.Workspace)) {\n        throw new TypeError('expected instance of Workspace');\n      }\n\n      var dto = {\n        _id: workspace._id || workspace.id,\n        _rev: workspace._rev,\n        type: 'workspace',\n        workspace: this.marshallWorkspace(workspace)\n      };\n\n      // prefer saved pouchdb options, but fall back to vwise api options\n      return this.db.put(dto)\n        .then(function (response) {\n          if (!response.ok) {\n            throw new Error('unable to save workspace');\n          }\n\n          // save pouchdb options for later usage\n          workspace._id = response.id;\n          workspace._rev = response.rev;\n\n          return workspace;\n        });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.getWorkspace = function getWorkspace(id) {\n      if (!id) {\n        return this.$q.reject(new Error('no id provided'));\n      }\n\n      var repo = this;\n      return this.workspaces.fetch(id, function () {\n        return repo.db.get(id).then(function (dto) {\n          return repo.unmarshallWorkspace(dto.workspace).then(function (workspace) {\n            workspace._id = dto._id;\n            workspace._rev = dto._rev;\n            return workspace;\n          });\n        });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.removeWorkspace = function removeWorkspace(workspace) {\n      return this.db.remove(workspace);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.createPanel = function createPanel(mediator, workspace, content, vprops) {\n      var id = vwise.UUID.uuid4();\n      var repo = this;\n      var panel = new vwise.Panel(id, mediator, workspace, content, vprops, function (p) {\n        repo.savePanel(p);\n      });\n\n      return this.savePanel(panel);\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.savePanel = function savePanel(panel) {\n      if (!(panel instanceof vwise.Panel)) {\n        throw new TypeError('expected instance of Panel');\n      }\n\n      var dto = {\n        _id: panel._id || panel.id,\n        _rev: panel._rev,\n        type: 'panel',\n        panel: this.marshallPanel(panel)\n      };\n\n      return this.db.put(dto)\n        .then(function (response) {\n          if (!response.ok) {\n            throw new Error('unable to save panel');\n          }\n\n          // save pouchdb options for later usage\n          panel._id = response.id;\n          panel._rev = response.rev;\n\n          return panel;\n        });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.getPanel = function getPanel(panelId, workspace) {\n      if (!panelId) {\n        return this.$q.reject(new Error('no id provided'));\n      }\n\n      var repo = this;\n      return this.panels.fetch(panelId, function () {\n        return repo.db.get(panelId).then(function (dto) {\n          return repo.unmarshallPanel(dto.panel, workspace).then(function (panel) {\n            panel._id = dto._id;\n            panel._rev = dto._rev;\n            return panel;\n          });\n        });\n      });\n    };\n\n    /**\n     * @inheritdoc\n     */\n    NgWorkspaceRepository.prototype.removePanel = function removePanel(panel, workspace) {\n      if (workspace) {\n        workspace.removePanel(panel);\n      }\n\n      return this.db.remove(panel);\n    };\n\n    return NgWorkspaceRepository;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('vwiseWorkspace', vwiseWorkspace);\n\n  /** @ngInject */\n  function vwiseWorkspace() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/workspace/workspace.html',\n      scope: {\n        workspace: '='\n      },\n      controller: WorkspaceController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n  }\n\n  /** @ngInject */\n  function WorkspaceController($scope, panelContentMediatorRegistry) {\n    var vm = this;\n\n    vm.thingDropped = thingDropped;\n    vm.workspaceClicked = workspaceClicked;\n\n    /**\n     * Drop callback for when something is droppen on the workspace content ariea\n     * @param  {Event}  evt DOM Event\n     * @param  {Object} ui  jQuery UI draggable callback data\n     */\n    function thingDropped(evt, ui) {\n      // get scope of object that was dropped\n      var itemScope = ui.draggable.scope();\n\n      // here's the data object of the panel we want to create\n      // HACK: need a better way to pass a vwise droppable item in...\n      var item = itemScope.item;\n\n      // if no item is available (e.g. if a panel was dropped)\n      if (!item) {\n        return;\n      }\n\n      var offset = angular.element(evt.target).offset();\n\n      // set initial panel attributes\n      var context = {\n        xPosition: ui.position.left - offset.left,\n        yPosition: ui.position.top - offset.top,\n        width: 600,\n        height: 400,\n        background: '#ffffff'\n      };\n\n      // who is capable of handling the dropped item\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(item, context);\n      // $log.debug('found ' + contentMediators.length + ' matching content mediator(s).');\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n\n      if (!mediator) {\n        return;\n      }\n\n      var contentP = mediator.initPanelData(item, context);\n      contentP.then(function (content) {\n        return $scope.workspace.createPanel(mediator, content, context);\n      });\n    }\n\n    /**\n     * Creates a new note panel at the desired position\n     * @param {integer} x\n     * @param {integer} y\n     */\n    function createNotePanel(x, y) {\n      var note = {\n        note: ''\n      };\n\n      var context = {\n        xPosition: x,\n        yPosition: y\n      };\n\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(note, context);\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n      $scope.workspace.createPanel(mediator, note, context);\n    }\n\n    function workspaceClicked(evt) {\n      if (evt.ctrlKey) {\n        var offset = angular.element(evt.target).offset();\n        createNotePanel(evt.clientX - offset.left, evt.clientY - offset.top);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('workPanel', workPanelDirective);\n\n  /** @ngInject */\n  function workPanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      require: '^^vwisePanel',\n      templateUrl: 'app/vwise/components/work-panel/work-panel.html',\n      scope: {\n        work: '=',\n        relationships: '=',\n        vprops: '='\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attrs, panel) {\n      panel.addActionButton(createExpandCollapseButton());\n\n      scope.title = worksRepo.getTitle(scope.work.titles);\n\n      scope.work.editions.forEach(function (edition) {\n        edition.type = 'edition';\n        edition.workId = scope.work.id;\n      });\n\n      /**\n       * @return {object}\n       */\n      function createExpandCollapseButton() {\n        var origSize = {\n          width: scope.vprops.width,\n          height: scope.vprops.height\n        };\n\n        var panelLabel = el.find('.panel-label');\n\n        var button = {\n          label: 'collapse',\n          icon: 'expand_less',\n          handler: toggleCollapse\n        };\n\n        return button;\n\n        function toggleCollapse() {\n          if (button.icon === 'expand_less') {\n            origSize.width = scope.vprops.width;\n            origSize.height = scope.vprops.height;\n            scope.vprops.width = panelLabel.outerWidth() + 1;\n            scope.vprops.height = panelLabel.outerHeight();\n            button.label = 'expand';\n            button.icon = 'expand_more';\n          } else {\n            scope.vprops.width = origSize.width;\n            scope.vprops.height = origSize.height;\n            button.label = 'collapse';\n            button.icon = 'expand_less';\n          }\n        }\n      }\n    }\n\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('volumePanel', volumePanelDirective);\n\n  /** @ngInject */\n  function volumePanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/work-panel/volume-panel.html',\n      scope: {\n        volume: '=',\n        workId: '@',\n        editionId: '@'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      scope.title = worksRepo.getTitle(scope.volume.titles);\n\n      scope.edition = worksRepo.getEdition(scope.workId, scope.editionId);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('editionPanel', editionPanelDirective);\n\n  /** @ngInject */\n  function editionPanelDirective(worksRepo) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/vwise/components/work-panel/edition-panel.html',\n      scope: {\n        edition: '=',\n        workId: '@'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      scope.title = worksRepo.getTitle(scope.edition.titles);\n\n      scope.edition.volumes.forEach(function (volume) {\n        volume.type = 'volume';\n        volume.workId = scope.workId;\n        volume.editionId = scope.edition.id;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('personPanel', personPanelDirective);\n\n  var NAME_KEYS = ['title', 'givenName', 'middleName', 'familyName', 'suffix'];\n\n  /** @ngInject */\n  function personPanelDirective(_) {\n    var directive = {\n      restrict: 'E',\n      require: '^^vwisePanel',\n      templateUrl: 'app/vwise/components/person-panel/person-panel.html',\n      scope: {\n        person: '=',\n        vprops: '='\n      },\n      link: linkFunc,\n      controller: PersonPanelController,\n      controllerAs: 'panel'\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attr, panel) {\n      panel.addActionButton(createExpandCollapseButton());\n\n      var name = scope.person.name;\n\n      scope.name = name.label || _.at(name, NAME_KEYS)\n        .map(function (n) { return n.trim(); })\n        .filter(_.identity)\n        .join(' ');\n\n      /**\n       * @return {object}\n       */\n      function createExpandCollapseButton() {\n        var origSize = {\n          width: scope.vprops.width,\n          height: scope.vprops.height\n        };\n\n        var panelLabel = el.find('.panel-label');\n\n        var button = {\n          label: 'collapse',\n          icon: 'expand_less',\n          handler: toggleCollapse\n        };\n\n        return button;\n\n        function toggleCollapse() {\n          if (button.icon === 'expand_less') {\n            origSize.width = scope.vprops.width;\n            origSize.height = scope.vprops.height;\n            scope.vprops.width = panelLabel.outerWidth() + 10;\n            scope.vprops.height = panelLabel.outerHeight();\n            button.label = 'expand';\n            button.icon = 'expand_more';\n          } else {\n            scope.vprops.width = origSize.width;\n            scope.vprops.height = origSize.height;\n            button.label = 'collapse';\n            button.icon = 'expand_less';\n          }\n        }\n      }\n    }\n\n    /** @ngInject */\n    function PersonPanelController($scope, $q, worksRepo, peopleRepo, relationshipsRepo) {\n      var vm = this;\n\n      vm.works = [];\n\n      activate();\n\n      function activate() {\n        var id = $scope.person.id;\n\n        var worksP = getWorksAuthored(id);\n        worksP.then(function (works) {\n          vm.works = works;\n        });\n\n        var relatedP = worksP.then(function (works) {\n          return getRelatedPeople(works);\n        });\n\n        relatedP.then(function (related) {\n          vm.relatedPeople = related;\n        });\n      }\n\n      function getWorksAuthored(authorId) {\n        var result = worksRepo.searchByAuthor(authorId);\n        return result.$promise.then(function () {\n          result.items.forEach(function (work) {\n            work.type = 'work';\n          });\n\n          return result.items;\n        });\n      }\n\n      function getRelatedPeople(works) {\n        // fetch relationships for all works\n        /** @type Promise.<TypeGroup[]>[] */\n        var relnsPs = works.map(function (work) {\n          return getRelationships(work.id);\n        });\n\n        // combine grouped relationships for all works into a single set of grouped relationships\n        /** @type Promise.<TypeGroup[]> */\n        var relnsP = $q.all(relnsPs).then(function (relnss) {\n          return _.chain(relnss)    // Stream.<TypeGroup[]>\n            .flatten()              // Stream.<TypeGroup>\n            .groupBy(function (group) {\n              return group.type.identifier + '-' + (group.reverse ? 'rev' : 'fwd');\n            })                      // Stream.<String, TypeGroup[]>\n            .map(function (groups) {\n              var group = _.clone(groups[0]);\n              group.relationships = _.flatMap(groups, 'relationships');\n              return group;\n            })                      // Stream.<TypeGroup>\n            .value();\n        });\n\n        // resolve related entities in all relationships to a set of authors\n        var relatedPeople = relnsP.then(function (groups) {\n          /** @type Promise.<TypeGroup>[] */\n          var groupPs = groups.map(function (group) {\n            /** @type Promise.<string[]>[] */\n            var authorIdsPs = _.chain(group.relationships)  // Stream.<NormalizedRelationship>\n            .flatMap('entities')                            // Stream.<Entity>\n            .map('entity')                                  // Stream.<Work|Edition|Volume>\n            .map(function (entity) {\n              return entity.$promise.then(function (entity) {\n                var authorIds = _.map(entity.authors, 'authorId');\n                return authorIds;\n              });\n            })                                              // Stream.<Promise.<string[]>>\n            .value();\n\n            /** @type Promise.<string[]> */\n            var authorIdsP = $q.all(authorIdsPs).then(function (authorIdss) {\n              return _.chain(authorIdss)\n                .flatten()\n                .filter()\n                .uniq()\n                .value();\n            });\n\n            /** @type Promise.<Person[]> */\n            group.relationships = authorIdsP.then(function (authorIds) {\n              /** @type Promise.<Person>[] */\n              var authorPs = authorIds.map(function (id) {\n                var author = peopleRepo.get(id);\n                author.$promise.then(function () {\n                  author.type = 'person';\n                });\n                return author.$promise;\n              });\n\n              return $q.all(authorPs);\n            });\n\n            return $q.all(group);\n          });\n\n          return $q.all(groupPs);\n        });\n\n        return relatedPeople;\n      }\n\n      /**\n       * Fetches relationships for the given work.\n       * @param  {string} workId\n       * @return {Promise.<TypeGroup[]>}\n       */\n      function getRelationships(workId) {\n        var uri = 'works/' + workId;\n        var result = relationshipsRepo.search(uri);\n\n        var normRelnsP = result.$promise.then(function (relns) {\n          var normRelns = relationshipsRepo.normalizeRelationships(relns, uri, worksRepo);\n          return normRelns.$promise;\n        });\n\n        return normRelnsP;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('worksContentMediator', worksContentMediatorFactory);\n\n  /** @ngInject */\n  function worksContentMediatorFactory($q, vwise, worksRepo, relationshipsRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'works', 'Works Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'work' && obj.id;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return $q.all({\n        id: obj.id,\n        work: loadWork(obj.id),\n        relationships: loadRelationships(obj.id)\n      });\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return $q.all({\n        id: dto.id,\n        work: loadWork(dto.id),\n        relationships: loadRelationships(dto.id)\n      });\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'work',\n        id: panelData.id\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<work-panel work=\"content.work\" relationships=\"content.relationships\" vprops=\"vprops\" flex layout=\"column\"></work-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadWork(id) {\n      var work = worksRepo.get(id);\n      return work.$promise;\n    }\n\n    function loadRelationships(workId) {\n      var currentUri = 'works/' + workId;\n      var results = relationshipsRepo.search(currentUri);\n      return results.$promise.then(function () {\n        var relationships = relationshipsRepo.normalizeRelationships(results, currentUri, worksRepo);\n        return relationships.$promise.then(function () {\n\n          relationships.forEach(function (group) {\n            group.relationships.forEach(function (reln) {\n              reln.entities.forEach(function (entity) {\n\n                entity.entity.$promise.then(function () {\n                  entity.title = worksRepo.getTitle(entity.entity.titles);\n                });\n\n                switch(entity.type) {\n                  case 'work':\n                    entity.id = entity.refParams.workId;\n                    break;\n                  case 'edition':\n                    entity.workId = entity.refParams.workId;\n                    entity.id = entity.refParams.editionId;\n                    break;\n                  case 'volume':\n                    entity.workId = entity.refParams.workId;\n                    entity.editionId = entity.refParams.editionId;\n                    entity.id = entity.refParams.volumeId;\n                    break;\n                }\n              });\n            });\n          });\n\n          return relationships;\n        });\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('volumesContentMediator', volumesContentMediatorFactory);\n\n  /** @ngInject */\n  function volumesContentMediatorFactory(vwise, worksRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'volumes', 'Volumes Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'volume' && obj.id && obj.workId && obj.editionId;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadVolume(obj.workId, obj.editionId, obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadVolume(dto.workId, dto.editionId, dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'volume',\n        id: panelData.id,\n        workId: panelData.workId,\n        editionId: panelData.editionId\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<volume-panel volume=\"content\" edition-id=\"{{content.editionId}}\" work-id=\"{{content.workId}}\" flex layout=\"column\"></volume-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadVolume(workId, editionId, volumeId) {\n      var volume = worksRepo.getVolume(workId, editionId, volumeId);\n      return volume.$promise.then(function () {\n        volume.workId = workId;\n        volume.editionId = editionId;\n        return volume;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('peopleContentMediator', peopleContentMediatorFactory);\n\n  /** @ngInject */\n  function peopleContentMediatorFactory(vwise, peopleRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'people', 'People Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'person' && obj.id;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadPerson(obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadPerson(dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'person',\n        id: panelData.id\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<person-panel person=\"content\" vprops=\"vprops\" flex layout=\"column\"></person-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadPerson(id) {\n      var person = peopleRepo.get(id);\n      return person.$promise;\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('passthruContentMediator', passthruContentMediatorFactory);\n\n  /** @ngInject */\n  function passthruContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'passthru', 'Pass-Through Debug Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches() {\n      return true;\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('panelContentMediatorRegistry', panelContentMediatorRegistryFactory);\n\n  /** @ngInject */\n  function panelContentMediatorRegistryFactory(vwise) {\n    return new vwise.PanelContentMediatorRegistry();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('noteContentMediator', noteContentMediatorFactory);\n\n  /** @ngInject */\n  function noteContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'notes', 'Note Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.hasOwnProperty('note');\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<div ng-model=\"content.note\" contenteditable flex></div>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('editionsContentMediator', editionsContentMediatorFactory);\n\n  /** @ngInject */\n  function editionsContentMediatorFactory(vwise, worksRepo) {\n\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'editions', 'Editions Content Mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'edition' && obj.id && obj.workId;\n    };\n\n    Mediator.prototype.initPanelData = function initPanelData(obj) {\n      return loadEdition(obj.workId, obj.id);\n    };\n\n    Mediator.prototype.unmarshall = function unmarshall(dto) {\n      return loadEdition(dto.workId, dto.id);\n    };\n\n    Mediator.prototype.marshall = function marshall(panelData) {\n      var dto = {\n        type: 'edition',\n        id: panelData.id,\n        workId: panelData.workId\n      };\n\n      return dto;\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<edition-panel edition=\"content\" work-id=\"{{content.workId}}\" flex layout=\"column\"></edition-panel>'\n    };\n\n    return new Mediator();\n\n\n    function loadEdition(workId, editionId) {\n      var edition = worksRepo.getEdition(workId, editionId);\n      return edition.$promise.then(function () {\n        edition.workId = workId;\n        return edition;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('internetArchiveContentMediator', internetArchiveContentMediatorFactory);\n\n  /** @ngInject */\n  function internetArchiveContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'ia-reader', 'Internet Archive Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'internetarchive';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<ia-reader properties=\"content.properties\" flex></ia-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('hathitrustContentMediator', hathitrustContentMediatorFactory);\n\n  /** @ngInject */\n  function hathitrustContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'ht-reader', 'HathiTrust Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'hathitrust';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<hathitrust-reader properties=\"content.properties\" flex></hathitrust-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .factory('googleBooksContentMediator', googleBooksContentMediatorFactory);\n\n  /** @ngInject */\n  function googleBooksContentMediatorFactory(vwise) {\n    function Mediator() {\n      vwise.PanelContentMediator.call(this, 'gb-reader', 'Google Books Digital Copy mediator');\n    }\n\n    Mediator.prototype = Object.create(vwise.PanelContentMediator.prototype);\n\n    Mediator.prototype.matches = function matches(obj) {\n      return obj.type && obj.type === 'googlebooks';\n    };\n\n    Mediator.prototype.getTemplate = function getTemplate() {\n      return '<google-book-reader properties=\"content.properties\" flex></google-book-reader>'\n    };\n\n    return new Mediator();\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('vwisePanel', vwisePanel);\n\n  /** @ngInject */\n  function vwisePanel($compile) {\n    var directive = {\n      restrict: 'E',\n      require: ['^^vwiseWorkspace', 'vwisePanel'],\n      templateUrl: 'app/vwise/components/panel/panel.html',\n      replace: true,\n      scope: {\n        panel: '='\n      },\n      link: linkFunc,\n      controller: PanelController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    function linkFunc($scope, $el, attr, controllers) {\n      // var workspaceController = controllers[0];\n      var panelController = controllers[1];\n\n      // define overridable content areas on controller\n      panelController.getInfoArea = function () {\n        return $el.find('.panel-area-left');\n      };\n\n      panelController.getStatusArea = function () {\n        return $el.find('.panel-area-bottom')\n      };\n\n      var panel = panelController.panel\n\n      // shorthand for use in template\n      $scope.vp = panel.vprops;\n\n      var panelScope = $scope.$new(true);\n      panelScope.content = panel.content;\n      panelScope.vprops = panel.vprops;\n\n      panelScope.$watch('vprops.background', function (color) {\n        var rgb = hextorgb(color);\n        panel.vprops.foreground = calculateForeground(rgb);\n      });\n\n      // NOTE: vprop updates are saved automatically when panel API is called.\n      //       content updates need to be saved manually since they are modified in-place.\n      panelScope.$watch('content', function () {\n        panel.save();\n      }, true);\n\n      var template = panel.contentMediator.getTemplate();\n\n      var contentArea = $el.find('.content');\n      contentArea.html(template);\n      $compile(contentArea.contents())(panelScope);\n    }\n  }\n\n  /** @ngInject */\n  function PanelController($scope) {\n    var vm = this;\n\n    vm.resizing = false;\n    vm.actionButtons = [];\n    vm.propertyButtons = [];\n    vm.panel = $scope.panel;\n\n    vm.addActionButton = addActionButton;\n    vm.addPropertyButton = addPropertyButton;\n    vm.closePanel = closePanel;\n    vm.startResize = startResize;\n    vm.resizePanel = resizePanel;\n    vm.stopResize = stopResize;\n    vm.movePanel = movePanel;\n    vm.stopMove = stopMove;\n    vm.activatePanel = activatePanel;\n\n    function addActionButton(spec) {\n      vm.actionButtons.push(spec);\n\n      return function () {\n        var ix = vm.actionButtons.indexOf(spec);\n        if (ix >= 0) {\n          vm.actionButtons.splice(ix, 1);\n        }\n      };\n    }\n\n    function addPropertyButton(spec) {\n      vm.propertyButtons.push(spec);\n\n      return function () {\n        var ix = vm.propertyButtons.indexOf(spec);\n        if (ix >= 0) {\n          vm.propertyButtons.splice(ix, 1);\n        }\n      };\n    }\n\n    function closePanel() {\n      vm.panel.remove();\n    }\n\n    function movePanel(evt, ui) {\n      vm.panel.vprops.xPosition = ui.position.left;\n      vm.panel.vprops.yPosition = Math.max(0, ui.position.top);\n    }\n\n    function stopMove(evt, ui) {\n      // TODO: jQuery UI supports 'containment' option...\n      var top = Math.max(0, ui.position.top);\n\n      vm.panel.setPosition(ui.position.left, top);\n      activatePanel();\n    }\n\n    function startResize() {\n      vm.resizing = true;\n    }\n\n    function resizePanel(evt, ui) {\n      var width = ui.position.left;\n      var height = ui.position.top;\n\n      $scope.$apply(function () {\n        vm.panel.vprops.width = Math.max(0, width);\n        vm.panel.vprops.height = Math.max(0, height);\n      });\n    }\n\n    function stopResize(evt, ui) {\n      vm.resizing = false;\n\n      var width = ui.position.left;\n      var height = ui.position.top;\n\n      $scope.$apply(function () {\n        vm.panel.setSize(Math.max(0, width), Math.max(0, height));\n      });\n    }\n\n    function activatePanel(evt) {\n      vm.panel.activate();\n\n      if (evt && evt.stopPropagation) {\n        evt.stopPropagation();\n      }\n    }\n  }\n\n  /**\n   * Convert a CSS hex color string to rgb percentage values\n   * @param  {string} hex\n   * @return {Object.<string, float>}\n   */\n  function hextorgb(hex) {\n    var match = hex.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);\n\n    if (!match) {\n      return;\n    }\n\n    return {\n      r: parseInt(match[1], 16) / 255,\n      g: parseInt(match[2], 16) / 255,\n      b: parseInt(match[3], 16) / 255\n    };\n  }\n\n  /**\n   * Calculate a good contrasting foreground color (black/white) given an rgb background color\n   * @param {Object.<string, float>} r, g, and b color percentage points\n   * @return {string} rgba foreground color spec\n   */\n  function calculateForeground(rgb) {\n    // Foreground calculation from http://stackoverflow.com/a/3943023\n\n    // calculate luminance coefficient\n    // see https://en.wikipedia.org/wiki/Luma_(video)#Rec._601_luma_versus_Rec._709_luma_coefficients\n    var r = (rgb.r <= 0.03928) ? rgb.r / 12.92 : Math.pow((rgb.r + 0.055) / 1.055, 2.4);\n    var g = (rgb.g <= 0.03928) ? rgb.g / 12.92 : Math.pow((rgb.g + 0.055) / 1.055, 2.4);\n    var b = (rgb.b <= 0.03928) ? rgb.b / 12.92 : Math.pow((rgb.b + 0.055) / 1.055, 2.4);\n\n    var lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;\n\n    // set contrast color based on W3C recommendations\n    // see https://www.w3.org/TR/WCAG20/\n\n    // panel.vprops.foreground = (lum > 0.179) ? '#000000' : '#ffffff';\n    // adjusted so that #808080 is the transition point between FG colors\n    return (lum > 0.215) ? 'rgba(0,0,0,0.87)' : 'rgba(255,255,255,0.87)';\n  }\n\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('vwise')\n      .directive('iaReader', iaReader);\n\n   /** @ngInject */\n   function iaReader($sce) {\n      var directive = {\n         restrict: 'E',\n         template: '<iframe ng-src=\"{{src}}\">',\n         replace: true,\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope) {\n        scope.$watch('properties', function(properties) {\n           // TODO add page link\n            //  <iframe class=\"reader flex\" src=\"https://archive.org/stream/essayinanswertom00adamiala?ui=embed#page/n5/mode/2up\" frameborder=\"0\"></iframe>\n           scope.src = $sce.trustAsResourceUrl('https://archive.org/stream/' + properties.id + '?ui=embed#mode/2up');\n        });\n      }\n   }\n\n})();\n\n(function () {\n   'use strict';\n\n   var READER_URL = 'https://babel.hathitrust.org/cgi/pt';\n\n   angular\n      .module('vwise')\n      .directive('hathitrustReader', hathitrustReader);\n\n   /** @ngInject */\n   function hathitrustReader($sce, _) {\n      var directive = {\n         restrict: 'E',\n         template: '<iframe ng-src=\"{{src}}\">',\n         replace: true,\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope) {\n         scope.$watch('properties', function (properties) {\n            var params = {\n               id: properties.htid,\n               ui: 'embed'\n            };\n\n            if (properties.seq) {\n               params.seq = properties.seq;\n            }\n\n            var queryString = _.map(params, function (value, key) {\n               return key + '=' + value;\n            }).join(';');\n\n            var url = READER_URL + '?' + queryString;\n\n            scope.src = $sce.trustAsResourceUrl(url);\n         });\n      }\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .directive('contenteditable', contenteditable);\n\n  /** @ngInject */\n  function contenteditable($sce) {\n    var directive = {\n      restrict: 'A',\n      require: '?ngModel',\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc($scope, $el, attrs, ngModel) {\n      if (!ngModel) {\n        return;\n      }\n\n      ngModel.$render = function () {\n        $el.html($sce.getTrustedHtml(ngModel.$viewValue || ''));\n      };\n\n      $el.on('blur keyup change', function () {\n        $scope.$apply(function () {\n          ngModel.$setViewValue($el.html());\n        });\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('workEditorItem', workEditorItemDirective);\n\n  /** @ngInject */\n  function workEditorItemDirective($log) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/task/components/work-editor-item/work-editor-item.html',\n      link: linkFunc,\n      scope: {\n        id: '=id'\n      },\n      controller: WorkEditorItemController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    function linkFunc($scope) {\n      if (!$scope.id) {\n        $log.error('missing required attribute \"id\"');\n      }\n    }\n\n    /** @ngInject */\n    function WorkEditorItemController($scope, worksRepo) {\n      var vm = this;\n\n      vm.loaded = false;\n\n      activate();\n\n      function activate() {\n        if ($scope.id) {\n          vm.work = worksRepo.get($scope.id);\n          vm.work.$promise.then(function () {\n            vm.loaded = true;\n          });\n        }\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('workEditor', workEditorDirective);\n\n  /** @ngInject */\n  function workEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/work-editor/work-editor.html',\n      scope: {\n        work: '=ngModel'\n      },\n      controller: WorkEditorController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    /** @ngInject */\n    function WorkEditorController($scope, worksRepo, _) {\n      var vm = this;\n\n      vm.editions = [];\n\n      vm.createEdition = createEdition;\n      vm.deleteEdition = deleteEdition;\n\n      activate();\n\n      function activate() {\n        $scope.work.editions.forEach(function (edition) {\n          vm.editions.push({\n            model: edition,\n            focused: false\n          });\n        });\n      }\n\n      function createEdition() {\n        var edition = worksRepo.createEdition();\n        edition.titles = _.cloneDeep($scope.work.titles);\n        edition.authors = _.cloneDeep($scope.work.authors);\n\n        $scope.work.editions.push(edition);\n        vm.editions.push({\n          model: edition,\n          focused: true\n        });\n      }\n\n      function deleteEdition(ix) {\n        vm.editions.splice(ix, 1);\n        $scope.work.editions.splice(ix, 1);\n      }\n    }\n  }\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('volumeEditor', volumeEditorDirective);\n\n  /** @ngInject */\n  function volumeEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/volume-editor/volume-editor.html',\n      scope: {\n        volume: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('editionEditor', editionEditorDirective);\n\n  /** @ngInject */\n  function editionEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/work/components/edition-editor/edition-editor.html',\n      scope: {\n        edition: '=ngModel'\n      },\n      controller: EditionEditorController,\n      controllerAs: 'vm'\n    };\n\n    return directive;\n\n    /** @ngInject */\n    function EditionEditorController($scope, worksRepo, _) {\n      var vm = this;\n\n      vm.volumes = [];\n\n      vm.createVolume = createVolume;\n      vm.deleteVolume = deleteVolume;\n\n      activate();\n\n      function activate() {\n        $scope.edition.volumes.forEach(function (volume) {\n          vm.volumes.push({\n            model: volume,\n            focused: false\n          });\n        });\n      }\n\n      function createVolume() {\n        var volume = worksRepo.createVolume();\n        volume.titles = _.cloneDeep($scope.edition.titles);\n        volume.authors = _.cloneDeep($scope.edition.authors);\n        volume.publicationInfo = _.cloneDeep($scope.edition.publicationInfo);\n\n        $scope.edition.volumes.push(volume);\n        vm.volumes.push({\n          model: volume,\n          focused: true\n        });\n      }\n\n      function deleteVolume(ix) {\n        vm.volumes.splice(ix, 1);\n        $scope.edition.volumes.splice(ix, 1);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('nameEditor', nameEditorDirective);\n\n  /** @ngInject */\n  function nameEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/person/components/name-editor/name-editor.html',\n      scope: {\n        name: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('eventEditor', eventEditorDirective);\n\n  /** @ngInject */\n  function eventEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/person/components/event-editor/event-editor.html',\n      scope: {\n        event: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('sdaAdminWeb')\n      .directive('treeCategorizationEditor', treeCategorizationEditor);\n\n   /** @ngInject */\n   function treeCategorizationEditor() {\n      var directive = {\n         restrict: 'E',\n         templateUrl: 'app/admin/editors/articles/thematic-overview.html',\n         scope: {\n           scopeId: \"@\",\n           scheme: \"@\"\n          //  need param to indicate whether this categorization owns related entrties\n         },\n         controller: TreeCategorizationController,\n         controllerAs: 'vm'\n      };\n\n      return directive;\n   }\n\n   // NOTE this needs to move toward being a more general puropose control\n\n   /** @ngInject */\n   function TreeCategorizationController($scope, $log, $mdDialog, $mdToast, $state, $q,\n     articlesRepo, categorizationService) {\n\n     var vm = this;\n     var repo = null;\n\n     // TODO need to allow actions to be pluggable\n     vm.handleAssociateEntry = handleAssociateEntry;\n     vm.handleRemoveEntry = handleRemoveEntry;\n     vm.handleCreateChild = handleCreateChild;\n     vm.handleDeleteNode = handleDeleteNode;\n\n     activate();\n\n     //'overviews'\n     function activate() {\n       $log.info(\"Loading article editor\", articlesRepo);\n       repo = categorizationService.getScopedRepo($scope.scopeId);\n       // TODO need to handle case when this fails to load. Display throbber pending load\n       vm.overviews = repo.get($scope.scheme);\n     }\n\n     // TODO allow edit labels\n\n     /* ================================\n      * API METHODS\n      * ================================ */\n      function handleAssociateEntry($event, node) {\n        $log.info(\"creating article\");\n        // TODO need to offer option of create or link\n        // TODO magic string\n\n        var type = \"overviews\";\n        var title = node.label;\n\n        // TODO  display prompt dialog, allow entry of title, selection of type (but not)\n        // TODO error handling!!\n        var article = articlesRepo.create(\"overviews\", title);\n        var articlePromise = articlesRepo.save(article);\n        var linkPromise = articlePromise.then(linkArticle);\n\n        $q.all({\n          article: articlePromise,\n          ref: linkPromise\n        }).then(openEditor);\n\n        function linkArticle(article) {\n          var ref = repo.nodes.link(node, article.reference);\n          return ref.$promise;\n        }\n\n        function openEditor(values) {\n          $state.go(\"article.edit\", {\n            id: values.article.id\n          });\n        }\n        // TODO creates article and (once created) associates\n        //      that article with this node in the hierarchy.\n        //      On completion, opens that article in the editor.\n      }\n\n      function handleRemoveEntry($event, node) {\n        $log.info(\"Removing entry\", node);\n\n\n        // TODO Prompts for confirmation to notify user that changes\n        //      cannot be reverted.\n        //      If OK, removes the associated entry from this node\n        //      and then deletes the article.\n\n      }\n\n      /**\n       * Handler to be invoked to create a new category with an hierarchical\n       * categorization.\n       *\n       * @param  {event} $event  The event that triggered this request.\n       * @param  {object} parent The parent node on which the child should be created.\n       * @return {[type]}        [description]\n       */\n      function handleCreateChild($event, parent) {\n        $log.info(parent);\n\n        var newCategoryDialog = $mdDialog.prompt({\n          title: \"Enter Category Label\",\n          // TODO add description\n          placeholder: 'new category',\n          ok: \"Create\",\n          cancel: \"Cancel\",\n          targetEvent: $event\n        });\n\n        $mdDialog.show(newCategoryDialog)\n                 .then(onCreate);\n\n        function onCreate(label) {\n          $log.info(\"Creating category \" + label);\n\n          repo.nodes.create(parent, label);\n        }\n      }\n\n      function handleDeleteNode($event, node, parent) {\n        $log.info(node);\n\n        var title = \"Delete category '\" + node.label + \"'\";\n        var msg = \"<p>This will delete the selected category, \" + node.label + \", \" +\n                  \"its sub-categories and all associated articles.\" +\n                  \"<em>This action cannot be undone.</em></p>\" +\n                  \"<p>Permanently delete this category?</p>\";\n        var removeCatgorizationDialog = $mdDialog.confirm({\n          title: title,\n          htmlContent: msg,\n          ok: \"Delete\",\n          cancel: \"Cancel\",\n          targetEvent: $event\n        });\n\n        $mdDialog.show(removeCatgorizationDialog).then(function() {\n           // TODO dispaly success/failure toasts\n           repo.nodes.remove(node, true, parent).then(function () {\n             return 'category deleted';\n           }, function () {\n             return 'unable to delete category';\n           })\n           .then(function (msg) {\n             $mdToast.showSimple(msg);\n           });\n         });\n\n\n        function deleteNode() {\n        }\n\n        // TODO Prompts for confirmation to notify user that changes\n        //      cannot be reverted.\n        //      Recursively removes all articles associated with descendants\n        //      Removes this categorization entry (and children)\n      }\n\n      /* ================================\n       * PRIVATE METHODS\n       * ================================ */\n\n       function getChildren(node) {\n         if (node.childIds.length != node.chilren.length) {\n           throw new Error(\"Lazy loading of children not yet supported.\");\n         }\n\n         return $q.when(node.chilren);\n       }\n\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n// TODO admin-page-articles\n  angular\n    .module('sdaAdminWeb')\n    .controller('ArticleEditorSectionController', ArticleEditorSectionController);\n\n  /** @ngInject */\n  function ArticleEditorSectionController(articlesRepo, $log, categorizationService) {\n    var vm = this;\n    //\n    // vm.handleAssociateEntry = handleAssociateEntry;\n    // vm.handleRemoveEntry = handleRemoveEntry;\n    // vm.handleCreateChild = handleCreateChild;\n    // vm.handleDeleteNode = handleDeleteNode;\n\n    activate();\n\n    function activate() {\n      $log.info(\"Loading article editor\", articlesRepo);\n      // var repo = categorizationService.getScopedRepo('default');\n      // vm.overviews = repo.get('overviews');\n\n      /* initialization logic here */\n    }\n\n    /* ================================\n     * API METHODS\n     * ================================ */\n\n    //  function handleAssociateEntry($event) {\n    //    $log(\"creating article\");\n     //\n    //  }\n     //\n    //  function handleRemoveEntry($event, node) {\n    //    $log.info(node);\n    //  }\n    //  function handleCreateChild($event, node) {\n    //    $log.info(node);\n    //  }\n    //  function handleDeleteNode($event, node) {\n    //    $log.info(node);\n    //  }\n    /* ================================\n     * PRIVATE METHODS\n     * ================================ */\n  }\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ArticleEditorController', ArticleEditorController);\n\n  var CKEDITOR_CONFIG = {\n    toolbarGroups: [\n      { name: 'styles', groups: [ 'styles' ] },\n      { name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ] },\n      { name: 'paragraph', groups: [ 'list', 'indent', 'blocks', 'align', 'bidi', 'paragraph' ] },\n      { name: 'colors', groups: [ 'colors' ] },\n      { name: 'links', groups: [ 'links' ] },\n      { name: 'insert', groups: [ 'insert' ] },\n      { name: 'clipboard', groups: [ 'clipboard', 'undo' ] },\n      { name: 'forms', groups: [ 'forms' ] },\n      { name: 'editing', groups: [ 'find', 'selection', 'spellchecker', 'editing' ] },\n      { name: 'tools', groups: [ 'tools' ] },\n      { name: 'document', groups: [ 'mode', 'document', 'doctools' ] },\n      { name: 'others', groups: [ 'others' ] },\n    ],\n\n    // See http://docs.ckeditor.com/#!/api/CKEDITOR.config-cfg-format_tags\n    format_tags: 'p;h1;h2;h3;h4;h5;h6;pre;address',\n\n    extraPlugins: 'mathjax',\n\n    mathJaxLib: '//cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-MML-AM_CHTML'\n  };\n\n  /** @ngInject */\n  function ArticleEditorController($q, $log, $stateParams, $scope, $mdBottomSheet, articlesRepo, refsRepoFactory) {\n    var refsRepoUrl = articlesRepo.getReferencesEndpoint($stateParams.id);\n    var refsRepo = refsRepoFactory.getRepo(refsRepoUrl);\n\n    var vm = this;\n\n    vm.save = save;\n    vm.cancel = cancel;\n    vm.body = \"test\";\n\n    vm.abstractEditor = {\n      config: angular.extend({}, CKEDITOR_CONFIG, {\n        removeButtons: [\n          'Styles',\n          'Format',\n          'Subscript',\n          'Superscript',\n          'Cut',\n          'Copy',\n          'HorizontalRule',\n          'Maximize',\n          'Source'\n        ].join(',')\n      })\n    };\n\n    vm.editor = {\n      config: angular.extend({}, CKEDITOR_CONFIG, {\n        removeButtons: [\n          'Styles',\n          'Subscript',\n          'Superscript',\n          'Cut',\n          'Copy',\n          'Source'\n        ].join(',')\n      })\n    };\n\n    vm.editFootnote = editFootnote;\n\n    activate();\n\n    function activate() {\n      $log.info(\"Loading article editor\", articlesRepo)\n\n      vm.article = articlesRepo.get($stateParams.id);\n      vm.references = refsRepo.get();\n\n      $q.all([vm.article.$promise, vm.references.$promise]).then(function () {\n        // start watching for opportunities to remove unused citations and footnotes\n        $scope.$watch('vm.article.body', cleanArticleHandler);\n        $scope.$watchCollection('vm.article.footnotes', cleanRefsHandler);\n      });\n\n      /* initialization logic here */\n    }\n\n    /* ================================\n     * API METHODS\n     * ================================ */\n     function save() {\n        articlesRepo.save(vm.article);\n        refsRepo.save(vm.references);\n     }\n\n     function cancel() {\n       alert('cancel');\n     }\n\n     /**\n      * Displays a bottom sheet to edit an existing footnote.\n      * Delegates to the edit dialog in ckeditor-footnotes component, which should probably be refactored elsewhere.\n      * @param  {MouseEvent} $event\n      * @param  {Footnote} footnote\n      */\n     function editFootnote($event, footnote) {\n       var newFootnote = angular.copy(footnote);\n       var newReferences = refsRepoFactory.createRefCollection();\n\n       var config = {\n         templateUrl: 'app/components/ckeditor-footnotes/footnote-edit-dialog.html',\n         controller: 'FootnoteEditDialogController',\n         controllerAs: 'vm',\n         clickOutsideToClose: false,\n         locals: {\n           footnote: newFootnote,\n           references: newReferences\n         }\n       };\n\n       var promise = $mdBottomSheet.show(config);\n\n       promise.then(function () {\n         vm.article.footnotes[newFootnote.id] = newFootnote;\n\n         // update bibliography\n         var updatedReferences = refsRepoFactory.merge(vm.references, refsRepoFactory.compact(newReferences));\n         angular.merge(vm.references, updatedReferences);\n       });\n     }\n\n    /* ================================\n     * PRIVATE METHODS\n     * ================================ */\n\n     function cleanRefsHandler(obj) {\n       if (!obj) {\n         return;\n       }\n\n       articlesRepo.cleanReferences(vm.article, vm.references);\n       vm.references = refsRepo.compact(vm.references);\n     }\n\n     function cleanArticleHandler(obj) {\n       if (!obj) {\n         return;\n       }\n\n       articlesRepo.cleanFootnotes(vm.article, vm.article.footnotes);\n       cleanRefsHandler(obj);\n     }\n  }\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('zotero', [\n      'ngAnimate',\n      'ngAria',\n      'ngMaterial',\n      'ngResource'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('zotero')\n    .controller('ZoteroTestController', ZoteroTestController);\n\n  /** @ngInject */\n  function ZoteroTestController() {\n    var vm = this;\n\n    vm.item = {};\n\n    vm.types = [];\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcCore', [\n      'ngResource'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcCore')\n    .provider('categorizationService', categorizationRepoProvider);\n\n  var Strategies = {\n    set: \"set\",\n    list: \"list\",\n    tree: \"hierarchical\"\n  };\n\n  function categorizationRepoProvider() {\n    var provider = {};\n    provider.url = '/api/categorizations';\n    provider.$get = categorizationRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function categorizationRepoFactory($q, $resource, $http) {\n      var repo = {\n        getScopedRepo: getScopedRepo\n      };\n\n      var schemesResource = $resource(provider.url + '/:scopeId/:key', {\n        key: '@key'\n      });\n      var nodeResource = $resource(provider.url + '/:scopeId/:schemeId/nodes/:nodeId', {\n        schemeId: '@schemeId',\n        nodeId: '@nodeId'\n      });\n      var nodeChilrenResource = $resource(provider.url + '/:scopeId/:schemeId/nodes/:nodeId/children', {\n        schemeId: '@schemeId',\n        nodeId: '@nodeId'\n      });\n      var associatedEntryResource = $resource(provider.url + '/:scopeId/:schemeId/nodes/:nodeId/entryRef', {\n        schemeId: '@schemeId',\n        nodeId: '@nodeId'\n      }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n\n      // REPO API DEFN goes here\n      return repo;\n\n      function getScopedRepo(scopeId) {\n        return new ScopedRepository(scopeId);\n      }\n\n      /**\n       * Creates a new ScopedRepository.\n       *\n       * @param {string} scopeId The scope id that will be used by this\n       *                         repository\n       * @constructor\n       * @classdesc The primary API for working with categorizations. Categorizations\n       * are defined relative to a scope id.\n       *\n       * TODO explain why here.\n       */\n      function ScopedRepository(scopeId) {\n\n        this.get = getCategorization;\n        this.create = createCategorization;\n        this.remove = removeCategorization;\n\n        this.nodes = {\n          get: getNode,\n          getChildren: getNodeChildren,\n\n          create: createNode,\n          move: moveNode,\n          remove: removeNode,\n          update: updateNode,\n          link: linkEntry,\n          unlink: unlinkEntry\n        };\n\n        /* ================================\n         * ScopedRepository API METHODS\n         * ================================ */\n\n        function getCategorization(key) {\n          // HACK: load from local file. Note that this does not match the eventual behavior of the resource-backed API\n          // return $http.get('app/trc-core/categorizations/overviews.json').then(function(response) { return response.data; });\n          return schemesResource.get({scopeId: scopeId, key: key });\n        }\n\n        function createCategorization(key, label, description, type) {\n          // TODO convert to object\n          // TODO VERIFY KEY, check uniqueness\n          var data = {\n            key: key,\n            label: label,\n            description: description,\n            type: type\n          }\n        }\n\n        function removeCategorization(key) {\n\n        }\n\n        function getNode(schemeId, nodeId) {\n\n        }\n\n        function getNodeChildren(node) {\n\n        }\n\n        function createNode(parent, label, description) {\n          var options = {\n            scopeId: scopeId,\n            schemeId: parent.schemeId,\n            nodeId: parent.id\n          };\n           var data = {\n            label: label,\n            description: description\n          };\n\n          var result = nodeChilrenResource.save(options, data);\n          result.$promise.then(function(node) {\n            parent.childIds.push(node.id);\n            parent.children.push(node);\n          });\n\n          return result;\n        }\n\n\n        /**\n         * [removeNode description]\n         * @param  {[type]} node       [description]\n         * @param  {boolean} removeRefs [description]\n         * @return {[type]}            [description]\n         */\n        function removeNode(node, removeRefs, parent) {\n          var result = nodeResource.delete({\n            scopeId: scopeId,\n            schemeId: node.schemeId,\n            nodeId: node.id,\n            remove_refs: !!removeRefs\n          });\n\n          if (parent) {\n            // remove child from parent node\n            result.$promise.then(function () {\n              var ix = parent.children.indexOf(node)\n              if (ix >= 0) {\n                parent.children.splice(ix, 1);\n              }\n            });\n          }\n\n          return result.$promise;\n        }\n        function moveNode() {\n\n        }\n\n\n        function updateNode() {\n\n        }\n\n        function linkEntry(node, entryRef) {\n          var params = {\n            scopeId: scopeId,\n            schemeId: node.schemeId,\n            nodeId: node.id\n          };\n\n          var result = associatedEntryResource.update(params, entryRef);\n          result.$promise.then(function(ref) {\n            node.entryRef = ref;\n          });\n\n          return result;\n        }\n\n        function unlinkEntry() {\n          var params = {\n            scopeId: scopeId,\n            schemeId: node.schemeId,\n            nodeId: node.id\n          };\n\n          var result = associatedEntryResource.delete(params);\n          result.$promise.then(function() {\n            node.entryRef = null;\n          });\n\n          return result;\n        }\n\n      }\n    }\n  }\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('summaryEditor', summaryEditorDirective);\n\n  /** @ngInject */\n  function summaryEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/components/summary-editor/summary-editor.html',\n      scope: {\n        summary: '=ngModel'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      scope.config = {\n        // FIXME set up minimal toolbar and restrict HTML content\n        toolbarGroups: [\n          { name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ] },\n          { name: 'paragraph', groups: [ 'list', 'indent', 'blocks', 'align', 'bidi', 'paragraph' ] },\n          { name: 'links', groups: [ 'links' ] },\n          { name: 'editing', groups: [ 'find', 'selection', 'spellchecker', 'editing' ] }\n        ],\n\n        removeButtons: 'Subscript,Superscript,About,Cut,Copy,Maximize,Styles'\n      };\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('SummaryEditDialogController', SummaryEditDialogController);\n\n  /** @ngInject */\n  function SummaryEditDialogController($mdDialog, summary) {\n    var vm = this;\n\n    vm.summary = summary;\n\n    vm.close = close;\n    vm.cancel = cancel;\n\n    function close() {\n      $mdDialog.hide(vm.summary);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .filter('stripTags', stripTagsFilter);\n\n  function stripTagsFilter() {\n    return stripTags;\n  }\n\n  function stripTags(html) {\n    return html ? String(html).replace(/<[^>]+>/gm, '') : '';\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .component('navbar', {\n      templateUrl: 'app/components/navbar/navbar.html',\n      bindings: {\n        title: '@',\n        sidenavId: '@?'\n      },\n      controller: NavbarController\n    });\n\n  /** @ngInject */\n  function NavbarController($mdSidenav) {\n    var vm = this;\n\n    vm.toggleSidenav = toggleSidenav;\n\n    activate();\n\n    function activate() {\n\n    }\n\n    function toggleSidenav(id) {\n      $mdSidenav(id).toggle();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  /**\n  * Formats ranked by precedence to check for when parsing date strings.\n  *\n  * NOTE: dashes can be any number of non-alphanumeric characters, so 'DD-MM-YYYY' parses\n  *       '02/02/2015', '02.02.2015', '02:02,2015', and '02*#!02   ^^^2015' into '02-02-2015'\n  *\n  * @type {Array}\n  */\n  var INFER_FORMATS = [\n    // year\n    'YYYY',             // e.g. 2015\n\n    // month year\n    'MMMM-YYYY',        // e.g. February 2015\n    'MMM-YYYY',         // e.g. Feb. 2015\n    'MM-YYYY',          // e.g. 02/2015\n    'M-YYYY',           // e.g. 2/2015\n\n    // year month\n    'YYYY-MMMM',        // e.g. 2015 February\n    'YYYY-MMM',         // e.g. 2015 Feb.\n    'YYYY-MM',          // e.g. 2015-02\n    'YYYY-M',           // e.g. 2015-2\n\n    // month day year\n    'MMMM-DD-YYYY',     // e.g. February 02, 2015\n    'MMM-DD-YYYY',      // e.g. Feb. 02, 2015\n    'MM-DD-YYYY',       // e.g. 02/02/2015\n    'M-DD-YYYY',        // e.g. 2/02/2015\n    'MMMM-D-YYYY',      // e.g. February 2, 2015\n    'MMM-D-YYYY',       // e.g. Feb. 2, 2015\n    'MM-D-YYYY',        // e.g. 02-2-2015\n    'M-D-YYYY',         // e.g. 2/2/2015\n\n    // day month year\n    'DD-MMMM-YYYY',     // e.g. 02 February 2015\n    'DD-MMM-YYYY',      // e.g. 02 Feb. 2015\n    'DD-MM-YYYY',       // e.g. 02/02/2015\n    'DD-M-YYYY',        // e.g. 02/2/2015\n    'D-MMMM-YYYY',      // e.g. 2 February 2015\n    'D-MMM-YYYY',       // e.g. 2 Feb. 2015\n    'D-MM-YYYY',        // e.g. 2/02/2015\n    'D-M-YYYY',         // e.g. 2/2/2015\n\n    // year month day\n    'YYYY-MM-DD',       // e.g. 2015-02-02\n    'YYYY-M-D'          // e.g. 2015-2-2\n  ];\n\n  angular\n    .module('sdaAdminWeb')\n    .factory('guessDate', guessDateFactory);\n\n  /** @ngInject */\n  function guessDateFactory(moment) {\n    return guessDate;\n\n    /**\n     * Parse a date string into a Moment.\n     *\n     * See moment.js\n     *\n     * @param  {string} str Date string to parse\n     * @return {Moment}     Parsed moment\n     */\n    function guessDate(str) {\n        return moment(str, INFER_FORMATS);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('dateEditor', dateEditorDirective);\n\n  /** @ngInject */\n  function dateEditorDirective(guessDate) {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/components/date-editor/date-editor.html',\n      scope: {\n        date: '=ngModel'\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope) {\n      // indicates whether the current value in the date.calendar field was automatically set\n      scope.calendarAutoSet = false;\n\n      scope.$watch('date.description', function (dateDescription) {\n        if (dateDescription && (!scope.date.calendar || scope.calendarAutoSet)) {\n          scope.date.calendar = guessDate(dateDescription).format('YYYY-MM-DD');\n          scope.calendarAutoSet = true;\n        }\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('DataContainerController', DataContainerController);\n\n\n  /** @ngInject */\n  function DataContainerController() {\n    var vm = this;\n    var listeners = [];\n\n    vm.watch = watch;\n    vm.set = set;\n    vm.value = null;\n\n    /**\n     * Attach a listener to watch for value changes\n     * @param  {Function} fn listener callback\n     * @return {Function} unregister function\n     */\n    function watch(fn) {\n      listeners.push(fn);\n      fn(vm.value);\n      return unregister;\n\n      function unregister() {\n        var ix = listeners.indexOf(fn);\n        if (ix >= 0) {\n          listeners.splice(ix, 1);\n        }\n      }\n    }\n\n    /**\n     * Updates internal value\n     * @param {*} newValue\n     */\n    function set(newValue) {\n      if (vm.value === newValue) {\n        return;\n      }\n\n      vm.value = newValue;\n\n      listeners.forEach(function (fn) {\n        fn(newValue);\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('FootnoteEditDialogController', FootnoteEditDialogController);\n\n  /** @ngInject */\n  function FootnoteEditDialogController($mdBottomSheet, footnote, references) {\n    var vm = this;\n\n    vm.footnote = footnote;\n    vm.references = references;\n\n    vm.done = done;\n    vm.cancel = cancel;\n\n    function done() {\n      $mdBottomSheet.hide();\n    }\n\n    function cancel() {\n      $mdBottomSheet.cancel();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('ckeditorFootnotes', ckeditorFootnotesDirective);\n\n  /** @ngInject */\n  function ckeditorFootnotesDirective($document, $mdBottomSheet, articlesRepo, refsRepoFactory) {\n    var directive = {\n      restrict: 'A',\n      require: ['ckeditor', 'ckeditorFootnotes', '?ckeditorBibliography'],\n      link: linkFunc,\n      controller: 'DataContainerController'\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attrs, requires) {\n      var anchorIdPrefix = attrs.ckeditorFootnotesAnchorIdPrefix || 'fn_anchor_';\n\n      var ckeditor = requires[0];\n      var ctrl = requires[1];\n      var ckeditorBibliography = requires[2];\n\n      var editor = ckeditor.instance;\n\n      var scopeValueExpr = attrs.ckeditorFootnotes;\n\n      // capture footnotes reference from outer scope\n      ctrl.set(scope.$eval(scopeValueExpr));\n\n      // keep internal reference up-to-date\n      scope.$watch(scopeValueExpr, function (footnotes) {\n        if (ctrl.value !== footnotes) {\n          ctrl.set(footnotes);\n        }\n      });\n\n      var FOOTNOTE_COMMAND_NAME = 'insertFootnote';\n      editor.addCommand(FOOTNOTE_COMMAND_NAME, {\n        async: true,\n        allowedContent: 'sup[id,data-footnote,contenteditable](footnote)',\n        requiredContent: 'sup[id,data-footnote,contenteditable](footnote)',\n        exec: insertFootnoteCommand\n      });\n\n      editor.ui.addButton('Footnote', {\n        label: 'Insert Footnote',\n        command: FOOTNOTE_COMMAND_NAME,\n        toolbar: 'insert'\n      });\n\n      function insertFootnoteCommand(editor) {\n        var command = this;\n\n        // create a new footnote object to edit.\n        var newFootnote = articlesRepo.createFootnote();\n        newFootnote.backlinkId = anchorIdPrefix + newFootnote.id;\n\n        var newReferences = ckeditorBibliography ? refsRepoFactory.createRefCollection() : null;\n\n        var config = {\n          templateUrl: 'app/components/ckeditor-footnotes/footnote-edit-dialog.html',\n          controller: 'FootnoteEditDialogController',\n          controllerAs: 'vm',\n          clickOutsideToClose: false,\n          locals: {\n            footnote: newFootnote,\n            references: newReferences\n          }\n        };\n\n        var promise = $mdBottomSheet.show(config);\n\n        promise.then(function () {\n          ctrl.value[newFootnote.id] = newFootnote;\n\n          // update bibliography if provided\n          if (newReferences && ckeditorBibliography) {\n            var updatedReferences = refsRepoFactory.merge(ckeditorBibliography.value, refsRepoFactory.compact(newReferences));\n            angular.merge(ckeditorBibliography.value, updatedReferences);\n          }\n\n          editor.insertHtml('<sup contenteditable=\"false\" class=\"footnote\" id=\"' + newFootnote.backlinkId + '\" data-footnote=\"' + newFootnote.id + '\">#</a>');\n          done();\n        }, function () {\n          done();\n        });\n\n        function done() {\n          editor.fire('afterCommandExec', {\n            name: FOOTNOTE_COMMAND_NAME,\n            command: command\n          });\n        }\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('ckeditorBibliography', ckeditorBibliographyDirective);\n\n  /** @ngInject */\n  function ckeditorBibliographyDirective($mdDialog, $document, refsRepoFactory, refsRenderer, citationEditDialog) {\n    var directive = {\n      restrict: 'A',\n      require: ['ckeditor', 'ckeditorBibliography'],\n      link: linkFunc,\n      controller: 'DataContainerController'\n    };\n\n    return directive;\n\n    function linkFunc(scope, el, attrs, requires) {\n      var ckeditor = requires[0];\n      var ctrl = requires[1];\n\n      var editor = ckeditor.instance;\n\n      var scopeValueExpr = attrs.ckeditorBibliography;\n\n      // capture bibliography reference from outer scope\n      ctrl.set(scope.$eval(scopeValueExpr));\n\n      // keep internal reference up-to-date\n      scope.$watch(scopeValueExpr, function (refs) {\n        if (ctrl.value !== refs) {\n          ctrl.set(refs);\n        }\n      });\n\n      var CITATION_COMMAND_NAME = 'insertCitation';\n      editor.addCommand(CITATION_COMMAND_NAME, {\n        async: true,\n        allowedContent: 'cite[id,contenteditable]',\n        requiredContent: 'cite[id,contenteditable]',\n        exec: insertCitationCommand\n      });\n\n      editor.ui.addButton('Citation', {\n        label: 'Insert Citation',\n        command: CITATION_COMMAND_NAME,\n        toolbar: 'insert'\n      });\n\n      function insertCitationCommand(editor) {\n        var command = this;\n\n        // create citation object with its own ref collection for editing\n        var newReference = refsRepoFactory.createRefCollection();\n        var citation = refsRepoFactory.createCitation();\n        newReference.citations[citation.id] = citation;\n\n        citationEditDialog.show(newReference).then(function () {\n          var updatedReferences = refsRepoFactory.merge(ctrl.value, refsRepoFactory.compact(newReference));\n          angular.merge(ctrl.value, updatedReferences);\n\n          refsRenderer.render('modern-language-association', newReference).then(function (rendered) {\n            var label = rendered.citations[citation.id];\n            editor.insertHtml('<cite id=\"' + citation.id + '\" contenteditable=\"false\">' + label + '</cite>')\n            done();\n          });\n        }, function () {\n          done();\n        });\n\n        function done() {\n          editor.fire('afterCommandExec', {\n            name: CITATION_COMMAND_NAME,\n            command: command\n          });\n        }\n      }\n    }\n  }\n\n})();\n\n/**\n * @typedef ItemContainer\n * @type {object}\n * @property {string} id\n * @property {string} label\n * @property {BiblioItem} item\n */\n\n(function () {\n  'use strict';\n\n  var LOCATOR_TYPES = [\n    'book', 'chapter', 'column', 'figure', 'folio', 'issue', 'line', 'note', 'opus', 'page',\n    'paragraph', 'part', 'section', 'sub verbo', 'verse', 'volume'\n  ];\n\n  var ZOTERO_USER_ACCOUNT_ID = '2536190';\n  var ZOTERO_USER_ACCOUNT_API_KEY = '3A4q05BNg0h0bHKJkpoCi1Oa';\n  var ZOTERO_GROUP_ID = '381134';\n\n  angular\n    .module('sdaAdminWeb')\n    .component('citationEditor', {\n      templateUrl: 'app/components/citation-edit-dialog/citation-editor.html',\n      controller: CitationEditorController,\n      bindings: {\n        references: '=',\n        citation: '='\n      }\n    });\n\n  /** @ngInject */\n  function CitationEditorController($filter, $q, $log, $mdDialog, zotero, _, refsRepoFactory, refsRenderer) {\n    var vm = this;\n\n    // referenced item autocomplete models\n    vm.selectedBiblioItem = null;\n    vm.searchText = '';\n\n    vm.locatorTypes = LOCATOR_TYPES;\n\n    vm.activeCitationItem = {};\n\n    vm.groupLibraryP = null;\n\n    vm.zoteroItem = null\n\n    vm.search = search;\n    vm.addCitationItem = addCitationItem;\n    vm.selectBiblioItem = selectBiblioItem;\n    vm.edit = editCitationItem;\n    vm.createZoteroItem = createZoteroItem;\n    vm.cancelZoteroItem = cancelZoteroItem;\n    vm.saveZoteroItem = saveZoteroItem;\n\n    var stripTags = $filter('stripTags');\n\n    activate();\n\n    function activate() {\n      var account = zotero.getUserAccount(ZOTERO_USER_ACCOUNT_ID, ZOTERO_USER_ACCOUNT_API_KEY);\n\n      // account.getGroup and account.getLibrary return native Promises.\n      // we wrap them in $q promises for consistency\n      var groupP = $q.when(account.getGroup(ZOTERO_GROUP_ID));\n      vm.groupLibraryP = groupP.then(function (group) {\n        return $q.when(account.getLibrary(group));\n      });\n\n      if (!vm.citation) {\n        throw new Error('no citation provided');\n      }\n\n      if (!vm.references.citations[vm.citation.id]) {\n        $log.warn('Citation is not a member of the provided reference collection. Adding to collection...');\n        vm.references.citations[vm.citation.id] = vm.citation;\n      } else if (vm.references.citations[vm.citation.id] !== vm.citation) {\n        $log.warn('provided citation does not match citation in reference collection. Overriding...');\n        vm.references.citations[vm.citation.id] = vm.citation;\n      }\n    }\n\n    /**\n     * Provides autocomplete items\n     * @param  {string} query\n     * @return {Promise.<ItemContainer[]>}\n     */\n    function search(query) {\n      return vm.groupLibraryP.then(function (library) {\n        // library.searchItems returns a native Promise.\n        // we wrap that in a $q promise for consistency\n        var resultsP = $q.when(library.searchItems(query))\n        return resultsP.then(function (items) {\n          return $q.all(items.map(adaptItem).map(wrapItem));\n        });\n      });\n    }\n\n    /**\n     * Adapts a ZoteroItem for use in the autocomplete field and citation metadata\n     * @param  {ZoteroItem} zItem\n     * @return {BiblioItem}\n     */\n    function adaptItem(zItem) {\n      var id = 'zotero/' + zItem.library.id + '/' + zItem.id;\n\n      var item = refsRepoFactory.createBiblioItem(id);\n      item.type = zItem.type;\n      item.creators = zItem.properties.creators.map(adaptCreator);\n\n      // NOTE: this omits a lot of metadata fields... need to decide what other metadata (if any) to keep.\n\n      item.meta = angular.extend(\n        _.pick(zItem.meta, ['creatorSummary', 'parsedDate']),\n        _.pick(zItem.properties, ['key', 'dateAdded', 'dateModified'])\n      );\n\n      item.fields = _.omit(zItem.properties, [\n        // these properties are extracted to the top-level item\n        'creators', 'itemType',\n        // these properties are extracted to metadata\n        'key', 'dateAdded', 'dateModified',\n        // these properties are just forgotten\n        'version', 'collections', 'tags', 'relations'\n      ]);\n\n      return item;\n    }\n\n    /**\n     * Adapts a Zotero creator for use in the BiblioItem TRC-local type\n     * @param  {ZoteraCreator}\n     * @return {Creator}\n     */\n    function adaptCreator(zCreator) {\n      return {\n        role: zCreator.creatorType,\n        firstName: zCreator.firstName,\n        lastName: zCreator.lastName,\n        name: zCreator.name\n      };\n    }\n\n    /**\n     * Wraps a BiblioItem for use in the autocomplete field and citation metadata\n     * @param  {BiblioItem} item\n     * @return {Promise.<ItemContainer>}\n     */\n    function wrapItem(item) {\n      var labelP = refsRenderer.renderBiblioItem('modern-language-association', item);\n\n      return labelP.then(function (label) {\n        return {\n          id: item.id,\n          label: label,\n          item: item\n        };\n      });\n    }\n\n    /**\n     * Appends the given citation item to the citation\n     * @return {CitationItem}\n     */\n    function addCitationItem(citationItem) {\n      if (vm.citation.items.indexOf(citationItem) < 0) {\n        // new item\n        vm.citation.items.push(citationItem);\n      } else {\n        // edited existing item in-place\n      }\n\n      // set/update label\n      var referencedBibItem = vm.references.bibliography[citationItem.id];\n      renderCitationItemLabel(citationItem, referencedBibItem).then(function (label) {\n        citationItem.label = label;\n      });\n\n      // clear active item and start editing a new one\n      clearForm();\n    }\n\n    /**\n     * Sets the current citation item's referent id to the given item's id and\n     * adds the given item to the bibliography\n     * @param {ItemContainer} itemContainer\n     */\n    function selectBiblioItem(itemContainer) {\n      if (itemContainer) {\n        vm.activeCitationItem.id = itemContainer.id;\n        vm.references.bibliography[itemContainer.id] = itemContainer.item;\n      } else {\n        vm.activeCitationItem.id = null;\n      }\n    }\n\n    /**\n     * Sets the given citation item as the item being actively edited\n     * @param {CitationItem} item\n     */\n    function editCitationItem(citationItem) {\n      var biblioItem = vm.references.bibliography[citationItem.id];\n      return wrapItem(biblioItem).then(function (biblioItemContainer) {\n        vm.activeCitationItem = citationItem;\n        vm.selectedBiblioItem = biblioItemContainer;\n        vm.searchText = stripTags(vm.selectedBiblioItem.label);\n      });\n    }\n\n    /**\n     * Resets the model behind the citation item form\n     */\n    function clearForm() {\n      vm.activeCitationItem = {};\n      vm.searchText = '';\n      vm.selectedBiblioItem = null;\n    }\n\n    /**\n     * Renders a label for a single citation item\n     * @praam {CitationItem} citationItem\n     * @param {ZoteroItem} biblioItem Corresponding bibliographic item\n     * @return {Promise.<string>}\n     */\n    function renderCitationItemLabel(citationItem, biblioItem) {\n      // create a singleton citation for the citation item\n      var citation = refsRepoFactory.createCitation();\n      citation.items.push(citationItem);\n\n      // create a singleton reference for the singleton citation\n      var reference = refsRepoFactory.createRefCollection();\n      reference.citations[citation.id] = citation;\n      reference.bibliography[citationItem.id] = biblioItem;\n\n      var renderedP = refsRenderer.render('modern-language-association', reference);\n\n      return renderedP.then(function (rendered) {\n        return rendered.citations[citation.id];\n      });\n    }\n\n    function createZoteroItem() {\n      vm.zoteroItem = {};\n    }\n\n    function cancelZoteroItem() {\n      vm.zoteroItem = null;\n    }\n\n    function saveZoteroItem($event, item) {\n      var zItemP = vm.groupLibraryP.then(function (library) {\n        // library.saveItem returns a native Promise.\n        // we wrap that in a $q promise for consistency\n        return $q.when(library.saveItem(item));\n      });\n\n      var biblioItemP = zItemP.then(adaptItem);\n\n      var itemContainerP = biblioItemP.then(wrapItem);\n\n      itemContainerP.then(function (item) {\n        vm.selectedBiblioItem = item;\n        selectBiblioItem(item);\n        vm.searchText = stripTags(item.label);\n        vm.zoteroItem = null;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .factory('citationEditDialog', CitationEditDialogFactory);\n\n  /** @ngInject */\n  function CitationEditDialogFactory($mdDialog, _, refsRepoFactory) {\n    return {\n      show: show\n    };\n\n    /**\n     * Displays the edit dialog.\n     * @param  {ReferenceCollection} references\n     * @param  {Citation} [citation]\n     * @param  {MouseEvent} [$event]\n     * @return {Promise.<ReferenceCollection>}\n     */\n    function show(references, citation, $event) {\n      if (!citation) {\n        var citations = _.values(references.citations);\n\n        if (citations.length === 0) {\n          citation = refsRepoFactory.createCitation();\n          references.citations[citation.id] = citation;\n        } else {\n          citation = citations[0];\n        }\n      } else if (angular.isString(citation)) {\n        citation = references.citations[citation];\n      }\n\n      if (!citation) {\n        throw new Error('Unable to find a suitable citation. Please pass one explicitly or check that the reference collection is not malformed');\n      }\n\n      var config = {\n        targetEvent: $event,\n        templateUrl: 'app/components/citation-edit-dialog/citation-edit-dialog.html',\n        controller: 'CitationEditDialogController',\n        controllerAs: 'vm',\n        clickOutsideToClose: false,\n        locals: {\n          references: references,\n          citation: citation\n        }\n      };\n\n      return $mdDialog.show(config).then(function () {\n        return references;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('CitationEditDialogController', CitationEditDialogController);\n\n  /** @ngInject */\n  function CitationEditDialogController($mdDialog, references, citation) {\n    var vm = this;\n\n    vm.references = references;\n    vm.citation = citation;\n\n    vm.done = done;\n    vm.cancel = cancel;\n\n    function done() {\n      $mdDialog.hide();\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .directive('bibliography', bibliographyDirective);\n\n  function bibliographyDirective(refsRenderer) {\n    var directive = {\n      restrict: 'E',\n      scope: {\n        collection: '='\n      },\n      link: linkFunc\n    };\n\n    return directive;\n\n    function linkFunc(scope, el) {\n      scope.$watch('collection', watcher, true);\n\n      function watcher(obj) {\n        if (!obj) {\n          return;\n        }\n\n        refsRenderer.render('modern-language-association', scope.collection).then(function (rendered) {\n          el.html(rendered.bibliography.html);\n        });\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ShowWorkController', ShowWorkController);\n\n  /** @ngInject */\n  function ShowWorkController($state, $stateParams, worksRepo, relationshipsRepo, refsRepoFactory, $mdDialog, $mdToast, $q, $timeout, citationEditDialog) {\n    var refsRepo = null;\n    var vm = this;\n\n    vm.loading = true;\n    vm.work = null;\n    vm.title = null;\n    vm.relationships = null;\n\n    vm.editBibInfo = editBibInfo;\n    vm.editSummary = editSummary;\n    vm.editBibliography = editBibliography;\n    vm.addEdition = addEdition;\n    vm.deleteEdition = deleteEdition;\n    vm.addCopy = addCopy;\n    vm.editCopy = editCopy;\n    vm.deleteCopy = deleteCopy;\n    vm.openRelationship = openRelationship;\n    vm.addRelationship = addRelationship;\n    vm.deleteRelationship = deleteRelationship;\n    vm.deleteWork = deleteWork;\n\n    activate();\n\n    function activate() {\n      var workId = $stateParams.workId;\n\n      vm.work = worksRepo.get(workId);\n\n      vm.work.$promise.then(function () {\n        vm.bcTitle = worksRepo.getTitle(vm.work.titles, ['short', 'canonical', 'bibliographic']);\n        vm.title = worksRepo.getTitle(vm.work.titles, ['canonical', 'bibliographic', 'short']);\n      });\n\n      var relationshipsPromise = loadRelationships();\n\n      var refsEndpointUrl = worksRepo.getReferencesEndpoint(workId);\n      refsRepo = refsRepoFactory.getRepo(refsEndpointUrl);\n      vm.references = refsRepo.get();\n\n      $q.all([vm.work.$promise, relationshipsPromise, vm.references.$promise]).then(function () {\n        vm.loading = false;\n      });\n    }\n\n    function getCurrentUri() {\n      var workId = $stateParams.workId;\n      return 'works/' + workId;\n    }\n\n    function loadRelationships() {\n      vm.relationships = [];\n      var currentUri = getCurrentUri();\n      var relationships = relationshipsRepo.search(currentUri);\n      return relationships.$promise.then(function () {\n        vm.relationships = relationshipsRepo.normalizeRelationships(relationships, currentUri, worksRepo);\n      });\n    }\n\n    function editBibInfo($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/work-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          work: angular.copy(vm.work)\n        },\n        controller: 'WorkEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedWork) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        angular.extend(vm.work, updatedWork);\n\n        worksRepo.saveWork(vm.work).then(showSavedToast);\n      });\n    }\n\n    function editSummary($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/components/summary-edit-dialog/summary-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation (even if it is just a string)\n          summary: angular.copy(vm.work.summary)\n        },\n        controller: 'SummaryEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedSummary) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        vm.work.summary = updatedSummary;\n\n        worksRepo.saveWork(vm.work).then(showSavedToast);\n      });\n    }\n\n    function editBibliography($event) {\n      citationEditDialog.show(vm.references, null, $event).then(function () {\n        refsRepo.save(vm.references).then(showSavedToast);\n      });\n    }\n\n    function addEdition($event) {\n      var prompt = $mdDialog.prompt()\n        .targetEvent($event)\n        .title('Create Edition')\n        .textContent('Please provide a name for the new edition.')\n        .placeholder('edition name')\n        .ok('Create')\n        .cancel('Cancel');\n\n      var dialogPromise = $mdDialog.show(prompt);\n\n      var savePromise = dialogPromise.then(function (editionName) {\n        var edition = worksRepo.createEdition();\n        edition.editionName = editionName;\n        edition.titles = angular.copy(vm.work.titles);\n        edition.authors = angular.copy(vm.work.authors);\n\n        vm.work.editions.push(edition);\n\n        // resolve to the created edition when save is successful\n        return worksRepo.saveEdition(vm.work.id, edition);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function (edition) {\n        $state.go('editor.edition', { workId: vm.work.id, editionId: edition.id });\n      });\n    }\n\n    function deleteEdition(edition, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this edition?')\n        .ok('Yes')\n        .cancel('No');\n\n      $mdDialog.show(confirm)\n        .then(function () {\n          var ix = vm.work.editions.indexOf(edition);\n          if (ix >= 0) {\n            vm.work.editions.splice(ix, 1);\n            worksRepo.saveWork(vm.work).then(showSavedToast);\n          }\n        });\n    }\n\n    function addCopy($event) {\n      var copy = {};\n      editCopy(copy, $event).then(function () {\n        vm.work.copies.push(copy);\n      });\n    }\n\n    function editCopy(copy, $event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/copy-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          copy: angular.copy(copy)\n        },\n        controller: 'CopyEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedCopy) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(copy, updatedCopy);\n\n        worksRepo.saveWork(vm.work).then(showSavedToast);\n      });\n\n      return dialogPromise;\n    }\n\n    function deleteCopy(copy, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this copy?')\n        .ok('Yes')\n        .cancel('No');\n\n      $mdDialog.show(confirm)\n        .then(function () {\n          var ix = vm.work.copies.indexOf(copy);\n          if (ix >= 0) {\n            vm.work.copies.splice(ix, 1);\n            worksRepo.saveWork(vm.work).then(showSavedToast);\n          }\n        });\n    }\n\n    function openRelationship(relationship) {\n      // HACK just working with first entity\n      var entity = relationship.entities[0];\n      $state.go('editor.' + entity.type, entity.refParams);\n    }\n\n    function addRelationship($event) {\n      var relationship = relationshipsRepo.createRelationship();\n\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/relationship-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          relationship: angular.copy(relationship),\n          currentUri: getCurrentUri()\n        },\n        controller: 'RelationshipEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      var savePromise = dialogPromise.then(function (updatedRelationship) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(relationship, updatedRelationship);\n\n        return relationshipsRepo.save(relationship);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function () {\n        // HACK give relationship a chance to save on the server\n        $timeout(loadRelationships, 1000);\n      });\n\n    }\n\n    function deleteRelationship(relationship, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this relationship?')\n        .ok('Yes')\n        .cancel('No');\n\n      var confirmPromise = $mdDialog.show(confirm);\n      var deletePromise = confirmPromise.then(function () {\n        return relationshipsRepo.delete(relationship.id);\n      });\n\n      deletePromise.then(showSavedToast);\n\n      deletePromise.then(function () {\n        // HACK give relationship a chance to be deleted from the server\n        $timeout(loadRelationships, 1000);\n      });\n    }\n\n    function deleteWork($event, work) {\n      var title = worksRepo.getTitle(vm.work.titles);\n      var workLabel = title ? '\"' + title.title + (title.subtitle ? ': ' + title.subtitle : '') + '\"' : 'this work';\n\n      var confirmDialog = $mdDialog.confirm({\n        targetEvent: $event,\n        title: 'Confirm Deletion',\n        textContent: 'Are you sure you want to delete ' + workLabel + '?',\n        ok: 'Yes',\n        cancel: 'No'\n      });\n\n      var confirmPromise = $mdDialog.show(confirmDialog);\n\n      return confirmPromise.then(function () {\n        return worksRepo.delete(work)\n          .then(showSuccessToast, showErrorToast);\n      });\n\n      function showSuccessToast() {\n        var message = workLabel + ' has been deleted.';\n        var toast = $mdToast.simple()\n          .textContent(message)\n          .position('bottom right');\n\n        $state.go('editor');\n\n        return $mdToast.show(toast);\n      }\n\n      function showErrorToast() {\n        var toast = $mdToast.simple()\n          .textContent('Unable to delete ' + workLabel)\n          .position('bottom right');\n\n        return $mdToast.show(toast);\n      }\n    }\n\n    function showSavedToast() {\n      var toast = $mdToast.simple()\n        .textContent('Saved')\n        .position('bottom right');\n\n      return $mdToast.show(toast);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('WorkEditDialogController', WorkEditDialogController);\n\n  /** @ngInject */\n  function WorkEditDialogController($mdDialog, work) {\n    var vm = this;\n\n    vm.work = work;\n\n    vm.close = close;\n    vm.cancel = cancel;\n    vm.addAuthor = addAuthor;\n    vm.deleteAuthor = deleteAuthor;\n    vm.addTitle = addTitle;\n    vm.deleteTitle = deleteTitle;\n\n    function close() {\n      $mdDialog.hide(vm.work);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n\n    function addAuthor(field) {\n      // TODO delegate creation to worksRepo\n      var authorRef = {};\n      vm.work[field].push(authorRef);\n    }\n\n    function deleteAuthor(field, authorRef) {\n      var ix = vm.work[field].indexOf(authorRef);\n      if (ix >= 0) {\n        vm.work[field].splice(ix, 1);\n      }\n    }\n\n    function addTitle() {\n      // TODO delegate creation to worksRepo\n      var title = {};\n      vm.work.titles.push(title);\n    }\n\n    function deleteTitle(title) {\n      var ix = vm.work.titles.indexOf(title);\n      if (ix >= 0) {\n        vm.work.titles.splice(ix, 1);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ShowVolumeController', ShowVolumeController);\n\n  /** @ngInject */\n  function ShowVolumeController($state, $stateParams, worksRepo, relationshipsRepo, _, $mdDialog, $mdToast, $q, $timeout) {\n    var vm = this;\n\n    vm.loading = true;\n    vm.work = null;\n    vm.workTitle = null;\n    vm.edition = null;\n    vm.volume = null;\n    vm.title = null;\n\n    vm.editBibInfo = editBibInfo;\n    vm.editSummary = editSummary;\n    vm.addCopy = addCopy;\n    vm.editCopy = editCopy;\n    vm.deleteCopy = deleteCopy;\n    vm.copyToEdition = copyToEdition;\n    vm.openRelationship = openRelationship;\n    vm.addRelationship = addRelationship;\n    vm.deleteRelationship = deleteRelationship;\n\n    activate();\n\n    function activate() {\n      var workId = $stateParams.workId\n      var editionId = $stateParams.editionId;\n      var volumeId = $stateParams.volumeId;\n\n      vm.work = worksRepo.getWork(workId);\n      vm.edition = worksRepo.getEdition(workId, editionId);\n      vm.volume = worksRepo.getVolume(workId, editionId, volumeId);\n\n      vm.work.$promise.then(function () {\n        vm.workTitle = worksRepo.getTitle(vm.work.titles, ['short', 'canonical', 'bibliographic']);\n      });\n\n      vm.volume.$promise.then(function () {\n        vm.title = worksRepo.getTitle(vm.volume.titles, ['canonical', 'bibliographic', 'short']);\n      });\n\n      var relationshipsPromise = loadRelationships();\n\n      $q.all([vm.work.$promise, vm.edition.$promise, vm.volume.$promise, relationshipsPromise]).then(function () {\n        vm.loading = false;\n      });\n    }\n\n    function getCurrentUri() {\n      var workId = $stateParams.workId;\n      var editionId = $stateParams.editionId;\n      var volumeId = $stateParams.volumeId;\n      return 'works/' + workId + '/editions/' + editionId + '/volumes/' + volumeId;\n    }\n\n    function loadRelationships() {\n\n      vm.relationships = [];\n      var currentUri = getCurrentUri();\n      var relationships = relationshipsRepo.search(currentUri);\n      relationships.$promise.then(function () {\n        vm.relationships = relationshipsRepo.normalizeRelationships(relationships, currentUri, worksRepo);\n      });\n    }\n\n    function editBibInfo($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/volume-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          volume: angular.copy(vm.volume)\n        },\n        controller: 'VolumeEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedVolume) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        angular.extend(vm.volume, updatedVolume);\n\n        worksRepo.saveVolume(vm.work.id, vm.edition.id, vm.volume).then(showSavedToast);\n      });\n\n      return dialogPromise;\n    }\n\n    function editSummary($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/components/summary-edit-dialog/summary-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation (even if it is just a string)\n          summary: angular.copy(vm.volume.summary)\n        },\n        controller: 'SummaryEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedSummary) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        vm.volume.summary = updatedSummary;\n\n        worksRepo.saveVolume(vm.work.id, vm.edition.id, vm.volume).then(showSavedToast);\n      });\n    }\n\n    function addCopy($event) {\n      var copy = {};\n      editCopy(copy, $event).then(function () {\n        vm.volume.copies.push(copy);\n      });\n    }\n\n    function editCopy(copy, $event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/copy-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          copy: angular.copy(copy)\n        },\n        controller: 'CopyEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedCopy) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(copy, updatedCopy);\n\n        worksRepo.saveVolume(vm.work.id, vm.edition.id, vm.volume).then(showSavedToast);\n      });\n\n      return dialogPromise;\n    }\n\n    function deleteCopy(copy, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this copy?')\n        .ok('Yes')\n        .cancel('No');\n\n      $mdDialog.show(confirm)\n        .then(function () {\n          var ix = vm.volume.copies.indexOf(copy);\n          if (ix >= 0) {\n            vm.volume.copies.splice(ix, 1);\n            worksRepo.saveVolume(vm.work.id, vm.edition.id, vm.volume).then(showSavedToast);\n          }\n        });\n    }\n\n    function copyToEdition(origCopy) {\n      var newCopy = angular.copy(origCopy);\n      newCopy.id = null;\n\n      // HACK: make sure we have an up-to-date copy of the edition before updating it\n      var edition = worksRepo.getEdition(vm.work.id, vm.edition.id);\n      edition.$promise.then(function () {\n        edition.copies.push(newCopy);\n        return worksRepo.saveEdition(vm.work.id, edition);\n      }).then(showSavedToast);\n    }\n\n    function openRelationship(relationship) {\n      // HACK just working with first entity\n      var entity = relationship.entities[0];\n      $state.go('editor.' + entity.type, entity.refParams);\n    }\n\n    function addRelationship($event) {\n      var relationship = relationshipsRepo.createRelationship();\n\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/relationship-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          relationship: angular.copy(relationship),\n          currentUri: getCurrentUri()\n        },\n        controller: 'RelationshipEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      var savePromise = dialogPromise.then(function (updatedRelationship) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(relationship, updatedRelationship);\n\n        return relationshipsRepo.save(relationship);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function () {\n        // HACK give relationships a chance to save on the server\n        $timeout(loadRelationships, 1000);\n      });\n    }\n\n    function deleteRelationship(relationship, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this relationship?')\n        .ok('Yes')\n        .cancel('No');\n\n      var confirmPromise = $mdDialog.show(confirm);\n      var deletePromise = confirmPromise.then(function () {\n        return relationshipsRepo.delete(relationship.id);\n      });\n\n      deletePromise.then(showSavedToast);\n\n      deletePromise.then(function () {\n        // HACK give relationships a chance to save on the server\n        $timeout(loadRelationships, 1000);\n      });\n    }\n\n    function showSavedToast() {\n      var toast = $mdToast.simple()\n        .textContent('Saved')\n        .position('bottom right');\n\n      return $mdToast.show(toast);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('VolumeEditDialogController', VolumeEditDialogController);\n\n  /** @ngInject */\n  function VolumeEditDialogController($mdDialog, volume) {\n    var vm = this;\n\n    vm.volume = volume;\n\n    vm.close = close;\n    vm.cancel = cancel;\n    vm.addAuthor = addAuthor;\n    vm.deleteAuthor = deleteAuthor;\n    vm.addTitle = addTitle;\n    vm.deleteTitle = deleteTitle;\n\n    function close() {\n      $mdDialog.hide(vm.volume);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n\n    function addAuthor(field) {\n      // TODO delegate creation to worksRepo\n      var authorRef = {};\n      vm.volume[field].push(authorRef);\n    }\n\n    function deleteAuthor(field, authorRef) {\n      var ix = vm.volume[field].indexOf(authorRef);\n      if (ix >= 0) {\n        vm.volume[field].splice(ix, 1);\n      }\n    }\n\n    function addTitle() {\n      // TODO delegate creation to worksRepo\n      var title = {};\n      vm.volume.titles.push(title);\n    }\n\n    function deleteTitle(title) {\n      var ix = vm.volume.titles.indexOf(title);\n      if (ix >= 0) {\n        vm.volume.titles.splice(ix, 1);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('RelationshipEditDialogController', RelationshipEditDialogController);\n\n  /** @ngInject */\n  function RelationshipEditDialogController($mdDialog, worksRepo, relationshipsRepo, currentUri, relationship) {\n    var vm = this;\n\n    vm.relationship = relationship;\n    vm.types = [];\n    vm.selectedType = null;\n    vm.targets = [];\n    vm.selectedTarget = null;\n    vm.searchText = '';\n    vm.isReverse = false;\n\n    vm.getResults = getResults;\n    vm.selectWork = selectWork;\n    vm.setType = setType;\n    vm.setTarget = setTarget;\n    vm.close = close;\n    vm.cancel = cancel;\n\n    activate();\n\n    function activate() {\n      vm.types = getTypes();\n\n      vm.target = relationshipsRepo.createAnchor();\n      vm.relationship.targetEntities = [vm.target];\n\n      var self = relationshipsRepo.createAnchor();\n      self.entryUris = [currentUri];\n      vm.relationship.relatedEntities = [self];\n\n      vm.relationship.descriptionMimeType = 'text/html';\n    }\n\n    function getTypes() {\n      var rawTypes = relationshipsRepo.getTypes();\n      var types = [];\n\n      Object.defineProperty(types, '$promise', {\n        value: rawTypes.$promise\n      });\n\n      rawTypes.$promise.then(function () {\n        angular.forEach(rawTypes, function (type) {\n          types.push({\n            id: type.identifier,\n            label: type.title,\n            reverse: false\n          });\n\n          if (type.isDirected) {\n            types.push({\n              id: type.identifier,\n              label: type.reverseTitle,\n              reverse: true\n            });\n          }\n        });\n      });\n\n      return types;\n    }\n\n    function getResults(query) {\n      var results = worksRepo.search(query);\n      return results.$promise.then(function () {\n        return results.items;\n      });\n    }\n\n    function setType(type) {\n      vm.relationship.typeId = type.id;\n      if (vm.isReverse && !type.reverse || !vm.isReverse && type.reverse) {\n        var swap = vm.relationship.relatedEntities;\n        vm.relationship.relatedEntities = vm.relationship.targetEntities;\n        vm.relationship.targetEntities = swap;\n      }\n      vm.isReverse = type.reverse;\n    }\n\n    function selectWork(workProxy) {\n      vm.targets = [];\n\n      if (!workProxy) {\n        return;\n      }\n\n      var work = worksRepo.getWork(workProxy.id);\n\n      work.$promise.then(function () {\n        var workUri = 'works/' + work.id;\n        var workTitle = worksRepo.getTitle(work.titles, ['short', 'canonical', 'bibliographic']);\n\n        vm.targets.push({\n          uri: workUri,\n          label: workTitle.title + (workTitle.subtitle ? ': ' + workTitle.subtitle : '')\n        });\n\n        work.editions.forEach(function (edition) {\n          var editionUri = workUri + '/editions/' + edition.id;\n          var editionTitle = worksRepo.getTitle(edition.titles, ['short', 'canonical', 'bibliographic']);\n\n          vm.targets.push({\n            uri: editionUri,\n            label: editionTitle.title + (editionTitle.subtitle ? ': ' + editionTitle.subtitle : '') + '. ' + edition.editionName\n          });\n\n          edition.volumes.forEach(function (volume) {\n            var volumeUri = editionUri + '/volumes/' + volume.id;\n            var volumeTitle = worksRepo.getTitle(volume.titles, ['short', 'canonical', 'bibliographic']);\n\n            vm.targets.push({\n              uri: volumeUri,\n              label: volumeTitle.title + (volumeTitle.subtitle ? ': ' + volumeTitle.subtitle : '') + '. ' + edition.editionName + '. Volume ' + volume.volumeNumber\n            });\n          });\n        });\n\n        vm.selectedTarget = vm.targets[0];\n        setTarget(vm.selectedTarget);\n      });\n    }\n\n    function setTarget(target) {\n      vm.target.entryUris = target && target.uri ? [target.uri] : [];\n    }\n\n    function close() {\n      $mdDialog.hide(vm.relationship);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ShowEditionController', ShowEditionController);\n\n  /** @ngInject */\n  function ShowEditionController($state, $stateParams, worksRepo, relationshipsRepo, _, $mdDialog, $mdToast, $q, $timeout) {\n    var vm = this;\n\n    vm.loading = true;\n    vm.work = null;\n    vm.workTitle = null;\n    vm.edition = null;\n    vm.title = null;\n\n    vm.editBibInfo = editBibInfo;\n    vm.editSummary = editSummary;\n    vm.addVolume = addVolume;\n    vm.deleteVolume = deleteVolume;\n    vm.addCopy = addCopy;\n    vm.editCopy = editCopy;\n    vm.deleteCopy = deleteCopy;\n    vm.copyToWork = copyToWork;\n    vm.openRelationship = openRelationship;\n    vm.addRelationship = addRelationship;\n    vm.deleteRelationship = deleteRelationship;\n\n    activate();\n\n    function activate() {\n      var workId = $stateParams.workId;\n      var editionId = $stateParams.editionId;\n\n      vm.work = worksRepo.getWork(workId);\n      vm.edition = worksRepo.getEdition(workId, editionId);\n\n      vm.work.$promise.then(function () {\n        vm.workTitle = worksRepo.getTitle(vm.work.titles, ['short', 'canonical', 'bibliographic']);\n      });\n\n      vm.edition.$promise.then(function () {\n        vm.title = worksRepo.getTitle(vm.edition.titles, ['canonical', 'bibliographic', 'short']);\n      });\n\n      var relationshipsPromise = loadRelationships();\n\n      $q.all([vm.work.$promise, vm.edition.$promise, relationshipsPromise]).then(function (){\n        vm.loading = false;\n      });\n    }\n\n    function getCurrentUri() {\n      var workId = $stateParams.workId;\n      var editionId = $stateParams.editionId;\n\n      return 'works/' + workId + '/editions/' + editionId;\n    }\n\n    function loadRelationships() {\n\n      vm.relationships = [];\n      var currentUri = getCurrentUri();\n      var relationships = relationshipsRepo.search(currentUri);\n      relationships.$promise.then(function () {\n        vm.relationships = relationshipsRepo.normalizeRelationships(relationships, currentUri, worksRepo);\n      });\n    }\n\n    function editBibInfo($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/edition-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          edition: angular.copy(vm.edition)\n        },\n        controller: 'EditionEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedEdition) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        angular.extend(vm.edition, updatedEdition);\n\n        worksRepo.saveEdition(vm.work.id, vm.edition).then(showSavedToast);\n      });\n\n      return dialogPromise;\n    }\n\n    function editSummary($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/components/summary-edit-dialog/summary-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation (even if it is just a string)\n          summary: angular.copy(vm.edition.summary)\n        },\n        controller: 'SummaryEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedSummary) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        vm.edition.summary = updatedSummary;\n\n        worksRepo.saveEdition(vm.work.id, vm.edition).then(showSavedToast);\n      });\n    }\n\n    function addVolume($event) {\n      var prompt = $mdDialog.prompt()\n        .targetEvent($event)\n        .title('Create Volume')\n        .textContent('Please provide a number for the new volume.')\n        .placeholder('volume number')\n        .ok('Create')\n        .cancel('Cancel');\n\n      var dialogPromise = $mdDialog.show(prompt);\n\n      var savePromise = dialogPromise.then(function (volumeNumber) {\n        var volume = worksRepo.createVolume();\n        volume.volumeNumber = volumeNumber;\n        volume.titles = angular.copy(vm.edition.titles);\n        volume.authors = angular.copy(vm.edition.authors);\n        volume.publicationInfo = angular.copy(vm.edition.publicationInfo);\n\n        vm.edition.volumes.push(volume);\n\n        return worksRepo.saveVolume(vm.work.id, vm.edition.id, volume);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function (volume) {\n        $state.go('editor.volume', { workId: vm.work.id, editionId: vm.edition.id, volumeId: volume.id });\n      });\n    }\n\n    function deleteVolume(volume, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this volume?')\n        .ok('Yes')\n        .cancel('No');\n\n      $mdDialog.show(confirm)\n        .then(function () {\n          var ix = vm.edition.volumes.indexOf(volume);\n          if (ix >= 0) {\n            vm.edition.volumes.splice(ix, 1);\n            worksRepo.saveEdition(vm.work.id, vm.edition).then(showSavedToast);\n          }\n        });\n    }\n\n    function addCopy($event) {\n      var copy = {};\n      editCopy(copy, $event).then(function () {\n        vm.edition.copies.push(copy);\n      });\n    }\n\n    function editCopy(copy, $event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/copy-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          copy: angular.copy(copy)\n        },\n        controller: 'CopyEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedCopy) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(copy, updatedCopy);\n\n        worksRepo.saveEdition(vm.work.id, vm.edition).then(showSavedToast);\n      });\n\n      return dialogPromise;\n    }\n\n    function deleteCopy(copy, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this copy?')\n        .ok('Yes')\n        .cancel('No');\n\n      $mdDialog.show(confirm)\n        .then(function () {\n          var ix = vm.edition.copies.indexOf(copy);\n          if (ix >= 0) {\n            vm.edition.copies.splice(ix, 1);\n            worksRepo.saveEdition(vm.work.id, vm.edition).then(showSavedToast);\n          }\n        });\n    }\n\n    function copyToWork(origCopy) {\n      var newCopy = angular.copy(origCopy);\n      newCopy.id = null;\n\n      // HACK: make sure we have an up-to-date copy of the edition before updating it\n      var work = worksRepo.getWork(vm.work.id);\n      work.$promise.then(function () {\n        work.copies.push(newCopy);\n        return worksRepo.saveWork(work);\n      }).then(showSavedToast);\n    }\n\n    function openRelationship(relationship) {\n      // HACK just working with first entity\n      var entity = relationship.entities[0];\n      $state.go('editor.' + entity.type, entity.refParams);\n    }\n\n    function addRelationship($event) {\n      var relationship = relationshipsRepo.createRelationship();\n\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/relationship-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          relationship: angular.copy(relationship),\n          currentUri: getCurrentUri()\n        },\n        controller: 'RelationshipEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      var savePromise = dialogPromise.then(function (updatedRelationship) {\n        // copy updates back to original only after dialog is positively dismised (i.e. not canceled)\n        angular.extend(relationship, updatedRelationship);\n\n        return relationshipsRepo.save(relationship);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function () {\n        // HACK give relationships a chance to save on the server\n        $timeout(loadRelationships, 1000);\n      });\n    }\n\n    function deleteRelationship(relationship, $event) {\n      var confirm = $mdDialog.confirm()\n        .targetEvent($event)\n        .title('Confirm Deletion')\n        .textContent('Are you sure you want to delete this relationship?')\n        .ok('Yes')\n        .cancel('No');\n\n      var confirmPromise = $mdDialog.show(confirm);\n      var deletePromise = confirmPromise.then(function () {\n        return relationshipsRepo.delete(relationship.id);\n      });\n\n      deletePromise.then(showSavedToast);\n\n      deletePromise.then(function () {\n        // HACK give relationships a chance to save on the server\n        $timeout(loadRelationships, 1000);\n      });\n    }\n\n    function showSavedToast() {\n      var toast = $mdToast.simple()\n        .textContent('Saved')\n        .position('bottom right');\n\n      return $mdToast.show(toast);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('EditionEditDialogController', EditionEditDialogController);\n\n  /** @ngInject */\n  function EditionEditDialogController($mdDialog, edition) {\n    var vm = this;\n\n    vm.edition = edition;\n\n    vm.close = close;\n    vm.cancel = cancel;\n    vm.addAuthor = addAuthor;\n    vm.deleteAuthor = deleteAuthor;\n    vm.addTitle = addTitle;\n    vm.deleteTitle = deleteTitle;\n\n    function close() {\n      $mdDialog.hide(vm.edition);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n\n    function addAuthor(field) {\n      // TODO delegate creation to worksRepo\n      var authorRef = {};\n      vm.edition[field].push(authorRef);\n    }\n\n    function deleteAuthor(field, authorRef) {\n      var ix = vm.edition[field].indexOf(authorRef);\n      if (ix >= 0) {\n        vm.edition[field].splice(ix, 1);\n      }\n    }\n\n    function addTitle() {\n      // TODO delegate creation to worksRepo\n      var title = {};\n      vm.edition.titles.push(title);\n    }\n\n    function deleteTitle(title) {\n      var ix = vm.edition.titles.indexOf(title);\n      if (ix >= 0) {\n        vm.edition.titles.splice(ix, 1);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('CopyEditDialogController', CopyEditDialogController);\n\n  /** @ngInject */\n  function CopyEditDialogController($mdDialog, copy) {\n    var vm = this;\n\n    vm.copy = copy;\n\n    vm.close = close;\n    vm.cancel = cancel;\n\n    function close() {\n      $mdDialog.hide(vm.copy);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('zotero')\n    .component('zoteroEditor', {\n      templateUrl: 'app/zotero/editor.html',\n      controller: ZoteroEditorController,\n      bindings: {\n        item: '=',\n        typeFilter: '<types'\n      }\n    });\n\n  /** @ngInject */\n  function ZoteroEditorController(zotero) {\n    var vm = this;\n\n    vm.itemTypeSearchText = '';\n    vm.itemType = null;\n\n    vm.types = [];\n    vm.fields = [];\n    vm.roles = [];\n\n    vm.selectType = selectType;\n\n    activate();\n\n    function activate() {\n      zotero.getItemTypes().then(function (types) {\n        vm.types = (vm.typeFilter && vm.typeFilter.length > 0)\n          ? types.filter(function (field) {\n              return vm.typeFilter.indexOf(field.id) >= 0;\n            })\n          : types;\n      });\n\n      if (!vm.item.creators) {\n        vm.item.creators = [{}];\n      }\n\n      if (vm.item.creators.length === 0) {\n        vm.item.creators.push({});\n      }\n    }\n\n    function selectType(itemType) {\n      if (!itemType) {\n        vm.item.itemType = null;\n        vm.fields = [];\n        vm.roles = [];\n        return;\n      }\n\n      vm.item.itemType = itemType.id;\n\n      itemType.getFields().then(function (fields) {\n        vm.fields = fields;\n      });\n\n      itemType.getCreatorRoles().then(function (roles) {\n        vm.roles = roles;\n      });\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('zotero')\n    .component('zoteroCreatorField', {\n      templateUrl: 'app/zotero/creator-field.html',\n      controller: ZoteroCreatorFieldController,\n      bindings: {\n        creator: '=',\n        roles: '<'\n      }\n    });\n\n  /** @ngInject */\n  function ZoteroCreatorFieldController() {\n  }\n\n})();\n\n/*global zotero:false*/\n(function () {\n  'use strict';\n\n  angular\n    .module('zotero')\n    .factory('zotero', ZoteroFactory);\n\n  /** @ngInject */\n  function ZoteroFactory() {\n    return new zotero(zotero.getDefaultBaseUrl(), angular.toJson);\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .controller('WorkspaceController', WorkspaceController);\n\n  /** @ngInject */\n  function WorkspaceController(panelContentMediatorRegistry, workspaceRepository, $stateParams, $log, $scope, $timeout, $mdSidenav, $mdToast, hotkeys, _, $q, peopleRepo, worksRepo) {\n    var vm = this;\n\n    vm.workspace = null;\n\n    vm.activeItems = [];\n    vm.searchQuery = '';\n    vm.sidebarFocused = true;\n\n    vm.search = _.debounce(search, 300);\n\n    activate();\n\n    function activate() {\n      // lookup workspace by id || get first workspace || create new workspace\n      var workspaceIdP = $stateParams.workspaceId\n        ? $q.when($stateParams.workspaceId)\n        : workspaceRepository.listWorkspaceIds().then(function (ids) {\n          return ids.length > 0 ? ids[0] : null;\n        });\n\n      var workspaceP = workspaceIdP\n        .then(function (id) {\n          return workspaceRepository.getWorkspace(id);\n        })\n        .catch(function () {\n          return workspaceRepository.createWorkspace();\n        });\n\n      workspaceP.then(function (workspace) {\n        vm.workspace = workspace;\n      });\n\n      hotkeys.bindTo($scope)\n        .add({\n          combo: 'ctrl+\\\\',\n          description: 'Toggle Sidebar',\n          callback: function () {\n            vm.sidebarFocused = !vm.sidebarFocused;\n          }\n        })\n        .add({\n          combo: '/',\n          description: 'Search',\n          callback: function () {\n            vm.searchQuery = '';\n            if (vm.sidebarFocused) {\n              $timeout(function () {\n                // prevent key event from typing in field\n                angular.element('#searchQuery').focus();\n              });\n            } else {\n              $mdSidenav('left').toggle();\n            }\n          }\n        })\n        .add({\n          combo: 'n',\n          description: 'Create a new note panel',\n          callback: function () {\n            createNotePanel(100, 100);\n          }\n        });\n    }\n\n    function search(query) {\n      vm.loading = true;\n\n      // TODO delegate to registered external search/content providers\n\n      vm.peopleResults = peopleRepo.search(query);\n      vm.worksResults = worksRepo.search(query);\n\n      function tagAll(key, value) {\n        return function (arr) {\n          arr.forEach(function (obj) {\n            obj[key] = value;\n          });\n          return arr;\n        };\n      }\n\n      $q.all([\n        vm.peopleResults.$promise.then(_.property('items')).then(tagAll('type', 'person')),\n        vm.worksResults.$promise.then(_.property('items')).then(tagAll('type', 'work'))\n      ])\n        .then(function () {\n          vm.loading = false;\n        }, function () {\n          $mdToast.showSimple('Unable to load search results');\n        });\n    }\n\n    /**\n     * Creates a new note panel at the desired position\n     * @param {integer} x\n     * @param {integer} y\n     */\n    function createNotePanel(x, y) {\n      var note = {\n        note: ''\n      };\n\n      var context = {\n        xPosition: x,\n        yPosition: y\n      };\n\n      var contentMediators = panelContentMediatorRegistry.findContentMediators(note, context);\n      var mediator = contentMediators.length > 0 ? contentMediators[0] : null;\n      vm.workspace.createPanel(mediator, note, context);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .run(runBlock);\n\n  /** @ngInject */\n  function runBlock(panelContentMediatorRegistry, peopleContentMediator, worksContentMediator, editionsContentMediator, volumesContentMediator, googleBooksContentMediator, hathitrustContentMediator, internetArchiveContentMediator, noteContentMediator, passthruContentMediator) {\n    panelContentMediatorRegistry.register(peopleContentMediator);\n    panelContentMediatorRegistry.register(worksContentMediator);\n    panelContentMediatorRegistry.register(editionsContentMediator);\n    panelContentMediatorRegistry.register(volumesContentMediator);\n    panelContentMediatorRegistry.register(googleBooksContentMediator);\n    panelContentMediatorRegistry.register(hathitrustContentMediator);\n    panelContentMediatorRegistry.register(internetArchiveContentMediator);\n    panelContentMediatorRegistry.register(noteContentMediator);\n    panelContentMediatorRegistry.register(passthruContentMediator);\n  }\n\n})();\n\n/*global vwise:false*/\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .constant('vwise', vwise);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('vwise')\n    .config(config);\n\n  /** @ngInject */\n  function config(googleBooksApiProvider) {\n    googleBooksApiProvider.configure({ preventLoad: true });\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcWorks', [\n      'ngResource'\n    ]);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcWorks')\n    .provider('worksRepo', worksRepoProvider);\n\n  /**\n   * This functionality is already being implemented as a standalone trc-biblio module. The code is\n   * used here as an interim until the Bower build/dependency workflow has been finalized.\n   *\n   * @return {angular.provider}\n   */\n  function worksRepoProvider() {\n    var provider = {};\n    provider.url = '/api/works';\n    provider.$get = worksRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function worksRepoFactory($resource, _) {\n      var restResource = $resource(provider.url + '/:workId', { workId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var editionResource = $resource(provider.url + '/:workId/editions/:editionId', { editionId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var volumeResource = $resource(provider.url + '/:workId/editions/:editionId/volumes/:volumeId', { volumeId: '@id' }, {\n        update: {\n          method: 'PUT'\n        }\n      });\n\n      var repo = {};\n      repo.getReferencesEndpoint = getReferencesEndpoint;\n      repo.getAll = findAll;\n      repo.search = search;\n      repo.searchByAuthor = searchByAuthor;\n      repo.get = getWork;\n      repo.getWork = getWork;\n      repo.getEdition = getEdition;\n      repo.getVolume = getVolume;\n      repo.create = createWork;\n      repo.createWork = createWork;\n      repo.createEdition = createEdition;\n      repo.createVolume = createVolume;\n      repo.save = save;\n      repo.saveWork = saveWork;\n      repo.saveEdition = saveEdition;\n      repo.saveVolume = saveVolume;\n      repo.delete = deleteWork;\n      repo.getTitle = getTitleByTypePreference;\n      return repo;\n\n      /**\n       * Constructs a URL from which a bibliography for this work can be loaded.\n       *\n       * @return {string}\n       */\n      function getReferencesEndpoint(id) {\n        return provider.url + '/' + id + '/references';\n      }\n\n      /**\n       * Retrieves a listing of all works\n       *\n       * @return {WorkProxy[]}\n       */\n      function findAll() {\n        return search('');\n      }\n\n      /**\n       * Search for works by query\n       *\n       * @return {SearchResultSet}\n       */\n      function search(query) {\n        return restResource.get({ q: query, max: 50 });\n      }\n\n      /**\n       * Search for works by author\n       *\n       * @return {SearchResultSet}\n       */\n      function searchByAuthor(authorId) {\n        return restResource.get({ aid: authorId, max: 50 });\n      }\n\n      /**\n       * Retrieves a work object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Work.$promise.\n       *\n       * @param {string} workId\n       * @return {Work}\n       */\n      function getWork(workId) {\n        if (angular.isUndefined(workId)) {\n          throw new TypeError('Invalid ID provided to getWork');\n        }\n\n        var work = restResource.get({ workId: workId });\n\n        work.$promise.then(adaptWork);\n\n        return work;\n      }\n\n      /**\n       * Retrieves an edition object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Edition.$promise.\n       *\n       * @param {string} workId\n       * @param {string} editionId\n       * @return {Edition}\n       */\n      function getEdition(workId, editionId) {\n        if (angular.isUndefined(workId) || angular.isUndefined(editionId)) {\n          throw new TypeError('Invalid IDs provided to getEdition');\n        }\n\n        var edition = editionResource.get({ workId: workId, editionId: editionId });\n\n        edition.$promise.then(adaptEdition);\n\n        return edition;\n      }\n\n      /**\n       * Retrieves a volume object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promis is available on Volume.$promise.\n       *\n       * @param {string} workId\n       * @param {string} editionId\n       * @param {string} volumeId\n       * @return {Volume}\n       */\n      function getVolume(workId, editionId, volumeId) {\n        if (angular.isUndefined(workId) || angular.isUndefined(editionId) || angular.isUndefined(volumeId)) {\n          throw new TypeError('Invalid IDs provided to getVolume');\n        }\n\n        var volume = volumeResource.get({ workId: workId, editionId: editionId, volumeId: volumeId });\n\n        volume.$promise.then(adaptVolume);\n\n        return volume;\n      }\n\n      /**\n       * Creates a new work instance\n       *\n       * @return {Work}\n       */\n      function createWork() {\n        var work = new restResource();\n        adaptWork(work);\n        work.titles.push({});\n        work.authors.push({});\n        return work;\n      }\n\n      /**\n       * Creates a new edition instance\n       *\n       * @return {Edition}\n       */\n      function createEdition() {\n        var edition = new editionResource();\n        return adaptEdition(edition);\n      }\n\n      /**\n       * Creates a new volume instance\n       *\n       * @return {Volume}\n       */\n      function createVolume() {\n        var volume = new volumeResource();\n        return adaptVolume(volume);\n      }\n\n      /**\n       * Dispatch method for saving works, editions, and volumes\n       *\n       * @deprecated use saveWork, saveEdition, or saveVolume directly\n       * @return {Promise}\n       */\n      function save() {\n        switch (arguments.length) {\n          case 1: return saveWork.apply(null, arguments);\n          case 2: return saveEdition.apply(null, arguments);\n          case 3: return saveVolume.apply(null, arguments);\n        }\n        throw new TypeError('Unexpected arguments to worksRepo#save');\n      }\n\n      /**\n       * Saves a work instance back to the server\n       *\n       * @param {Work} work\n       * @return {Promise.<Work>}\n       */\n      function saveWork(work) {\n        if (!(work instanceof restResource)) {\n          throw new Error('work was not created by this repo');\n        }\n\n        // ngResource automatically updates the model to reflect any server changes (e.g. setting IDs for the work/edtions/volumes/copies).\n        return work.id\n          ? work.$update()\n          : work.$save();\n      }\n\n      /**\n       * Saves an edition instance back to the server\n       *\n       * @param  {string} workId\n       * @param  {Edition} edition\n       * @return {Promise.<Edition>}\n       */\n      function saveEdition(workId, edition) {\n        if (!workId) {\n          throw new Error('no work id provided');\n        }\n\n        if (!(edition instanceof editionResource)) {\n          throw new Error('edition was not created by this repo');\n        }\n\n        return edition.id\n          ? edition.$update({ workId: workId })\n          : edition.$save({ workId: workId });\n      }\n\n      /**\n       * Saves a volume instance back to the server\n       *\n       * @param  {string} workId\n       * @param  {string} editionId\n       * @param  {Volume} volume\n       * @return {Promise.<Volume>}\n       */\n      function saveVolume(workId, editionId, volume) {\n        if (!workId) {\n          throw new Error('no work id provided');\n        }\n\n        if (!editionId) {\n          throw new Error('no edition id provided');\n        }\n\n        if (!(volume instanceof volumeResource)) {\n          throw new Error('volume was not created by this repo');\n        }\n\n        return volume.id\n          ? volume.$update({ workId: workId, editionId: editionId })\n          : volume.$save({ workId: workId, editionId: editionId });\n      }\n\n      /**\n       * Deletes a work instance from the server\n       *\n       * @param  {Work|string} id\n       */\n      function deleteWork(workId) {\n        if (angular.isObject(workId) && workId.id) {\n          workId = workId.id;\n        }\n\n        var dataItem = restResource.delete({ workId: workId });\n        return dataItem.$promise;\n      }\n\n      /**\n       * Ensure that aggregate fields common to all work/edition/volume entities exist and are formatted correctly\n       *\n       * @param  {Work|Edition|Volume} entity\n       * @return {Work|Edition|Volume}\n       */\n      function adaptCommon(entity) {\n        if (!entity.titles) {\n          entity.titles = [];\n        } else {\n          entity.titles.forEach(function (title) {\n            title.type = angular.isString(title.type) ? title.type.toLowerCase() : title.type;\n          });\n        }\n\n        if (!entity.authors) {\n          entity.authors = [];\n        } else {\n          entity.authors.forEach(function (author) {\n            author.role = angular.isString(author.role) ? author.role.toLowerCase() : author.role;\n          });\n        }\n\n        if (!entity.copies) {\n          entity.copies = [];\n        }\n\n        return entity;\n      }\n\n      /**\n       * Ensure that work aggregate fields exist and are formatted correctly\n       *\n       * @param  {Work} work\n       * @return {Work}\n       */\n      function adaptWork(work) {\n        adaptCommon(work);\n\n        if (!work.editions) {\n          work.editions = [];\n        } else {\n          work.editions.forEach(adaptEdition);\n        }\n\n        return work;\n      }\n\n      /**\n       * Ensure that edition aggregate fields exist and are formatted correctly\n       *\n       * @param  {Edition} edition\n       * @return {Edition}\n       */\n      function adaptEdition(edition) {\n        adaptCommon(edition);\n\n        if (!edition.volumes) {\n          edition.volumes = [];\n        } else {\n          edition.volumes.forEach(adaptVolume);\n        }\n\n        return edition;\n      }\n\n      /**\n       * Ensure that volume aggregate fields exist and are formatted correctly\n       *\n       * @param  {Volume} volume\n       * @return {Volume}\n       */\n      function adaptVolume(volume) {\n        adaptCommon(volume);\n\n        return volume;\n      }\n\n      /**\n       * Retrieves the first available title of the given type or falsey if no title can be found.\n       * If multiple types are given, returns the title corresponding to the first type for which a title is found.\n       *\n       * @param  {Title[]}         titles\n       * @param  {string|string[]} types\n       * @return {Title}\n       */\n      function getTitleByTypePreference(titles, types) {\n        if (angular.isUndefined(types)) {\n          types = ['short', 'canonical', 'bibliographic'];\n        } else if (!angular.isArray(types)) {\n          types = [types];\n        }\n\n        return types.reduce(function (found, type) {\n          return found || _.find(titles, { type: type });\n        }, null);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcTasks', [\n      'ngResource'\n    ]);\n\n})();\n\n/**\n * @typedef {object} Workflow\n * @property {string} id\n * @property {string} label\n * @property {string} description\n * @property {object.<string, WorkflowStage>} stages\n * @property {string} status\n */\n\n/**\n * @typedef {object} WorkflowStage\n * @property {string} id\n * @property {string} label\n * @property {string} description\n * @property {boolean} isFinal\n * @property {WorkflowStageTransition[]} transitions\n */\n\n/**\n * @typedef {object} WorkflowStageTransition\n * @property {string} sourceStage\n * @property {string} targetStage\n * @property {string} label\n */\n\n/**\n * @typedef {object} Worklist\n * @property {string} groupId\n * @property {string} label\n * @property {integer} itemCount\n * @property {integer} start\n * @property {integer} max\n * @property {WorkItem[]} items\n */\n\n/**\n * @typedef {object} WorkItem\n * @property {string} itemId\n * @property {string} type\n * @property {string} entityId\n * @property {string} label\n * @property {object.<string,string>} properties\n * @property {string} stage\n * @property {string} task\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcTasks')\n    .provider('tasksRepo', tasksRepoProvider);\n\n  /**\n   * @return {angular.provider}\n   */\n  function tasksRepoProvider() {\n    var provider = {};\n    provider.url = '/api/tasks';\n    provider.$get = tasksRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function tasksRepoFactory($resource) {\n      var taskResource = $resource(provider.url + '/:taskId', { taskId: '@id' });\n      var workflowResource = $resource(provider.url + '/:taskId/workflow');\n      var itemResource = $resource(provider.url + '/:taskId/items/:itemId', { itemId: '@itemId' });\n\n      var repo = {};\n      repo.getTask = getTask;\n      repo.getWorkflow = getWorkflow;\n      repo.all = getAllTasks;\n      repo.getItems = getItems;\n      repo.transition = transition;\n      return repo;\n\n      /**\n       * Retrieves a listing of all tasks\n       *\n       * @return {Task[]}\n       */\n      function getAllTasks() {\n        return taskResource.query();\n      }\n\n      /**\n       * Retrieves a task by id\n       *\n       * @param  {string} taskId\n       * @return {GroupedTaskList}\n       */\n      function getTask(taskId) {\n        return taskResource.get({ taskId: taskId });\n      }\n\n      /**\n       * Retrieves a workflow by task id\n       * @param  {string} taskId\n       * @return {Workflow}\n       */\n      function getWorkflow(taskId) {\n        return workflowResource.get({ taskId: taskId });\n      }\n\n      /**\n       * Gets items from the task endpoint for a given stage\n       *\n       * @param  {string}  [taskId]  Task ID\n       * @param  {string}  stageId          Workflow stage for which to get items\n       * @param  {object}  options\n       * @param  {integer} [options.start]  Starting index\n       * @param  {integer} [options.max]    Maximum number of items to fetch per page\n       * @return {Worklist}\n       */\n      function getItems(taskId, stageId, options) {\n        options = options || {};\n        return itemResource.get({\n          taskId: taskId,\n          stage: stageId,\n          start: options.start,\n          max: options.max\n        });\n      }\n\n      /**\n       * Transition an item from its current stage to a target stage\n       *\n       * @param  {WorkItem}                item   Work item instance\n       * @param  {WorkflowStageTransition} transition Target workflow stage\n       * @return {WorkItem}                       Updated work item instance\n       */\n      function transition(taskId, item, transition) {\n        if (item.stage !== transition.sourceStage) {\n          throw new Error('Transition (' + transition.sourceStage + ' -> ' + transition.targetStage + ') is not valid for item currently in stage ' + item.stage);\n        }\n\n        var result = itemResource.save({\n          taskId: taskId,\n          itemId: item.itemId\n        }, {\n          stage: transition.targetStage,\n          // NOTE comments are not saved yet\n          comments: null\n        });\n\n        // propagate updates to the original item\n        result.$promise.then(function (resp) {\n          angular.extend(item, resp);\n        });\n\n        return result;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcReln', [\n      'ngResource'\n    ]);\n\n})();\n\n// NOTE: this entire API model *WILL* eventually change\n\n/**\n * @typedef Relationship\n * @type {object}\n * @property {string}     id                  - A unique identifier for this relationship\n * @property {string}     typeId              - The ID of the RelationshipType of this relationship\n * @property {string}     description         - A detailed description of this relationship\n * @property {string}     descriptionMimeType - MIME type string of the description\n * @property {Provenance} provenance          - Metadata about the relationship record\n * @property {Anchor[]}   relatedEntities     - A set of \"source\" anchors\n * @property {Anchor[]}   targetEntities      - A set of \"target\" anchors\n */\n\n/**\n * @typedef RelationshipType\n * @type {object}\n * @property {string}  identifier   - A unique identifier for this type\n * @property {string}  title        - A label to display for this type\n * @property {string}  reverseTitle - If this type is directed, the label to display for reverse relationships\n * @property {string}  description  - A more detailed description of this type\n * @property {boolean} isDirected   - Whether this type is directed (true) or undirected (false)\n */\n\n/**\n * @typedef Provenance\n * @type {object}\n * @property {string[]} creatorUris  - URIs to people/authors of this relationship\n * @property {string}   dateCreated  - an ISO 8601 date representation of when the record was created\n * @property {string}   dateModified - an ISO 8601 date representation of when the record was last modified\n */\n\n/**\n * @typedef Anchor\n * @type {object}\n * @property {string[]} entryUris[] - URIs to work/edition/volume\n */\n\n/**\n * @typedef TypeGroup\n * @type {object}\n * @property {string}                   label         - Potentially directed display label for group\n * @property {RelationshipType}         type          - The type corresponding to this group\n * @property {boolean}                  reverse       - For directed types, pecifies the directionality of relationships in this group\n * @property {NormalizedRelationship[]} relationships - Relationships of the same type and direction\n */\n\n/**\n * @typedef NormalizedRelationship\n * @type {object}\n * @property {string}                           id          - The id of the original relationship\n * @property {string}                           typeId      - The relationship's type id\n * @property {boolean}                          reverse     - Whether this relationship is in the reverse type direction\n * @property {string}                           description - A description of this relationship\n * @property {Entity[]}                         entities    - A set of target entities referenced by this relationship\n * @property {Promise.<NormalizedRelationship>} $promise    - Resolves to the normalized promise when all asynchronous data has been set\n */\n\n/**\n * @typedef Entity\n * @type {object}\n * @property {string}              label               - A display label for the entity\n * @property {string}              type                - One of 'work', 'edition', or 'volume'\n * @property {object}              refParams           - Reference parameters for resolving the entity\n * @property {string}              refParams.workId    - The entity's work id\n * @property {string}              refParams.editionId - If an edition or volume, the entity's edition id\n * @property {string}              refParams.volumeId  - If a volume, the entity's volume id\n * @property {Work|Edition|Volume} entity              - The entity itself\n * @property {Promise.<Entity>}    $promise            - Resolves to the entity when all asynchronous data has been set\n */\n\n(function () {\n  'use strict';\n\n  var ENTITY_URI = /^works\\/([^\\/]+)(?:\\/editions\\/([^\\/]+)(?:\\/volumes\\/([^\\/]+))?)?$/i;\n\n  angular\n    .module('trcReln')\n    .provider('relationshipsRepo', relationshipsRepoProvider);\n\n  function relationshipsRepoProvider() {\n    var provider = {};\n    provider.url = '/api/relationships';\n    provider.$get = relationshipsRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function relationshipsRepoFactory($q, $resource) {\n      var typeResource = $resource(provider.url + '/types/:id', { id: '@identifier' });\n      var relnResource = $resource(provider.url + '/:id', { id: '@id' }, {\n        update: { method: 'PUT' }\n      });\n\n      var typesCache = null;\n\n      var repo = {};\n      repo.getTypes = getTypes;\n      repo.getType = getType;\n      repo.createRelationship = createRelationship;\n      repo.createProvenance = createProvenance;\n      repo.createAnchor = createAnchor;\n      repo.get = findById;\n      repo.search = search;\n      repo.save = saveRelationship;\n      repo.delete = deleteRelationship;\n      repo.normalizeRelationships = normalizeRelationships;\n      return repo;\n\n      /**\n       * Fetches relationship types from the server, caching them in the process.\n       * The returned array will be populated when the request resolves.\n       * The underlying promise is available on the $promise property.\n       *\n       * @param  {object} options\n       * @param  {boolean} options.force Discard cache (if set) and refetch\n       * @return {object.<string,RelationshipType>}\n       */\n      function getTypes(options) {\n        options = options || {};\n\n        if (!typesCache || options.force) {\n          var types = typeResource.query();\n\n          typesCache = {};\n\n          var tcPromise = types.$promise.then(function () {\n            types.forEach(function (type) {\n              typesCache[type.identifier] = type;\n            });\n            return typesCache;\n          });\n\n          // add $promise as a non-enumerable property\n          Object.defineProperty(typesCache, '$promise', {\n            value: tcPromise\n          });\n        }\n\n        return typesCache;\n      }\n\n      /**\n       * Fetches a type by ID\n       *\n       * @param  {string} id\n       * @return {Promise.<RelationshipType>}\n       */\n      function getType(id) {\n        var types = getTypes();\n\n        return types.$promise.then(function (types) {\n          return types[id];\n        });\n      }\n\n      /**\n       * Creates a new empty relationship instance\n       *\n       * @return {Relationship}\n       */\n      function createRelationship() {\n        var reln = new relnResource();\n        return adaptRelationship(reln);\n      }\n\n      /**\n       * Creates a new empty provenance model\n       *\n       * @return {Provenance}\n       */\n      function createProvenance() {\n        var provenance = {};\n        return adaptProvenance(provenance);\n      }\n\n      /**\n       * Creates a new empty anchor model\n       *\n       * @return {Anchor}\n       */\n      function createAnchor() {\n        var anchor = {};\n        return adaptAnchor(anchor);\n      }\n\n      /**\n       * Retrieves a relationship from the server by ID.\n       * The returned model will be populated once the request succeeds.\n       * The underlying promise can be accessed via the $promise property.\n       *\n       * @param  {string} id\n       * @return {Relationship}\n       */\n      function findById(id) {\n        return relnResource.get({ id: id });\n      }\n\n      /**\n       * Find all relationships matching the given criteria.\n       * @param  {object|string} options\n       * @property {string} options.uri (default if options is a string)\n       * @property {string} options.typeId\n       * @property {string} options.direction \"from\" (out-relationships), \"to\" (in-relationships), or \"any\"\n       * @property {integer} options.start\n       * @property {integer} options.max\n       * @return {Relationship[]}\n       */\n      function search(options) {\n        if (!options) {\n          throw new Error('no options provided')\n        }\n\n        if (angular.isString(options)) {\n          // treat single string as an entity URL\n          options = { uri: options };\n        }\n\n        var queryOpts = {};\n\n        if (options.uri) {\n          queryOpts.entity = options.uri;\n        }\n\n        if (options.typeId) {\n          queryOpts.type = options.typeId;\n        }\n\n        if (options.direction) {\n          queryOpts.direction = options.direction;\n        }\n\n        if (options.start) {\n          queryOpts.off = options.start;\n        }\n\n        if (options.max) {\n          queryOpts.max = options.max;\n        }\n\n        return relnResource.query(queryOpts);\n      }\n\n      /**\n       * Saves a relationship back to the server.\n       *\n       * @param  {Relationship} reln\n       * @return {Promise} resolves on successful save\n       */\n      function saveRelationship(reln) {\n        if (!(reln instanceof relnResource)) {\n          throw new Error('Relationship was not created by this repo');\n        }\n\n        return reln.id\n          ? reln.$update()\n          : reln.$save();\n      }\n\n      /**\n       * Deletes a relationship from the server via the REST API.\n       *\n       * @param  {string} id\n       * @return {Promise} resolves on success\n       */\n      function deleteRelationship(id) {\n        var response = relnResource.delete({ id: id });\n        return response.$promise\n      }\n\n      /**\n       * Ensures aggregate fields on a relationship are set appropriately\n       *\n       * @param  {Relationship} reln\n       * @return {Relationship}\n       */\n      function adaptRelationship(reln) {\n        if (!reln.provenance) {\n          reln.provenance = createProvenance();\n        }\n\n        if (!reln.relatedEntities) {\n          reln.relatedEntities = [];\n        }\n\n        if (!reln.targetEntities) {\n          reln.targetEntities = [];\n        }\n\n        return reln;\n      }\n\n      /**\n       * Ensures aggregate fields on a provenance model are set appropriately\n       *\n       * @param  {Provenance} provenance\n       * @return {Provenance}\n       */\n      function adaptProvenance(provenance) {\n        if (!provenance.creatorUris) {\n          provenance.creatorUris = [];\n        }\n\n        return provenance;\n      }\n\n      /**\n       * Ensures aggregate fields on an anchor model are set appropriately\n       *\n       * @param  {Anchor} anchor\n       * @return {Anchor}\n       */\n      function adaptAnchor(anchor) {\n        if (!anchor.entryUris) {\n          anchor.entryUris = [];\n        }\n\n        return anchor;\n      }\n\n      /**\n       * Normalizes relationships into type groups that are more suitable for display in the UI\n       *\n       * @param  {Relationship[]} relationships\n       * @return {TypeGroup[]}\n       */\n      function normalizeRelationships(relationships, currentUri, worksRepo) {\n        var normRelns = relationships.map(function (relationship) {\n          var isReverse = relationship.targetEntities.some(function (anchor) {\n            return anchor.entryUris.some(function (uri) {\n              return uri === currentUri;\n            });\n          });\n\n          var targetField = isReverse ? 'relatedEntities' : 'targetEntities';\n\n          var entities = flatMap(relationship[targetField], property('entryUris'))\n            .map(function (uri) {\n              return resolveEntityUri(uri, worksRepo);\n            });\n\n          var normReln = {\n            id: relationship.id,\n            typeId: relationship.typeId,\n            reverse: isReverse,\n            description: relationship.description,\n            entities: entities\n          };\n\n          var entityPs = entities.map(property('$promise'));\n\n          Object.defineProperty(normReln, '$promise', {\n            value: $q.all(entityPs).then(constant(normReln))\n          });\n\n          return normReln;\n        });\n\n        var relnsByTypeDir = {};\n\n        normRelns.forEach(function (relationship) {\n          var typeId = relationship.typeId;\n\n          if (!relnsByTypeDir.hasOwnProperty(typeId)) {\n            relnsByTypeDir[typeId] = {\n              fwd: [],\n              rev: []\n            };\n          }\n\n          relnsByTypeDir[typeId][relationship.reverse ? 'rev' : 'fwd'].push(relationship);\n        });\n\n        var typeGroups = [];\n\n        var typeGroupPs = kvMap(relnsByTypeDir, function (dirs, typeId) {\n          return getType(typeId).then(function (type) {\n            if (type.isDirected) {\n              // add forward group\n              if (dirs.fwd.length > 0) {\n                typeGroups.push({\n                  label: type.title,\n                  type: type,\n                  reverse: false,\n                  relationships: dirs.fwd\n                });\n              }\n\n              // add reverse group\n              if (dirs.rev.length > 0) {\n                typeGroups.push({\n                  label: type.reverseTitle,\n                  type: type,\n                  reverse: true,\n                  relationships: dirs.rev\n                });\n              }\n            } else {\n              // combine forward/reverse and add as a single group\n              var group = dirs.fwd.concat(dirs.rev);\n              if (group.length > 0) {\n                typeGroups.push({\n                  label: type.title,\n                  type: type,\n                  relationships: group\n                });\n              }\n            }\n          });\n        });\n\n        Object.defineProperty(typeGroups, '$promise', {\n          value: $q.all(typeGroupPs).then(constant(typeGroups))\n        });\n\n        return typeGroups;\n      }\n    }\n  }\n\n  /**\n   * Resolves an entity URI into a uniform container for the referenced entity.\n   * @param  {string} uri\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function resolveEntityUri(uri, worksRepo) {\n    var match = ENTITY_URI.exec(uri);\n\n    if (!match) {\n      return null;\n    }\n\n    if (match[1] && match[2] && match[3]) {\n      return makeVolumeEntity(match[1], match[2], match[3], worksRepo);\n    } else if (match[1] && match[2]) {\n      return makeEditionEntity(match[1], match[2], worksRepo);\n    } else if (match[1]) {\n      return makeWorkEntity(match[1], worksRepo);\n    }\n\n    return null;\n  }\n\n  /**\n   * Creates an entity for a volume.\n   * @param  {string} workId\n   * @param  {string} editionId\n   * @param  {string} volumeId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeVolumeEntity(workId, editionId, volumeId, worksRepo) {\n    var edition = worksRepo.getEdition(workId, editionId);\n    var volume = worksRepo.getVolume(workId, editionId, volumeId);\n\n    var entity = {\n      type: 'volume',\n      refParams: {\n        workId: workId,\n        editionId: editionId,\n        volumeId: volumeId\n      },\n      entity: volume\n    };\n\n    var labelP = volume.$promise.then(function () {\n      var title = worksRepo.getTitle(volume.titles, ['short', 'canonical', 'bibliographic']);\n      var label = formatTitle(title);\n\n      return edition.$promise.then(function () {\n        return label + '. ' + edition.editionName + '. Volume ' + volume.volumeNumber;\n      }, function () {\n        return label + '. [Unknown edition]. Volume ' + volume.volumeNumber;\n      });\n    });\n\n    var entityP = labelP.then(function (label) {\n      entity.label = label;\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Creates an entity for an edition.\n   * @param  {string} workId\n   * @param  {string} editionId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeEditionEntity(workId, editionId, worksRepo) {\n    var edition = worksRepo.getEdition(workId, editionId);\n\n    var entity = {\n      type: 'edition',\n      refParams: {\n        workId: workId,\n        editionId: editionId\n      },\n      entity: edition\n    };\n\n    var entityP = edition.$promise.then(function () {\n      var title = worksRepo.getTitle(edition.titles, ['short', 'canonical', 'bibliographic']);\n      entity.label = formatTitle(title) + '. ' + edition.editionName;\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Creates an entity for a work.\n   * @param  {string} workId\n   * @param  {WorksRepository} worksRepo\n   * @return {Entity}\n   */\n  function makeWorkEntity(workId, worksRepo) {\n    var work = worksRepo.getWork(workId);\n\n    var entity = {\n      type: 'work',\n      refParams: {\n        workId: workId\n      },\n      entity: work\n    };\n\n    var entityP = work.$promise.then(function () {\n      var title = worksRepo.getTitle(work.titles, ['short', 'canonical', 'bibliographic']);\n      entity.label = formatTitle(title);\n      return entity;\n    });\n\n    Object.defineProperty(entity, '$promise', {\n      value: entityP\n    });\n\n    return entity;\n  }\n\n  /**\n   * Formats a bibliographic entity's title into a title string\n   * @param  {Title} title\n   * @return {string}\n   */\n  function formatTitle(title) {\n    if (!title) {\n      return '';\n    }\n\n    return title.title + (title.subtitle ? ': ' + title.subtitle : '');\n  }\n\n  // UTILITY FUNCTIONS\n\n  /**\n   * @param {object} o\n   * @return {function}\n   */\n  function constant(o) {\n    return function () {\n      return o;\n    };\n  }\n\n  /**\n   * Maps over an object's key/value pairs\n   * @param {object.<string, object>} obj\n   * @param {function} cb\n   * @return {array}\n   */\n  function kvMap(obj, cb) {\n    return Object.keys(obj)\n      .filter(function (k) {\n        return obj.hasOwnProperty(k);\n      })\n      .map(function (k) {\n        return cb(obj[k], k);\n      });\n  }\n\n  /**\n   * Flattens an array of arrays by one level\n   * @param {array[]} arrs\n   * @return {array}\n   */\n  function flatten(arrs) {\n    return arrs.reduce(function (flattened, arr) {\n      return flattened.concat(arr);\n    }, []);\n  }\n\n  /**\n   * @param {array} arr\n   * @param {function} cb\n   * @return {array}\n   */\n  function flatMap(arr, cb) {\n    return flatten(arr.map(cb));\n  }\n\n  /**\n   * @param {string} prop\n   * @return {function}\n   */\n  function property(prop) {\n    return function (o) {\n      return o[prop];\n    };\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs', [\n      'ngResource',\n      'uuid4'\n    ]);\n\n})();\n\n/*global _:false, CSL:false*/\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs')\n    .constant('_', _)\n    .constant('CSL', CSL);\n\n})();\n\n/**\n * @typedef Reference\n * @type {object}\n * @property {object.<string,Citation>} citations\n * @property {object.<string,object>} bibliography\n */\n/**\n * @typedef Citation\n * @type {object}\n * @property {string} id\n * @property {CitationItem[]} items\n */\n/**\n * @typedef CitationItem\n * @type {object}\n * @property {string} id\n * @property {string} label\n * @property {string} locatorType\n * @property {string} locator\n * @property {boolean} suppressAuthor\n */\n/**\n * @typedef BiblioItem\n * @type {object}\n * @property {string} id\n * @property {string} type\n * @property {BiblioItemMeta} meta\n * @property {Creator[]} creators\n * @property {Object.<string,string>} fields\n */\n/**\n * @typedef BiblioItemMeta\n * @type {object}\n * @property {string} key\n * @property {string} creatorSummary\n * @property {string} parsedDate\n * @property {string} dateAdded\n * @property {string} dateModified\n */\n/**\n * @typedef Creator\n * @type {object}\n * @property {string} role\n * @property {string} firstName\n * @property {string} lastName\n * @property {string} name\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs')\n    .provider('refsRepoFactory', referencesRepositoryFactoryProvider);\n\n  /** @ngInject */\n  function referencesRepositoryFactoryProvider() {\n    var provider = {};\n\n    provider.$get = referencesRepositoryFactoryFactory;\n\n    return provider;\n\n    /** @ngInject */\n    function referencesRepositoryFactoryFactory(_, uuid4, $resource) {\n      var factory = {}\n\n      // the following methods can be considered static and require no repo state in order to function\n      factory.createRefCollection = createRefCollection;\n      factory.createCitation = createCitation;\n      factory.createBiblioItem = createBiblioItem;\n      factory.merge = mergeReferences;\n      factory.compact = compactRefCollection;\n      factory.validate = validateRefCollection;\n      factory.isValid = isValidRefCollection;\n\n      factory.getRepo = createRepository;\n\n      return factory;\n\n      /**\n       * Creades a new reference collection repository scoped to the given endpoint URL\n       * @param {string} endpoint\n       * @return {ReferenceRepository}\n       */\n      function createRepository(endpoint) {\n        var refsResource = $resource(endpoint);\n\n        // initialize with static repo factory methods for convenience\n        var repo = _.omit(factory, ['getRepo']);\n\n        repo.get = getReferences;\n        repo.save = saveReferences;\n        repo.delete = deleteReferences;\n\n        return repo;\n\n        /**\n         * Retrieves the reference collection from the server's API\n         * @return {ReferenceCollection}\n         */\n        function getReferences() {\n          return refsResource.get();\n        }\n\n        /**\n         * Persists the given reference collection to the server's API\n         * @param  {ReferenceCollection} refs\n         * @return {Promise.<ReferenceCollection>}\n         */\n        function saveReferences(refs) {\n          var compactRefs = compactRefCollection(refs);\n          var res = refsResource.save({}, compactRefs);\n          return res.$promise;\n        }\n\n        /**\n         * Removes the reference collection from the server's API\n         * @return {Promise}\n         */\n        function deleteReferences() {\n          var res = refsResource.delete();\n          return res.$promise;\n        }\n      }\n\n      /**\n       * Creates a new reference object instance\n       * @return {Reference}\n       */\n      function createRefCollection() {\n        return {\n          citations: {},\n          bibliography: {}\n        };\n      }\n\n      /**\n       * Creates a new citation object instance\n       * @return {Citation}\n       */\n      function createCitation() {\n        return {\n          id: uuid4.generate(),\n          items: []\n        };\n      }\n\n      /**\n       * Creates a new bibliography item\n       * @return {BiblioItem}\n       */\n      function createBiblioItem(id) {\n        return {\n          id: id,\n          type: null,\n          meta: {},\n          creators: [],\n          fields: {}\n        };\n      }\n\n      /**\n       * Merge the citations and bibliographies of two references into a new reference.\n       * @param  {Reference} a\n       * @param  {Reference} b\n       * @return {Reference}   A new reference containing the combined citations and bibliography enttries\n       */\n      function mergeReferences(a, b) {\n        var newRef = createRefCollection();\n        angular.extend(newRef.citations, a.citations, b.citations);\n        angular.extend(newRef.bibliography, a.bibliography, b.bibliography);\n        return newRef;\n      }\n\n      /**\n       * Removes extraneous unreferenced bibliography entries\n       * @param  {Reference} ref\n       * @return {Reference}\n       */\n      function compactRefCollection(ref) {\n        var newRef = createRefCollection();\n        angular.extend(newRef.citations, ref.citations);\n        newRef.bibliography = _.chain(ref.citations)\n          // get set of unique referenced item ids\n          .flatMap('items').map('id').uniq()\n          // resolve id against bibliography object\n          .map(function (id) { return { id: id, item: ref.bibliography[id] }; })\n          // remove any null/undefined values\n          .filter('item')\n          // convert to object keyed by bibliography id\n          .keyBy('id')\n          .mapValues('item')\n          .value();\n\n        return newRef;\n      }\n\n      /**\n       * Validates the given reference by ensuring all cited bibliographic items are present in the bibliography\n       * @param  {Reference}           ref\n       * @return {[string,string[]][]}     A list of 2-tuples, where the first element is the ID of an invalid citation, and the second is an array of invalid bib item ids\n       */\n      function validateRefCollection(ref) {\n        return _.chain(ref.citations)\n          .map(function (citation) {\n            var itemIds = _.map(citation.items, 'id');\n            var invalidItemIds = _.reject(itemIds, _.propertyOf(ref.bibliography));\n            return [citation.id, invalidItemIds];\n          })\n          .filter(function (pair) {\n            // remove pairs containing no invalid item ids\n            return pair[1] && pair[1].length;\n          })\n          .value();\n      }\n\n      /**\n       * @param  {Reference} ref\n       * @return {boolean}       whether a given reference is valid\n       */\n      function isValidRefCollection(ref) {\n        var errors = validateRefCollection(ref);\n        return errors.length === 0;\n      }\n    }\n  }\n\n})();\n\n/**\n * @typedef CiteprocReferenceDTO\n * @type {object}\n * @property {object.<string, object>} citations\n * @property {CiteprocBibliographyDTO} bibliography\n */\n/**\n * @typedef CiteprocBibliographyDTO\n * @type {object}\n * @property {CiteprocBibliographyMetaDTO} meta\n * @property {string} html - rendered bibliography HTML\n * @property {string[]} items - Individually rendered bibliography items\n */\n/**\n * @typedef CiteprocBibliographyMetaDTO\n * @type {object}\n * @property {object[]} errors\n * @property {boolean} done\n * @property {string[]} entryIds\n * @property {number} entrySpacing\n * @property {number} hangingIndent\n * @property {number} lineSpacing\n * @property {number} maxOffset\n * @property {boolean} secondFieldAlign\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs')\n    .factory('refsRenderer', ReferenceRendererServiceFactory);\n\n  /** @ngInject */\n  function ReferenceRendererServiceFactory($q, $http, _, refsAdapter, citeproc) {\n    var adapterConfigP = $http.get('assets/typemap/zotero-csl.json').then(function (res) {\n      return res.data;\n    });\n\n    return {\n      render: renderReference,\n      renderBiblioItem: renderBiblioItem\n    };\n\n    /**\n     * Asynchronously adapts and renders the given reference into an HTML bibliography\n     * @param  {Reference} reference\n     * @param  {string} styleId\n     * @return {Promise.<CiteprocReferenceDTO>}\n     */\n    function renderReference(styleId, reference) {\n      if (!styleId || !angular.isString(styleId)) {\n        throw new Error('no style provided');\n      }\n\n      if (!reference) {\n        throw new Error('no reference provided');\n      }\n\n      var cslReferenceP = adapterConfigP.then(function (config) {\n        return refsAdapter.adapt(config, reference);\n      });\n\n      var citeprocP = cslReferenceP.then(function (cslReference) {\n        return citeproc.load(styleId, function (key) {\n          return cslReference.bibliography[key];\n        });\n      });\n\n      var paramsP = $q.all({\n        cslReference: cslReferenceP,\n        citeproc: citeprocP\n      });\n\n      var renderP = paramsP.then(function (params) {\n        return renderCiteproc(params.citeproc, params.cslReference);\n      });\n\n      return renderP;\n    }\n\n    /**\n     * Asynchronously renders a single bibliography item.\n     * @param  {string} styleId\n     * @param  {BiblioItem} biblioItem\n     * @return {Promise.<string>}\n     */\n    function renderBiblioItem(styleId, biblioItem) {\n      var cslBiblioItemP = adapterConfigP.then(function (config) {\n        return refsAdapter.adaptBiblioItem(config, biblioItem);\n      });\n\n      var citeprocP = cslBiblioItemP.then(function (cslBiblioItem) {\n        return citeproc.load(styleId, function () {\n          return cslBiblioItem;\n        });\n      });\n\n      var cslBibliographyP = cslBiblioItemP.then(function (cslBiblioItem) {\n        var bibliography = {};\n        bibliography[cslBiblioItem.id] = cslBiblioItem;\n        return bibliography;\n      });\n\n      var paramsP = $q.all({\n        cslBibliography: cslBibliographyP,\n        citeproc: citeprocP\n      });\n\n      var renderP = paramsP.then(function (params) {\n        return renderCiteproc(params.citeproc, {\n          citations: [],\n          bibliography: params.cslBibliography\n        });\n      });\n\n      return renderP.then(function (rendered) {\n        return rendered.bibliography.html;\n      });\n    }\n\n    /**\n     * Renders a CSL bibliography and citations against the given citeproc engine\n     * @param  {CSL.Engine} citeproc\n     * @param  {CslReferenceDTO} cslReference\n     * @return {CiteprocReferenceDTO}\n     */\n    function renderCiteproc(citeproc, cslReference) {\n      citeproc.updateItems(_.keys(cslReference.bibliography));\n\n      /** @type {[0@index: number, 1@html: string, 2@id: string][]} */\n      var renderedCitations = _.flatMap(cslReference.citations, function (citation) {\n        // citeproc updates the citation internally, which causes infinite $digest loops\n        // create a copy so changes do not leak out\n        var copy = angular.copy(citation);\n        return citeproc.appendCitationCluster(copy, true);\n      });\n\n      var bibliography = citeproc.makeBibliography();\n\n      var meta = bibliography[0];\n      var items = bibliography[1].map(function (item) {\n        return item.trim();\n      });\n\n      return {\n        citations: _.mapValues(_.keyBy(renderedCitations, 2), 1),\n        bibliography: {\n          meta: {\n            errors: meta.bibliography_errors,\n            done: meta.done,\n            entryIds: meta.entry_ids,\n            entrySpacing: meta.entryspacing,\n            hangingIndent: meta.hangingindent,\n            lineSpacing: meta.linespacing,\n            maxOffset: meta.maxoffset,\n            secondFieldAlign: meta['second-field-align']\n          },\n          html: meta.bibstart + items.join('') + meta.bibend,\n          items: items\n        }\n      };\n    }\n  }\n\n})();\n\n/**\n * @typedef TrcReferenceCollection\n * @type {object}\n * @property {object.<string, TrcCitation>} citations\n * @property {object.<string, TrcBibliographicItem>} bibliography\n */\n\n/**\n * @typedef TrcCitation\n * @type {object}\n * @property {string} id\n * @property {TrcBibliographicItemRef[]} items\n */\n\n/**\n * @typedef TrcBibliographicItemRef\n * @type {object}\n * @property {string} id\n * @property {string} locator\n * @property {string} locatorType\n * @property {boolean} suppressAuthor\n */\n\n/**\n * @typedef TrcBibliographicItem\n * @type {object}\n * @property {string} id\n * @property {string} type\n * @property {TrcCreator[]} creators\n * @property {object.<string, string>} meta\n * @property {object.<string, string>} fields\n */\n\n/**\n * @typedef TrcCreator\n * @type {object}\n * @property {string} role\n * @property {string} firstName\n * @property {string} lastName\n * @property {string} name\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs')\n    .factory('refsAdapter', refsAdapterFactory);\n\n  /** @ngInject */\n  function refsAdapterFactory(_) {\n    var adapter = {};\n\n    adapter.adapt = adaptReference;\n    adapter.adaptCitation = adaptCitation;\n    adapter.adaptBiblioItem = adaptBiblioItem\n\n    return adapter;\n\n    /**\n     * Adapts a trc reference collection into csl citations and bibliography items\n     * @param {ItemAdapterMapping} config - Field mapping the bibliography item adapter\n     * @param {TrcReferenceCollection} reference\n     * @return {CslReferenceCollection}\n     */\n    function adaptReference(config, reference) {\n      return {\n        citations: _.mapValues(reference.citations, adaptCitation),\n        bibliography: _.mapValues(reference.bibliography, makeCslBibliogaphyItemAdapter(config))\n      };\n    }\n\n    /**\n     * Adapts the given trc citation into a csl citation\n     * @param {TrcCitation} trcCitation\n     * @return {CslCitationDTO}\n     */\n    function adaptCitation(trcCitation) {\n      return {\n        citationID: trcCitation.id,\n        citationItems: trcCitation.items.map(function (trcCitationItem) {\n          return {\n            id: trcCitationItem.id,\n            locator: trcCitationItem.locator,\n            label: trcCitationItem.locatorType,\n            'suppress-author': trcCitationItem.suppressAuthor\n          };\n        }),\n        properties: {}\n      };\n    }\n\n    /**\n     * Adapts the given biblio item into a csl bibliographic item\n     * @param {object} config\n     * @param {TrcBibliographicItem} item\n     * @return {CslCitationDTO}\n     */\n    function adaptBiblioItem(config, item) {\n      var adapt = makeCslBibliogaphyItemAdapter(config);\n      return adapt(item);\n    }\n\n    /**\n     * creates an adapter from zotero bibliography items into csl bibliography items\n     * @param {AdapterConfig} config\n     * @return {function}\n     */\n    function makeCslBibliogaphyItemAdapter(config) {\n      return adaptItem;\n\n      /**\n       * Adapts the given zotero bibliography item into a csl bibliography item\n       * @param  {TrcBibliographicItem} item\n       * @return {CslItemDTO}\n       */\n      function adaptItem(item) {\n        if (!item) {\n          return null;\n        }\n\n        var itemType = item.type;\n        var itemTypeMapping = getItemTypeMapping(itemType);\n\n        var cslItem = {};\n\n        cslItem.id = item.id;\n        cslItem.type = itemTypeMapping.target;\n\n\n        var cslCreatorFields = getCslCreators(itemTypeMapping, item.creators);\n        angular.merge(cslItem, cslCreatorFields)\n\n        angular.forEach(item.fields, adaptField);\n        angular.forEach(item.meta, adaptField);\n\n        return cslItem;\n\n        function adaptField(value, field) {\n          if (!value) {\n            return;\n          }\n\n          var cslField = getCslField(itemTypeMapping, field);\n\n          if (!cslField) {\n            return;\n          }\n\n          if (cslField.type === 'date') {\n            value = { raw: value };\n          }\n\n          cslItem[cslField.field] = value;\n        }\n      }\n\n      /**\n       * @param {string} zItemType\n       * @return {object} field mapping config for the given zotero item type\n       */\n      function getItemTypeMapping(zItemType) {\n        if (!zItemType || !config.itemMappings.hasOwnProperty(zItemType)) {\n          throw new Error('malformed item or mapping: ' + zItemType + ' is not defined as a valid ' + config.source.format + ' type mapping');\n        }\n\n        return config.itemMappings[zItemType];\n      }\n\n      /**\n       * Looks up the corresponding csl field metadata given a zotero field name\n       * @param {string} zField\n       * @return {?FieldMeta} the corresponding field metadata or null if there is no corresponding target field for the given source field\n       */\n      function getCslField(itemTypeMapping, zField) {\n        var cslFieldDef = itemTypeMapping.fields[zField];\n\n        if (cslFieldDef && cslFieldDef.target) {\n          var cslField = cslFieldDef.target\n          var cslFieldMeta = config.target.fields[cslField];\n\n          if (!cslFieldMeta) {\n            throw new Error('malformed mapping: source field ' + zField + ' maps to target field ' + cslField + ', but ' + cslField + ' is not listed as a valid ' + config.target.format + ' field');\n          }\n\n          return cslFieldMeta;\n        }\n\n        return null;\n      }\n\n      /**\n       * Adapts an array of zotero creators into a mapping of csl creator fields.\n       * These fields should be merged onto the final adapted csl item\n       * @param {string} zItemType\n       * @param {Creator[]} trcCreators\n       * @return {object.<string,CslCreator[]>}\n       */\n      function getCslCreators(itemTypeMapping, trcCreators) {\n        var cslCreators = {};\n\n        trcCreators.forEach(function (trcCreator) {\n          if (!(trcCreator && (trcCreator.firstName || trcCreator.lastName || trcCreator.name))) {\n            return;\n          }\n\n          var cslCreatorFieldDef = itemTypeMapping.creatorTypes[trcCreator.role];\n\n          if (cslCreatorFieldDef && cslCreatorFieldDef.target) {\n            var cslCreator = (trcCreator.firstName || trcCreator.lastName)\n              ? { given: trcCreator.firstName, family: trcCreator.lastName }\n              : { literal: trcCreator.name };\n\n            var cslCreatorField = cslCreatorFieldDef.target;\n            if (!cslCreators.hasOwnProperty(cslCreatorField)) {\n              cslCreators[cslCreatorField] = [];\n            }\n\n            cslCreators[cslCreatorField].push(cslCreator);\n          }\n        });\n\n        return cslCreators;\n      }\n    }\n  }\n\n})();\n\n/**\n * @callback styleSupplierCallback\n * @return {Promise.<string>} style definition\n */\n/**\n * @callback localeSupplierCallback\n * @return {Promise.<string>} locale definition\n */\n/**\n * @callback bibliographyItemSupplierCallback\n * @param {string} itemId\n * @return {CslItemDTO}\n */\n(function () {\n  'use strict';\n\n  angular\n    .module('trcRefs')\n    .provider('citeproc', citeprocProvider);\n\n  /** @ngInject */\n  function citeprocProvider(_) {\n    /** @type {object.<string,localeSupplierCallback>} */\n    var localeSuppliers = {};\n\n    /** @type {object.<string,Promise.<string>>} */\n    var loadedLocales = {};\n\n    /** @type {object.<string,styleSupplierCallback} */\n    var styleSuppliers = {};\n\n    /** @type {object.<string,Promise.<string>>} */\n    var loadedStyles = {};\n\n    var provider = {\n      defaultLocale: 'en-US',\n      addLocale: addLocale,\n      addStyle: addStyle,\n      $get: citeprocFactory\n    };\n\n    return provider;\n\n    /**\n     * Register a locale with the citeproc provider\n     * @param {string} localeId\n     */\n    function addLocale(localeId, supplier) {\n      localeSuppliers[localeId] = supplier;\n    }\n\n    /**\n     * Register a style with the citeproc provider\n     * @param {string} styleId\n     * @param {styleProviderCallback} provider\n     */\n    function addStyle(styleId, supplier) {\n      styleSuppliers[styleId] = supplier;\n    }\n\n\n    /** @ngInject */\n    function citeprocFactory($q, $injector, CSL) {\n      // HACK: have to load all locales in order for sys.retrieveLocale to work as citeproc expects\n      //       might as well kick it off as soon as the service is injected\n      var localesP = loadLocales();\n      return { load: getEngine };\n\n      /**\n       * Constructs a citeproc instance with the given style\n       * @param  {string} styleId\n       * @param  {bibliographyItemSupplierCallback} bibliographyItemSupplier\n       * @return {Promise.<CSL.Engine>}\n       */\n      function getEngine(styleId, bibliographyItemSupplier) {\n        var paramsP = $q.all({\n          style: loadStyle(styleId),\n          locales: localesP\n        });\n\n        return paramsP.then(function (params) {\n          var citeprocSys = {\n            retrieveLocale: getLocale,\n            retrieveItem: getBibliographyItem\n          };\n\n          return new CSL.Engine(citeprocSys, params.style, provider.defaultLocale);\n\n          /**\n           * Retrieves a locale for the citeproc engine\n           * @param  {string} lang\n           * @return {string}\n           */\n          function getLocale(lang) {\n            if (!params.locales.hasOwnProperty(lang)) {\n              throw new Error('unknown locale ' + lang);\n            }\n\n            return params.locales[lang];\n          }\n        });\n\n        /**\n         * Retrieves a bibliographic item by ID for the citeproc engine\n         * @param {string} id\n         * @return {CslItemDTO}\n         */\n        function getBibliographyItem(id) {\n          var item = bibliographyItemSupplier(id)\n\n          if (!item) {\n            throw new Error('bibliography item supplier failed to return an item for id {' + id + '}');\n          }\n\n          return item;\n        }\n      }\n\n      /**\n       * Loads the locale with the given id\n       * Ensures corresponding supplier is called only once\n       * @return {Promise.<string>}\n       */\n      function loadLocale(localeId) {\n        if (!localeSuppliers.hasOwnProperty(localeId)) {\n          throw new Error('unknown locale ' + localeId);\n        }\n\n        if (!loadedLocales.hasOwnProperty(localeId)) {\n          var localeSupplier = localeSuppliers[localeId];\n          loadedLocales[localeId] = $injector.invoke(localeSupplier);\n        }\n\n        return loadedLocales[localeId];\n      }\n\n      /**\n       * Loads the style with the given id\n       * Ensures corresponding supplier is called only once\n       * @return {Promise.<string>}\n       */\n      function loadStyle(styleId) {\n        if (!styleSuppliers.hasOwnProperty(styleId)) {\n          throw new Error('unknown style ' + styleId);\n        }\n\n        if (!loadedStyles.hasOwnProperty(styleId)) {\n          var styleSupplier = styleSuppliers[styleId];\n          loadedStyles[styleId] = $injector.invoke(styleSupplier);\n        }\n\n        return loadedStyles[styleId];\n      }\n\n      /**\n       * Loads all locales by calling their suppliers and syncing all of the resulting promises.\n       * @return {Promise.<object.<string,string>>}\n       */\n      function loadLocales() {\n        var locales = _.mapValues(localeSuppliers, function (supplier, localeId) {\n          return loadLocale(localeId);\n        });\n\n        return $q.all(locales);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio', [\n      'ngResource'\n    ]);\n\n})();\n\n/**\n * Data model representing a person returned by the TRC REST API\n * @typedef Person\n * @type {object}\n * @property {string}           id       - a unique identifier for this person; assigned upon creation\n * @property {EntryMeta}        meta     - metadata about the record and its history in the system\n * @property {PersonName}       name     - primary name used to identify this person\n * @property {PersonName[]}     altNames - other names by which this person is known\n * @property {?HistoricalEvent} birth    - the date and location this person was born; may be null if unknown\n * @property {?HistoricalEvent} death    - the date and location this person was born; may be null if unknown or still alive\n * @property {string}           summary  - an HTML summary of the person and his or her significance\n */\n\n/**\n * Simplified, lightweight representation of a person for use in search results\n * @typedef Person\n * @type {object}\n * @property {string}     id             - a unique identifier for the person\n * @property {EntryMeta}  meta           - metadata about the record and its history in the system\n * @property {PersonName} name           - structured name representation\n * @property {string}     label          - formatted name to display\n * @property {string}     summaryExcerpt - a leading excerpt from the full summary\n */\n\n/**\n * Metadata about a TRC entry\n * @typedef EntryMeta\n * @type {object}\n * @property {string}                      slug         - a short, unique identifier intended to be more human-readable than the id\n * @property {integer}                     version      - a monotonically increasing version number incremented on each change\n * @property {object.<string, SimpleLink>} links        - links to related resources; keyed by link role\n * @property {string}                      lastModified - ISO 8601 timestamp of the last modification date\n */\n\n/**\n * Container for linking to related entities\n * @typedef SimpleLink\n * @type {object}\n * @property {string} uri  - a URI representing the linked item\n * @property {string} type - MIME type of the related linked item\n */\n\n/**\n * Structured form of a person's name\n * @typedef PersonName\n * @type {object}\n * @property {string} role        - clarifies the use of this name\n * @property {string} label       - a simple representation of this name for display purposes\n * @property {?string} title      - title of address\n * @property {?string} givenName  - given or first name\n * @property {?string} middleName - middle name\n * @property {?string} familyName - family or last name\n * @property {?string} suffix     - a suffix (e.g. 'Jr' or 'III')\n */\n\n/**\n * Event with a date/time, location, and descriptive information\n * @typedef HistoricalEvent\n * @type {object}\n * @property {string}          id          - a unique identifier for this event\n * @property {string}          title       - a brief title of the event for display purposes\n * @property {string}          description - a detailed summary of the event\n * @property {string}          location    - the location in which the event took place\n * @property {DateDescription} date        - the date the event took place\n */\n\n/**\n * Container for encapsulating human-readable and machine-readable forms of a date.\n * @typedef DateDescription\n * @type {object}\n * @property {string} calendar    - machine-readable ISO 8601 timestamp\n * @property {string} description - human-readable description of this date\n */\n\n/**\n * Container for search results\n * @typedef PersonSearchResultSet\n * @type {object}\n * @property {SimplePerson[]} items  - search results\n * @property {string}         qs     - query string that gives the current set of search results\n * @property {?string}        qsNext - query string that gives next set of search results or null if this is the last set\n * @property {?string}        qsPrev - query string that gives preceding set of search results or null if this is the first set\n */\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .provider('peopleRepo', peopleRepoProvider);\n\n\n  function peopleRepoProvider() {\n    var provider = {};\n    provider.url = '/api/people';\n    provider.$get = peopleRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function peopleRepoFactory($q, $resource) {\n      var restResource = $resource(provider.url + '/:id', null, {\n        'update': { method: 'PUT' }\n      });\n\n      var repo = {};\n      repo.getReferencesEndpoint = getReferencesEndpoint;\n      repo.create = createPerson;\n      repo.createName = createName;\n      repo.createEvent = createEvent;\n      repo.get = findById;\n      repo.search = search;\n      repo.save = savePerson;\n      repo.delete = deletePerson;\n      return repo;\n\n      /**\n       * Constructs a URL from which a bibliography for this entry can be loaded\n       *\n       * @return {string}\n       */\n      function getReferencesEndpoint(id) {\n        return provider.url + '/' + id + '/references';\n      }\n\n      /**\n       * Creates a new empty person instance.\n       *\n       * @return {Person}\n       */\n      function createPerson() {\n        var person = new restResource();\n        return adaptPerson(person);\n      }\n\n      /**\n       * Creates a new empty entry metadata instance\n       *\n       * @return {EntryMeta}\n       */\n      function createMeta() {\n        var meta = {};\n        return adaptMeta(meta);\n      }\n\n      /**\n       * Creates a new empty name instance\n       *\n       * @return {PersonName}\n       */\n      function createName() {\n        var name = {};\n        return adaptName(name);\n      }\n\n      /**\n       * Creates a new historical event instance\n       *\n       * @return {HistoricalEvent}\n       */\n      function createEvent() {\n        var evt = {};\n        return adaptEvent(evt);\n      }\n\n      /**\n       * Creates a date/description instance\n       *\n       * @return {DateDescription}\n       */\n      function createDateDescription() {\n        var dateDescription = {};\n        return dateDescription;\n      }\n\n      /**\n       * Retrieves a person object by identifier.\n       *\n       * A proxy object will be returned immediately, and its properties will be populated after the\n       * request succeeds. If fine-grained asynchronous handling, etc. is required, the request's\n       * promise is available on Person.$promise.\n       *\n       * @param  {string} id\n       * @return {Person}\n       */\n      function findById(id) {\n        return restResource.get({ id: id });\n      }\n\n      /**\n       * Retrieves a serch result set of people who match the given query.\n       *\n       * @param {string} query\n       * @return {PersonSearchResultSet}\n       */\n      function search(query) {\n        return restResource.get({ q: query });\n      }\n\n      /**\n       * Saves a person model to the REST API.\n       *\n       * If no ID is provided on the person model, the API will create save the model as a new\n       * person. Otherwise, the API will attempt to update the existing person model with that ID.\n       *\n       * @param {Person} person\n       * @return {Promise.<Person>} - resolves to the saved person on success\n       */\n      function savePerson(person) {\n        var response;\n        if (person.id) {\n          response = restResource.update({ id: person.id }, person);\n        } else {\n          response = restResource.save(null, person);\n        }\n\n        return response.$promise.then(function (personId) {\n          person.id = personId.id;\n          return person;\n        });\n      }\n\n      /**\n       * Deletes a person on the server via the REST API.\n       *\n       * @param {Person|string} id\n       * @return {Promise} - resolves on success\n       */\n      function deletePerson(id) {\n        if (angular.isObject(id) && id.id) {\n          id = id.id;\n        }\n\n        var response = restResource.delete({ id: id });\n        return response.$promise;\n      }\n\n      /**\n       * Populates a person with aggregate fields\n       *\n       * @param  {Person} person\n       * @return {Person}\n       */\n      function adaptPerson(person) {\n        if (!person.meta) {\n          person.meta = createMeta();\n        } else {\n          adaptMeta(person.meta);\n        }\n\n        if (!person.name) {\n          person.name = createName();\n        } else {\n          adaptName(person.name);\n        }\n\n        if (!person.altNames) {\n          person.altNames = [];\n        } else {\n          person.altNames.forEach(adaptName);\n        }\n\n        if (!person.birth) {\n          person.birth = createEvent();\n        } else {\n          adaptEvent(person.birth);\n        }\n\n        if (!person.death) {\n          person.death = createEvent();\n        } else {\n          adaptEvent(person.death);\n        }\n\n        return person\n      }\n\n      /**\n       * Ensure that entry metadata aggregate fields exist and are formatted correctly.\n       *\n       * @param  {EntryMeta} meta\n       * @return {EntryMeta}\n       */\n      function adaptMeta(meta) {\n        if (!meta.links) {\n          meta.links = {};\n        }\n\n        return meta;\n      }\n\n      /**\n       * Ensure that name aggregate fields exist and are formatted correctly\n       * @param  {PersonName} name\n       * @return {PersonName}\n       */\n      function adaptName(name) {\n        // no aggregate fields yet...\n        return name;\n      }\n\n      /**\n       * Ensure that event aggregate fields exist and are formatted correctly.\n       *\n       * @param  {HistoricalEvent} evt\n       * @return {HistoricalEvent}\n       */\n      function adaptEvent(evt) {\n        if (!evt.date) {\n          evt.date = createDateDescription();\n        }\n\n        return evt;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcPersonEditor', trcPersonEditorDirective);\n\n  /** @ngInject */\n  function trcPersonEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/person-editor.html',\n      scope: {\n        person: '=ngModel'\n      },\n      controller: PersonEditorController,\n      controllerAs: 'personEditor'\n    };\n\n    return directive;\n\n    /** @ngInject */\n    function PersonEditorController($scope, peopleRepo) {\n      var vm = this;\n\n      vm.addName = addName;\n      vm.removeName = removeName;\n      vm.addEvent = addEvent;\n      vm.removeEvent = removeEvent;\n\n      /**\n       * Adds a name to the current person model.\n       */\n      function addName() {\n        var newName = peopleRepo.createName();\n        $scope.person.altNames.push(newName);\n      }\n\n      /**\n       * Removes the name at the specified index from the current person model.\n       *\n       * @param {integer} ix\n       */\n      function removeName(ix) {\n        $scope.person.altNames.splice(ix, 1);\n      }\n\n      /**\n       * Adds an event to the current person model.\n       *\n       * @param {string} key - 'birth' or 'death'\n       */\n      function addEvent(key) {\n        var newEvent = peopleRepo.createEvent();\n        $scope.person[key] = newEvent;\n      }\n\n      /**\n       * Removes the event from the current person model.\n       *\n       * @param {string} key - 'birth' or 'death'\n       */\n      function removeEvent(key) {\n        $scope.person[key] = null;\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcNameEditor', trcNameEditorDirective);\n\n  /** @ngInject */\n  function trcNameEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/name-editor.html',\n      scope: {\n        name: '=ngModel'\n      },\n      controller: NameEditorController,\n      controllerAs: 'nameEditor'\n    };\n\n    return directive;\n\n    function NameEditorController() {\n      var vm = this;\n\n      vm.roles = [\n        { value: 'canonical', label: 'Canonical Name' },\n        { value: 'pseudonym', label: 'Pseudonym' },\n        { value: 'maiden', label: 'Maiden Name' },\n        { value: 'designation', label: 'Honorary Designation' },\n        { value: 'nickname', label: 'Nickname' },\n        { value: 'phonetic', label: 'Phonetic Name' }\n      ];\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcBio')\n    .directive('trcEventEditor', trcEventEditorDirective);\n\n  /** @ngInject */\n  function trcEventEditorDirective() {\n    var directive = {\n      restrict: 'E',\n      templateUrl: 'app/trc-bio/event-editor.html',\n      scope: {\n        event: '=ngModel'\n      }\n    };\n\n    return directive;\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcArticles', [\n      'ngResource',\n      'uuid4',\n      'trcRefs'\n    ]);\n\n})();\n\n// TODO add JSDoc for the various classes that will be defined\n\n(function () {\n  'use strict';\n\n  angular\n    .module('trcArticles')\n    .provider('articlesRepo', articlesRepoProvider);\n\n  function articlesRepoProvider() {\n    var provider = {};\n    provider.url = '/api/articles';\n    provider.$get = articlesRepoFactory;\n    return provider;\n\n    /** @ngInject */\n    function articlesRepoFactory($resource, _, uuid4) {\n      var articleResource = $resource(provider.url + '/:id', { id: '@id' }, {\n        update: { method: 'PUT' }\n      });\n\n      var repo = {};\n      repo.getReferencesEndpoint = getReferencesEndpoint;\n      repo.create = createArticle;\n      repo.createFootnote = createFootnote;\n      repo.get = getArticle;\n      repo.save = saveArticle;\n      repo.delete = deleteArticle;\n      repo.cleanReferences = cleanReferences;\n      repo.cleanFootnotes = cleanFootnotes;\n      return repo;\n\n      /* ================================\n       * API METHODS\n       * ================================ */\n\n      /**\n       * Constructs an API endpoint where a given article's reference collection is stored\n       * @param {string} articleId\n       * @return {string}\n       */\n      function getReferencesEndpoint(articleId) {\n        return provider.url + '/' + articleId + '/references';\n      }\n\n      /**\n       * Creates a new article instance\n       * @param  {string} type\n       * @param  {string} title\n       * @return {Article}\n       */\n      function createArticle(type, title) {\n        return new articleResource({\n          articleType: type,\n          title: title\n        });\n      }\n\n      /**\n       * Creates a new footnote instance\n       * @return {Footnote}\n       */\n      function createFootnote() {\n        return {\n          id: uuid4.generate(),\n          content: '',\n          mimeType: 'text/html'\n        };\n      }\n\n      /**\n       * Fetches an article instance by id.\n       * The resulting Article object will be populated asynchronously when its `.$promise` completes.\n       * @param  {string} id\n       * @return {Article}\n       */\n      function getArticle(id) {\n        return articleResource.get({ id: id });\n      }\n\n      /**\n       * Saves an article to the REST API\n       * @param  {Article} article\n       * @return {Promise.<Article>}\n       */\n      function saveArticle(article) {\n        if (!(article instanceof articleResource)) {\n          throw new Error('Article was not created by this repo');\n        }\n\n        return article.id ? article.$update() : article.$save();\n      }\n\n      /**\n       * Delete an article by id\n       * @param  {string|Article} id\n       * @return {Promise}\n       */\n      function deleteArticle(id) {\n        if (angular.isObject(id) && id.id) {\n          id = id.id;\n        }\n\n        var res = articleResource.delete({ id: id });\n        return res.$promise\n      }\n\n      /**\n       * Removes unused citations and bibliographic items.\n       * @param  {Article} article\n       * @param  {ReferenceCollection} refs\n       * @return {ReferenceCollection} newly cleaned reference collection\n       */\n      function cleanReferences(article, refs) {\n        // create large text blob of all article content\n        var fullContent = article.body + _.map(article.footnotes, 'content').join('');\n\n        // delete ids that do not occur within article content\n        for (var citeId in refs.citations) if (refs.citations.hasOwnProperty(citeId) && fullContent.indexOf(citeId) < 0) {\n          delete refs.citations[citeId];\n        }\n\n        return refs;\n      }\n\n      /**\n       * Removes unused footnotes.\n       * @param {Article} article\n       * @param {object.<string, Footnote>} footnotes\n       * @return {object.<string, Footnote>} newly cleaned footnotes\n       */\n      function cleanFootnotes(article, footnotes) {\n        for (var footnoteId in footnotes) if (footnotes.hasOwnProperty(footnoteId) && article.body.indexOf(footnoteId) < 0) {\n          delete footnotes[footnoteId];\n        }\n\n        return footnotes;\n      }\n\n      /* ================================\n       * PRIVATE METHODS\n       * ================================ */\n    }\n  }\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('TaskController', TaskController);\n\n  /** @ngInject */\n  function TaskController($mdSidenav, $mdToast, tasksRepo) {\n    var vm = this;\n\n    vm.loading = false;\n\n    vm.openMenu = openMenu;\n\n    activate();\n\n    function activate() {\n      vm.loading = true;\n      vm.tasks = tasksRepo.all();\n\n      vm.tasks.$promise.then(function () {\n        vm.loading = false;\n      }, function () {\n        vm.loading = false;\n        $mdToast.show($mdToast.simple().textContent('Unable to load tasks from server'));\n      });\n    }\n\n    function openMenu() {\n      $mdSidenav('left').toggle();\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ShowTaskController', ShowTaskController);\n\n  /** @ngInject */\n  function ShowTaskController($state, $stateParams, $mdSidenav, tasksRepo, $q) {\n    var vm = this;\n\n    // HACK this will eventually be made available on the workflow data model itself.\n    vm.stageOrder = [\n      'pinned',\n      'inprogress',\n      'review',\n      'pending',\n      'deferred'\n    ];\n\n    vm.loading = true;\n    vm.worklists = {};\n    vm.task = null;\n\n    vm.focusItem = focusItem;\n    vm.transition = transitionItem;\n\n    activate();\n\n    function activate() {\n      vm.taskId = $stateParams.taskId;\n      vm.task = tasksRepo.getTask(vm.taskId);\n      vm.workflow = tasksRepo.getWorkflow(vm.taskId);\n\n      vm.workflow.$promise.then(function () {\n        var worklistPromises = [];\n\n        angular.forEach(vm.workflow.stages, function (stage) {\n          var worklistPromise = fetchStage(stage.id);\n          worklistPromises.push(worklistPromise);\n        });\n\n        $q.all(worklistPromises).then(function () {\n          vm.loading = false;\n        });\n      });\n    }\n\n    function focusItem(item, $event) {\n      $event.stopImmediatePropagation();\n\n      // TODO resolve handler based on item.type\n      $state.go('editor.work', { workId: item.entityId });\n    }\n\n    function transitionItem(item, transition, $event) {\n      $event.stopImmediatePropagation();\n\n      var updatedItem = tasksRepo.transition(vm.taskId, item, transition);\n      updatedItem.$promise.then(function () {\n        fetchStage(transition.sourceStage);\n        fetchStage(transition.targetStage);\n      });\n    }\n\n    function fetchStage(stageId) {\n      var group = tasksRepo.getItems(vm.taskId, stageId, { max: 9999 });\n\n      group.$promise.then(function () {\n        vm.worklists[stageId] = group.items.length > 0 ? group : null;\n      });\n\n      return group.$promise;\n    }\n  }\n\n})();\n\n(function() {\n  'use strict';\n\n  angular\n    .module('slideToggle', []);\n\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('slideToggle')\n      .directive('slideToggle', slideToggle);\n\n   /** @ngInject */\n   function slideToggle() {\n      var directive = {\n         restrict: 'A',\n         scope: {\n            active: '=slideToggle'\n         },\n         link: linkFunc\n      };\n\n      return directive;\n\n      function linkFunc(scope, el, attr) {\n         var duration = parseInt(attr.slideToggleDuration) || 200;\n         scope.$watch('active', function (active) {\n            if (active) {\n               el.stop().slideDown(duration);\n            } else {\n               el.stop().slideUp(duration);\n            }\n         })\n      }\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('ShowPersonController', ShowPersonController);\n\n  /** @ngInject */\n  function ShowPersonController(peopleRepo, refsRepoFactory, $log, $state, $stateParams, $mdDialog, $mdToast, _, citationEditDialog) {\n    var refsRepo = null;\n    var vm = this;\n\n    vm.loading = true;\n    vm.person = null;\n\n    vm.editBioInfo = editBioInfo;\n    vm.editEvent = editEvent;\n    vm.editSummary = editSummary;\n    vm.editBibliography = editBibliography;\n    vm.deletePerson = deletePerson;\n\n    activate();\n\n    function activate() {\n      var personId = $stateParams.id;\n\n      var personRefsUrl = peopleRepo.getReferencesEndpoint(personId);\n      refsRepo = refsRepoFactory.getRepo(personRefsUrl);\n\n      vm.person = peopleRepo.get(personId);\n      vm.references = refsRepo.get();\n\n      vm.references.$promise.then(function () {\n        var citations = _.values(vm.references.citations);\n\n        if (citations.length === 0) {\n          vm.citation = refsRepo.createCitation();\n          vm.references.citations[vm.citation.id] = vm.citation;\n        } else {\n          if (citations.length > 1) {\n            $log.warn('reference collection contains ' + citations.length + ' citations');\n          }\n          vm.citation = citations[0];\n        }\n      })\n    }\n\n    function editBioInfo($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/person/person-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          person: angular.copy(vm.person)\n        },\n        controller: 'PersonEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedPerson) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        angular.extend(vm.person, updatedPerson);\n\n        peopleRepo.save(vm.person).then(showSavedToast);\n      });\n    }\n\n    function editEvent(field, $event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/person/event-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation\n          event: angular.copy(vm.person[field])\n        },\n        controller: 'EventEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedEvent) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        angular.extend(vm.person[field], updatedEvent);\n\n        peopleRepo.save(vm.person).then(showSavedToast);\n      });\n    }\n\n    function editSummary($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/components/summary-edit-dialog/summary-edit-dialog.html',\n        locals: {\n          // create a copy for manipulation (even if it is just a string)\n          summary: angular.copy(vm.person.summary)\n        },\n        controller: 'SummaryEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      dialogPromise.then(function (updatedSummary) {\n        // copy updates back to original only after dialog is positively dismissed (i.e. not canceled)\n        vm.person.summary = updatedSummary;\n\n        peopleRepo.save(vm.person).then(showSavedToast);\n      });\n    }\n\n    function editBibliography($event) {\n      citationEditDialog.show(vm.references, null, $event).then(function () {\n        refsRepo.save(vm.references).then(showSavedToast);\n      });\n    }\n\n    function deletePerson($event, person) {\n      var nameLabel = person.name.label ? '\"' + person.name.label + '\"' : 'this person';\n\n      var confirmDialog = $mdDialog.confirm({\n        targetEvent: $event,\n        title: 'Confirm Deletion',\n        textContent: 'Are you sure you want to delete ' + nameLabel + '?',\n        ok: 'Yes',\n        cancel: 'No'\n      });\n\n      var confirmPromise = $mdDialog.show(confirmDialog);\n\n      return confirmPromise.then(function () {\n        return peopleRepo.delete(person)\n          .then(showSuccessToast, showErrorToast);\n      });\n\n      function showSuccessToast() {\n        var message = nameLabel + ' has been deleted.';\n        var toast = $mdToast.simple()\n          .textContent(message)\n          .position('bottom right');\n\n        $state.go('editor');\n\n        return $mdToast.show(toast);\n      }\n\n      function showErrorToast() {\n        var toast = $mdToast.simple()\n          .textContent('Unable to delete ' + nameLabel)\n          .position('bottom right');\n\n        return $mdToast.show(toast);\n      }\n    }\n\n    function showSavedToast() {\n      var toast = $mdToast.simple()\n        .textContent('Saved')\n        .position('bottom right');\n\n      return $mdToast.show(toast);\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('PersonEditDialogController', PersonEditDialogController);\n\n  /** @ngInject */\n  function PersonEditDialogController(peopleRepo, $mdDialog, person) {\n    var vm = this;\n\n    vm.person = person;\n    vm.nameRoles = [\n        // { value: 'canonical', label: 'Canonical Name' },\n        { value: 'pseudonym', label: 'Pseudonym' },\n        { value: 'maiden', label: 'Maiden Name' },\n        { value: 'designation', label: 'Honorary Designation' },\n        { value: 'nickname', label: 'Nickname' },\n        { value: 'phonetic', label: 'Phonetic Name' }\n    ]\n\n    vm.close = close;\n    vm.cancel = cancel;\n    vm.addName = addName;\n    vm.deleteName = deleteName;\n\n    function close() {\n      $mdDialog.hide(vm.person);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n\n    function addName() {\n      var name = peopleRepo.createName();\n      vm.person.altNames.push(name);\n    }\n\n    function deleteName(name) {\n      var ix = vm.person.altNames.indexOf(name);\n      if (ix >= 0) {\n        vm.person.altNames.splice(ix, 1);\n      }\n    }\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('EventEditDialogController', EventEditDialogController);\n\n  /** @ngInject */\n  function EventEditDialogController($mdDialog, event) {\n    var vm = this;\n\n    vm.event = event;\n\n    vm.close = close;\n    vm.cancel = cancel;\n\n    function close() {\n      $mdDialog.hide(vm.event);\n    }\n\n    function cancel() {\n      $mdDialog.cancel();\n    }\n  }\n\n})();\n\n(function() {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .controller('MainController', MainController);\n\n  /** @ngInject */\n  function MainController(worksRepo, peopleRepo, $state, $stateParams, $mdSidenav, _, $q, $mdDialog, $mdToast) {\n    var vm = this;\n\n    vm.loading = false;\n    vm.searchQuery = '';\n\n    vm.openMenu = openMenu;\n    vm.createPerson = createPerson;\n    vm.createWork = createWork;\n    vm.search = _.debounce(search, 300);\n\n    activate();\n\n    function activate() {\n      if ($stateParams.q) {\n        vm.searchQuery = $stateParams.q;\n        search(vm.searchQuery);\n      }\n    }\n\n    function openMenu() {\n      $mdSidenav('left').toggle();\n    }\n\n    function search(query) {\n      vm.loading = true;\n\n      vm.peopleResults = peopleRepo.search(query);\n      vm.worksResults = worksRepo.search(query);\n\n      $q.all([\n        vm.peopleResults.$promise,\n        vm.worksResults.$promise\n      ])\n        .then(function () {\n          vm.loading = false;\n        });\n    }\n\n    function createArticle($event) {\n\n    }\n    \n    function createPerson($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/person/person-edit-dialog.html',\n        locals: {\n          person: peopleRepo.create()\n        },\n        controller: 'PersonEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      var savePromise = dialogPromise.then(function (person) {\n        return peopleRepo.save(person);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function (person) {\n        $state.go('editor.person', { id: person.id });\n      });\n    }\n\n    function createWork($event) {\n      var dialog = {\n        targetEvent: $event,\n        templateUrl: 'app/work/work-edit-dialog.html',\n        locals: {\n          work: worksRepo.createWork()\n        },\n        controller: 'WorkEditDialogController',\n        controllerAs: 'vm'\n      };\n\n      var dialogPromise = $mdDialog.show(dialog);\n\n      var savePromise = dialogPromise.then(function (work) {\n        return worksRepo.saveWork(work);\n      });\n\n      savePromise.then(showSavedToast);\n\n      savePromise.then(function (work) {\n        $state.go('editor.work', { workId: work.id });\n      });\n    }\n\n    function showSavedToast() {\n      var toast = $mdToast.simple()\n        .textContent('Saved')\n        .position('bottom right');\n\n      return $mdToast.show(toast);\n    }\n  }\n})();\n\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books', []);\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .provider('googleBooksApi', googleBooksApiProvider);\n\n   function googleBooksApiProvider() {\n      var API = {};\n\n      API.options = {\n         transport: 'https',\n         v: 0,\n         language: 'en',\n         preventLoad: false\n      };\n\n      API.configure = configure;\n      API.$get = loadGoogleBooks;\n\n      return API;\n\n      function configure(options) {\n         angular.extend(API.options, options);\n      }\n\n      /** @ngInject */\n      function loadGoogleBooks(googleBooksScriptLoader) {\n         return googleBooksScriptLoader.load(API.options);\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .factory('googleBooksScriptLoader', googleBooksScriptLoader);\n\n   /** @ngInject */\n   function googleBooksScriptLoader($window, $document, $q, _) {\n      var scriptId = undefined;\n      var usedConfiguration = undefined;\n\n      return {\n         load: load,\n         manualLoad: manualLoad\n      };\n\n      /**\n       * Get script URL for loading Google Books API\n       *\n       * @param {object} options\n       * @return {string}\n       */\n      function getScriptUrl(options) {\n         if (options.transport === 'auto') {\n            return '//www.google.com/books/api.js?';\n         } else {\n            return options.transport + '://www.google.com/books/api.js?';\n         }\n      }\n\n      function includeScript(options) {\n         var omitOptions = ['transport', 'preventLoad', 'randomizedFunctionName'];\n\n         var query = _.map(_.omit(options, omitOptions), function (v, k) { return k + '=' + v });\n\n         if (scriptId) {\n            var scriptElem = $document.getElementById(scriptId)\n            scriptElem.parentNode.removeChild(scriptElem);\n         } else {\n            scriptId = 'gbooks_load_' + Math.round(Math.random() * 1000);\n         }\n\n         query = query.join('&');\n         angular.element('<script>', {\n            id: scriptId,\n            type: 'text/javascript',\n            src: getScriptUrl(options) + query\n         }).appendTo(angular.element('body'));\n      }\n\n      function isGoogleBooksLoaded() {\n         return angular.isDefined($window.google) && angular.isDefined($window.google.books);\n      }\n\n      function load(options) {\n         var deferred = $q.defer();\n\n         if (isGoogleBooksLoaded()) {\n            deferred.resolve($window.google.books);\n            return deferred.promise;\n         }\n\n         var randomizedFunctionName = 'onGoogleBooksReady' + Math.round(Math.random() * 1000);\n         options.callback = randomizedFunctionName;\n\n         $window[randomizedFunctionName] = function () {\n            $window[randomizedFunctionName] = null;\n            deferred.resolve($window.google.books);\n         }\n\n         if (!options.preventLoad) {\n            includeScript(options);\n         }\n\n         usedConfiguration = options;\n         usedConfiguration.randomizedFunctionName = randomizedFunctionName;\n\n         return deferred.promise;\n      }\n\n      function manualLoad() {\n         var config = usedConfiguration;\n\n         if (!isGoogleBooksLoaded()) {\n            includeScript(config);\n         } else if ($window[config.randomizedFunctionName]) {\n            $window[config.randomizedFunctionName]();\n         }\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .directive('googleBookReader', googleBookReader);\n\n   /** @ngInject */\n   function googleBookReader(googleBooksApi, googleBooksApiManualLoader) {\n      var directive = {\n         restrict: 'E',\n         link: linkFunc,\n         scope: {\n            properties: '='\n         }\n      };\n\n      return directive;\n\n      function linkFunc(scope, el) {\n         googleBooksApiManualLoader.load();\n         googleBooksApi.then(function (books) {\n            var viewer = new books.DefaultViewer(el.get(0));\n\n            scope.$watch('properties', function (properties) {\n               viewer.load(properties.id);\n            });\n\n            scope.$on('resize', function () {\n               viewer.resize();\n            });\n         });\n      }\n   }\n\n})();\n\n/**\n * Inspired by https://github.com/angular-ui/angular-google-maps/blob/f7c17e4336344afe9c31ca8b8a1e200e268f4979/src/coffee/providers/map-loader.coffee\n */\n(function () {\n   'use strict';\n\n   angular\n      .module('google.books')\n      .service('googleBooksApiManualLoader', googleBooksApiManualLoader);\n\n   /** @ngInject */\n   function googleBooksApiManualLoader(googleBooksScriptLoader) {\n      var API = {};\n\n      API.load = load;\n\n      return API;\n\n      function load() {\n         googleBooksScriptLoader.manualLoad();\n      }\n   }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .run(runBlock);\n\n  /** @ngInject */\n  function runBlock($log) {\n    $log.debug('runBlock end');\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .config(routerConfig);\n\n  /** @ngInject */\n  function routerConfig($stateProvider, $urlRouterProvider) {\n    $stateProvider\n      .state('editor', {\n        url: '/?q',\n        templateUrl: 'app/main/main.html',\n        controller: 'MainController',\n        controllerAs: 'vm'\n      })\n\n      .state('editor.person', {\n        url: 'people/:id',\n        views: {\n          main: {\n            templateUrl: 'app/person/person.html',\n            controller: 'ShowPersonController',\n            controllerAs: 'vm'\n          }\n        }\n      })\n\n      .state('editor.work', {\n        url: 'works/:workId',\n        views: {\n          main: {\n            templateUrl: 'app/work/work.html',\n            controller: 'ShowWorkController',\n            controllerAs: 'vm'\n          }\n        }\n      })\n      .state('editor.edition', {\n        url: 'works/:workId/editions/:editionId',\n        views: {\n          main: {\n            templateUrl: 'app/work/edition.html',\n            controller: 'ShowEditionController',\n            controllerAs: 'vm'\n          }\n        }\n      })\n      .state('editor.volume', {\n        url: 'works/:workId/editions/:editionId/volumes/:volumeId',\n        views: {\n          main: {\n            templateUrl: 'app/work/volume.html',\n            controller: 'ShowVolumeController',\n            controllerAs: 'vm'\n          }\n        }\n      })\n\n      .state('article', {\n        url: '/articles',\n        templateUrl: 'app/admin/editors/articles/article.html',\n        controller: 'ArticleEditorSectionController',\n        controllerAs: 'vm'\n      })\n\n      .state('article.edit', {\n        url: '/:id',\n        templateUrl: 'app/admin/editors/articles/article-editor.html',\n        controller: 'ArticleEditorController',\n        controllerAs: 'vm'\n      })\n\n      .state('task', {\n        url: '/task',\n        templateUrl: 'app/task/task.html',\n        controller: 'TaskController',\n        controllerAs: 'vm'\n      })\n\n      .state('task.show', {\n        url: '/:taskId',\n        templateUrl: 'app/task/show.html',\n        controller: 'ShowTaskController',\n        controllerAs: 'vm'\n      })\n\n      .state('vwise', {\n        url: '/vwise/:workspaceId',\n        templateUrl: 'app/vwise/workspace.html',\n        controller: 'WorkspaceController',\n        controllerAs: 'vm'\n      })\n\n      .state('zotero', {\n        url: '/zotero',\n        templateUrl: 'app/zotero/test/test.html',\n        controller: 'ZoteroTestController',\n        controllerAs: 'vm'\n      });\n\n\n\n    $urlRouterProvider.otherwise('/');\n  }\n\n})();\n\n/* global _:false, moment:false */\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .constant('_', _)\n    .constant('moment', moment);\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .config(config);\n\n  /** @ngInject */\n  function config($logProvider, /* toastrConfig, */ $mdThemingProvider,\n                  tasksRepoProvider,\n                  worksRepoProvider,\n                  peopleRepoProvider,\n                  articlesRepoProvider,\n                  relationshipsRepoProvider,\n                  categorizationServiceProvider) {\n    // Enable log\n    $logProvider.debugEnabled(true);\n\n    $mdThemingProvider.definePalette('darkBrown', {\n      '50': '#595c59',\n      '100': '#4c4f4c',\n      '200': '#404240',\n      '300': '#333533',\n      '400': '#272827',\n      '500': '#1a1b1a',\n      '600': '#0d0e0d',\n      '700': '#010101',\n      '800': '#000000',\n      '900': '#000000',\n      'A100': '#e0f0e0',\n      'A200': '#565956',\n      'A400': '#7e837e',\n      'A700': '#000000',\n\n      contrastDefaultColor: 'light',\n      contrastDarkColors: ['A100']\n    });\n\n    $mdThemingProvider.definePalette('copper', {\n      '50': '#d4b190',\n      '100': '#cca47e',\n      '200': '#c5976b',\n      '300': '#be8a59',\n      '400': '#b67e47',\n      '500': '#a47140',\n      '600': '#926439',\n      '700': '#7f5832',\n      '800': '#6d4b2b',\n      '900': '#5b3e23',\n      'A100': '#dcc3ab',\n      'A200': '#a47140',\n      'A400': '#48321c',\n      'A700': '#272927',\n\n      contrastDefaultColor: 'light',\n      contrastDarkColors: ['50', '100', '200', 'A100']\n    });\n\n    $mdThemingProvider.theme('default')\n      .primaryPalette('darkBrown')\n      .accentPalette('copper');\n\n\n    tasksRepoProvider.url = '/api/catalog/v1/tasks';\n    worksRepoProvider.url = '/api/catalog/works';\n    peopleRepoProvider.url = '/api/catalog/people';\n    articlesRepoProvider.url = '/api/catalog/entries/articles';\n    relationshipsRepoProvider.url = '/api/catalog/relationships';\n    categorizationServiceProvider.url = '/api/catalog/categorizations';\n  }\n\n})();\n\n(function () {\n  'use strict';\n\n  angular\n    .module('sdaAdminWeb')\n    .config(config);\n\n  /** @ngInject */\n  function config(citeprocProvider) {\n    addLocale('en-US');\n    addStyle('modern-language-association');\n\n    function addLocale(localeId) {\n      citeprocProvider.addLocale(localeId, supplier);\n\n      /** @ngInject */\n      function supplier($http) {\n        return $http.get('assets/csl/locales/locales-' + localeId + '.xml').then(function (res) {\n          return res.data;\n        });\n      }\n    }\n\n    function addStyle(styleId) {\n      citeprocProvider.addStyle(styleId, supplier);\n\n      /** @ngInject */\n      function supplier($http) {\n        return $http.get('assets/csl/styles/' + styleId + '.csl').then(function (res) {\n          return res.data;\n        });\n      }\n    }\n  }\n\n})();\n\nangular.module(\"sdaAdminWeb\").run([\"$templateCache\", function($templateCache) {$templateCache.put(\"app/main/main.html\",\"<md-content flex layout=column><navbar title=\\\"Editorial Tools\\\" sidenav-id=left></navbar><md-content flex layout=row><md-sidenav md-component-id=left md-is-locked-open=\\\"$mdMedia(\\'gt-sm\\')\\\" ui-view=sidebar layout=column><form layout=row flex=none><md-input-container flex><label for=searchQuery>Search</label><md-icon>search</md-icon><input type=search name=searchQuery id=searchQuery ng-model=vm.searchQuery ng-change=vm.search(vm.searchQuery) required></md-input-container></form><md-content flex><div ng-if=vm.loading layout=row layout-align=center><md-progress-circular md-mode=indeterminate></md-progress-circular></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.peopleResults &amp;&amp; vm.peopleResults.items.length > 0\\\"><md-subheader>People</md-subheader><md-list><md-list-item ng-repeat=\\\"person in vm.peopleResults.items\\\" ui-sref=\\\"editor.person({id: person.id})\\\"><div class=md-list-item-text><span>{{person.label}}</span></div></md-list-item></md-list></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.worksResults &amp;&amp; vm.worksResults.items.length > 0\\\"><md-subheader>Works</md-subheader><md-list><md-list-item ng-repeat=\\\"work in vm.worksResults.items\\\" ui-sref=\\\"editor.work({workId: work.id})\\\"><div class=md-list-item-text><span>{{work.label}}</span></div></md-list-item></md-list></div></md-content><md-fab-speed-dial md-direction=up class=\\\"md-scale md-fab-bottom-right md-fab-straddle\\\"><md-fab-trigger><md-button aria-label=New... class=md-fab><md-icon>add</md-icon></md-button></md-fab-trigger><md-fab-actions><md-button aria-label=\\\"New Article\\\" class=\\\"md-fab md-mini\\\" ng-click=vm.createArticle($event)><md-tooltip md-direction=left>New Article</md-tooltip><md-icon>description</md-icon></md-button><md-button aria-label=\\\"New Person\\\" class=\\\"md-fab md-mini\\\" ng-click=vm.createPerson($event)><md-tooltip md-direction=left>New Person</md-tooltip><md-icon>person</md-icon></md-button><md-button aria-label=\\\"New Work\\\" class=\\\"md-fab md-mini\\\" ng-click=vm.createWork($event)><md-tooltip md-direction=left>New Book</md-tooltip><md-icon>book</md-icon></md-button></md-fab-actions></md-fab-speed-dial></md-sidenav><md-content flex layout=column ui-view=main></md-content></md-content></md-content>\");\n$templateCache.put(\"app/person/event-edit-dialog.html\",\"<md-dialog flex=80><md-toolbar><div class=md-toolbar-tools><h3>Event Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><event-editor ng-model=vm.event flex></event-editor></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/person/person-edit-dialog.html\",\"<md-dialog flex=80><md-toolbar><div class=md-toolbar-tools><h3>Biographic Information Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><section class=name layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Canonical Name</h2></div></md-toolbar><div class=name><name-editor ng-model=vm.person.name flex></name-editor></div></section><section class=alt-names layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Alternate Names</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addName()><md-icon>add</md-icon></md-button></div></md-toolbar><div class=name layout=row ng-repeat=\\\"name in vm.person.altNames\\\"><md-input-container><label>role</label><md-select ng-model=name.role><md-option ng-repeat=\\\"role in vm.nameRoles\\\" value={{role.value}}>{{role.label}}</md-option></md-select></md-input-container><name-editor ng-model=name flex></name-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=vm.deleteName(name)><md-icon>delete</md-icon></md-button></md-input-container></div></section></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/person/person.html\",\"<div layout=row layout-padding flex=noshrink><div flex=60><section class=\\\"content names\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h1 class=content-heading>{{vm.person.name.label}}</h1><span flex></span><md-button class=md-icon-button ng-click=vm.editBioInfo($event)><md-icon>edit</md-icon></md-button></div><div ng-if=\\\"vm.person.altNames && vm.person.altNames.length > 0\\\"><p>Other names:</p><ul><li ng-repeat=\\\"name in vm.person.altNames\\\">{{name.label}}</li></ul></div></section><section class=\\\"content summary\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Summary</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editSummary($event)><md-icon>edit</md-icon></md-button></div><p ng-if=vm.person.summary ng-bind-html=vm.person.summary></p></section><section class=\\\"content bibliography\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Bibliography</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editBibliography($event)><md-icon>edit</md-icon></md-button></div><bibliography collection=vm.references></bibliography></section></div><div flex=40><section class=\\\"content birth\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Birth</h2><span flex></span><md-button class=md-icon-button ng-click=\\\"vm.editEvent(\\'birth\\', $event)\\\"><md-icon>edit</md-icon></md-button></div><p><span class=description ng-if=vm.person.birth.date.description>{{vm.person.birth.date.description}}</span> <span class=location ng-if=vm.person.birth.location>in {{vm.person.birth.location}}</span></p><p ng-bind-html=vm.person.birth.description ng-if=vm.person.birth.description></p></section><section class=\\\"content death\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Death</h2><span flex></span><md-button class=md-icon-button ng-click=\\\"vm.editEvent(\\'death\\', $event)\\\"><md-icon>edit</md-icon></md-button></div><p><span class=description ng-if=vm.person.death.date.description>{{vm.person.death.date.description}}</span> <span class=location ng-if=vm.person.death.location>in {{vm.person.death.location}}</span></p><p ng-bind-html=vm.person.death.description ng-if=vm.person.death.description></p></section></div></div><div layout=row layout-align=end layout-margin><div><md-button aria-label=\\\"Delete this person\\\" class=\\\"md-warn md-icon-button\\\" ng-click=\\\"vm.deletePerson($event, vm.person)\\\"><md-icon>delete</md-icon><md-tooltip md-direction=left>Delete</md-tooltip></md-button></div></div>\");\n$templateCache.put(\"app/task/show.html\",\"<md-content flex layout=column><div class=task-info><span class=label>{{vm.task.label}}</span> <span class=description>{{vm.task.description}}</span></div><md-input-container><label>Search</label><md-icon>search</md-icon><input type=search ng-model=filter ng-change=vm.search(filter)></md-input-container><md-content flex><div layout=row layout-align=\\\"center center\\\" ng-if=vm.loading><md-progress-circular md-mode=indeterminate></md-progress-circular></div><div ng-repeat=\\\"stageId in vm.stageOrder\\\" ng-if=vm.worklists[stageId]><md-subheader>{{vm.workflow.stages[stageId].label}}</md-subheader><md-list><md-list-item ng-repeat=\\\"item in vm.worklists[stageId].items | filter : filter | limitTo : 20\\\" ng-mouseover=\\\"item.hover = true\\\" ng-mouseout=\\\"item.hover = false\\\" ng-click=\\\"vm.focusItem(item, $event)\\\"><span ng-bind-html=item.label></span> <span flex></span><md-button class=md-exclude ng-repeat=\\\"transition in vm.workflow.stages[stageId].transitions\\\" ng-click=\\\"vm.transition(item, transition, $event)\\\" ng-show=item.hover><span>{{transition.label}}</span></md-button></md-list-item></md-list></div></md-content></md-content>\");\n$templateCache.put(\"app/task/task.html\",\"<md-content flex layout=column><navbar title=\\\"Task Management Dashboard\\\" sidenav-id=left></navbar><md-content flex layout=row><md-sidenav md-component-id=left md-is-locked-open=\\\"$mdMedia(\\'gt-sm\\')\\\" layout=column><div ng-if=vm.loading flex layout=row layout-align=\\\"center center\\\"><md-progress-circular md-mode=indeterminate></md-progress-circular></div><md-list ng-if=!vm.loading><md-list-item ng-repeat=\\\"task in vm.tasks\\\" ui-sref=\\\"task.show({ taskId: task.id })\\\">{{ task.label }}</md-list-item></md-list></md-sidenav><md-content flex layout=column ui-view><div layout=row layout-padding layout-margin layout-align=\\\"center center\\\"><div class=md-headline>Please select a task from the sidebar.</div></div></md-content></md-content></md-content>\");\n$templateCache.put(\"app/trc-bio/event-editor.html\",\"<div class=form-group><label class=control-label for=event-title>Title</label><input type=text id=event-title name=event-title class=\\\"form-control event-title\\\" ng-model=event.title></div><div class=form-group><label class=control-label for=event-description>Description</label><textarea id=event-description name=event-description class=\\\"form-control event-description\\\" ng-model=event.description></textarea></div><div class=form-group><label class=control-label for=event-location>Location</label><input type=text id=event-location name=event-location class=\\\"form-control event-location\\\" ng-model=event.location></div><div class=form-group><label class=control-label for=event-date>Date</label><input type=text id=event-date name=event-date class=\\\"form-control event-date\\\" ng-model=event.date.description><!-- TODO add datepicker --></div>\");\n$templateCache.put(\"app/trc-bio/name-editor.html\",\"<div class=form-group class=name-role><label class=control-label for=name-role>Role</label><select id=name-role name=name-role class=\\\"form-control name-role\\\" ng-model=name.role><option ng-repeat=\\\"role in nameEditor.roles\\\" value={{role.value}}>{{role.label}}</option></select></div><div class=form-group class=name-structure><label class=control-label>Structured Name</label><input type=text class=name-title placeholder=title ng-model=name.title> <input type=text class=name-given placeholder=given ng-model=name.givenName> <input type=text class=name-middle placeholder=middle ng-model=name.middleName> <input type=text class=name-family placeholder=family ng-model=name.familyName> <input type=text class=name-suffix placeholder=suffix ng-model=name.suffix></div><div class=form-group class=name-label><label for=label>Display Label</label><input type=text placeholder=label ng-model=name.label></div>\");\n$templateCache.put(\"app/trc-bio/person-editor.html\",\"<div class=form-group><label for=person-name>Primary Name</label><trc-name-editor id=person-name ng-model=person.name></trc-name-editor></div><div class=form-group><label for=person-altnames>Alternate Names</label><div ng-repeat=\\\"name in person.altNames\\\"><trc-name-editor id=person-altnames ng-model=name></trc-name-editor><button ng-click=personEditor.removeName($index)>&minus;</button></div><button ng-click=personEditor.addName()>+</button></div><div class=form-group><label for=person-birth>Birth</label><div ng-if=person.birth><trc-event-editor id=person-birth ng-model=person.birth></trc-event-editor><button ng-click=\\\"personEditor.removeEvent(\\'birth\\')\\\">&minus;</button></div><div ng-if=!person.birth><button ng-click=\\\"personEditor.addEvent(\\'birth\\')\\\">+</button></div></div><div class=form-group><label for=person-death>Death</label><div ng-if=person.death><trc-event-editor id=person-death ng-model=person.death></trc-event-editor><button ng-click=\\\"personEditor.removeEvent(\\'death\\')\\\">&minus;</button></div><div ng-if=!person.death><button ng-click=\\\"personEditor.addEvent(\\'death\\')\\\">+</button></div></div><div class=form-group><label class=control-label for=person-summary>Summary</label><textarea id=person-summary name=person-summary class=\\\"form-control person-summary\\\" ng-model=person.summary></textarea></div>\");\n$templateCache.put(\"app/vwise/workspace.html\",\"<div layout=column flex><md-toolbar><div class=md-toolbar-tools><md-button class=\\\"md-accent md-icon-button\\\" ng-click=vm.openMenu() title=\\\"toggle menu\\\" hide-gt-sm><md-icon>menu</md-icon></md-button><img class=logo src=assets/images/sda-logo-light.png><h2><span>Visual Workspace</span></h2></div></md-toolbar><div layout=row flex><md-sidenav md-component-id=left class=md-sidenav-left layout=column md-is-locked-open=vm.sidebarFocused><form layout=row flex=none><md-input-container flex><label for=searchQuery>Search</label><md-icon>search</md-icon><input type=search name=searchQuery id=searchQuery ng-model=vm.searchQuery ng-change=vm.search(vm.searchQuery) required md-sidenav-focus></md-input-container></form><md-content flex><div ng-if=vm.loading layout=row layout-align=center><md-progress-circular md-mode=indeterminate></md-progress-circular></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.peopleResults &amp;&amp; vm.peopleResults.items.length == 0 &amp;&amp; vm.worksResults &amp;&amp; vm.worksResults.items.length == 0\\\" layout=row layout-padding><p>No results for \\\"{{vm.searchQuery}}\\\".</p></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.peopleResults &amp;&amp; vm.peopleResults.items.length > 0\\\"><md-subheader>People</md-subheader><md-list><md-list-item ng-repeat=\\\"item in vm.peopleResults.items\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span>{{item.label}}</span></div></md-list-item></md-list></div><div ng-if=\\\"!vm.loading &amp;&amp; vm.worksResults &amp;&amp; vm.worksResults.items.length > 0\\\"><md-subheader>Works</md-subheader><md-list><md-list-item ng-repeat=\\\"item in vm.worksResults.items\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span>{{item.label}}</span></div></md-list-item></md-list></div></md-content></md-sidenav><vwise-workspace workspace=vm.workspace flex layout=column></vwise-workspace></div></div>\");\n$templateCache.put(\"app/work/copy-edit-dialog.html\",\"<md-dialog flex=50><md-toolbar><div class=md-toolbar-tools><h3>Digital Copy Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><copy-editor ng-model=vm.copy></copy-editor></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/work/edition-edit-dialog.html\",\"<md-dialog flex=80><md-toolbar><div class=md-toolbar-tools><h3>Bibliographic Information Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><div layout=row><md-input-container flex><label>edition name</label><input type=text ng-model=vm.edition.editionName required></md-input-container></div><section class=publication layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Publication Information</h2></div></md-toolbar><publication-info-editor ng-model=vm.edition.publicationInfo flex></publication-info-editor></section><section class=titles layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Titles</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addTitle($event)><md-icon>add</md-icon></md-button></div></md-toolbar><div class=title layout=row ng-repeat=\\\"title in vm.edition.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteTitle(title, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Authors</h2><span flex></span><md-button class=md-icon-button ng-click=\\\"vm.addAuthor(\\'authors\\', $event)\\\"><md-icon>add</md-icon></md-button></div></md-toolbar><div class=author layout=row ng-repeat=\\\"author in vm.edition.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteAuthor(\\'authors\\', author, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/work/edition.html\",\"<nav layout=row layout-padding><ol class=breadcrumbs flex><li><a ui-sref=\\\"editor.work({workId: vm.work.id})\\\">{{vm.workTitle.title}}{{vm.workTitle.title && vm.workTitle.subtitle ? \\': \\' : \\'\\'}}{{vm.workTitle.subtitle}}</a></li><li>{{vm.edition.editionName}}</li></ol></nav><div layout=row layout-padding><div layout=column flex=60><section class=\\\"content citation\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Bibliographic Information</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editBibInfo($event)><md-icon>edit</md-icon></md-button></div><p><span class=authors ng-if=\\\"vm.edition.authors && vm.edition.authors.length > 0\\\"><span class=author ng-repeat=\\\"author in vm.edition.authors\\\"><span ng-if=author.authorId><a ui-sref=\\\"editor.person({id: author.authorId})\\\">{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}</a>. </span><span ng-if=!author.authorId>{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}. </span></span></span><span class=title ng-if=vm.title>{{vm.title.title}}{{vm.title.title && vm.title.subtitle ? \\': \\' : \\'\\'}}{{vm.title.subtitle}}. </span><span class=publication ng-if=vm.edition.publicationInfo><span ng-if=vm.edition.publicationInfo.place><span class=place>{{vm.edition.publicationInfo.place}}</span>: </span><span ng-if=vm.edition.publicationInfo.publisher><span class=publisher>{{vm.edition.publicationInfo.publisher}}</span>, </span><span ng-if=vm.edition.publicationInfo.date><time class=date datetime={{vm.edition.publicationInfo.date.calendar}}>{{vm.edition.publicationInfo.date.description}}</time>.</span></span></p></section><section class=\\\"content summary\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Summary</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editSummary($event)><md-icon>edit</md-icon></md-button></div><p ng-if=vm.edition.summary ng-bind-html=vm.edition.summary></p></section><section class=\\\"content volumes\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Volumes</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addVolume($event)><md-icon>add</md-icon></md-button></div><md-list><md-list-item ng-repeat=\\\"volume in vm.edition.volumes\\\" ui-sref=\\\"editor.volume({workId: vm.work.id, editionId: vm.edition.id, volumeId: volume.id})\\\"><span>Volume {{volume.volumeNumber}}</span><md-button class=\\\"md-secondary md-icon-button md-warn\\\" ng-click=\\\"vm.deleteVolume(volume, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></section></div><div layout=column flex=40><section class=\\\"content references\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Relationships</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addRelationship($event)><md-icon>add</md-icon></md-button></div><div ng-repeat=\\\"type in vm.relationships\\\"><h3 class=content-heading>{{type.label}}</h3><md-list><md-list-item ng-repeat=\\\"relationship in type.relationships\\\" ng-click=vm.openRelationship(relationship)><span ng-repeat=\\\"entity in relationship.entities\\\">{{entity.label}}.</span><md-button class=\\\"md-secondary md-warn md-icon-button\\\" ng-click=\\\"vm.deleteRelationship(relationship, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></div></section><section class=\\\"content copies\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addCopy($event)><md-icon>add</md-icon></md-button></div><md-list><md-list-item ng-repeat=\\\"copy in vm.edition.copies\\\" ng-click=\\\"vm.editCopy(copy, $event)\\\"><span>{{copy.title}}</span><md-button class=\\\"md-secondary md-icon-button\\\" ng-click=vm.copyToWork(copy) aria-label=\\\"copy to parent work\\\"><md-icon>file_upload</md-icon><md-tooltip>Copy to Work</md-tooltip></md-button><md-button class=\\\"md-secondary md-icon-button md-warn\\\" ng-click=\\\"vm.deleteCopy(copy, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></section></div></div>\");\n$templateCache.put(\"app/work/relationship-edit-dialog.html\",\"<md-dialog flex=50><md-toolbar><div class=md-toolbar-tools><h3>Relationship Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form name=relationship ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content layout=column><md-input-container><label>type</label><md-select name=type ng-model=vm.selectedType ng-change=vm.setType(vm.selectedType) required><md-option ng-repeat=\\\"type in vm.types\\\" ng-value=type>{{type.label}}</md-option></md-select><div class=errors ng-messages=relationship.type.$error ng-if=relationship.$dirty><div ng-message=required>Required</div></div></md-input-container><md-autocomplete md-items=\\\"work in vm.getResults(vm.searchText)\\\" md-item-text=work.label md-search-text=vm.searchText md-selected-item-change=vm.selectWork(work) placeholder=\\\"search works\\\" required><md-item-template><span md-highlight=vm.searchText md-highlight-flags=^i>{{work.label}}</span></md-item-template></md-autocomplete><md-input-container ng-if=\\\"vm.targets && vm.targets.length > 1\\\"><label>target</label><md-select name=target ng-model=vm.selectedTarget ng-change=vm.setTarget(vm.selectedTarget) required><md-option ng-repeat=\\\"target in vm.targets\\\" ng-value=target>{{target.label}}</md-option></md-select><div class=errors ng-messages=relationship.target.$error ng-if=relationship.$dirty><div ng-message=required>Required</div></div></md-input-container><div class=summary><h2>Summary</h2><div ckeditor ng-model=vm.relationship.description></div></div></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/work/volume-edit-dialog.html\",\"<md-dialog flex=80><md-toolbar><div class=md-toolbar-tools><h3>Bibliographic Information Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><div layout=row><md-input-container flex><label>volume number</label><input type=text ng-model=vm.volume.volumeNumber required></md-input-container></div><section class=publication layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Publication Information</h2></div></md-toolbar><publication-info-editor ng-model=vm.volume.publicationInfo></publication-info-editor></section><section class=titles layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Titles</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addTitle($event)><md-icon>add</md-icon></md-button></div></md-toolbar><div class=title layout=row ng-repeat=\\\"title in vm.volume.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteTitle(title, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Authors</h2><span flex></span><md-button class=md-icon-button ng-click=\\\"vm.addAuthor(\\'authors\\', $event)\\\"><md-icon>add</md-icon></md-button></div></md-toolbar><div class=author layout=row ng-repeat=\\\"author in vm.volume.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteAuthor(\\'authors\\', author, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/work/volume.html\",\"<nav layout=row layout-padding><ol class=breadcrumbs flex><li><a ui-sref=\\\"editor.work({workId: vm.work.id})\\\">{{vm.workTitle.title}}{{vm.workTitle.title && vm.workTitle.subtitle ? \\': \\' : \\'\\'}}{{vm.workTitle.subtitle}}</a></li><li><a ui-sref=\\\"editor.edition({workId: vm.work.id, editionId: vm.edition.id})\\\">{{vm.edition.editionName}}</a></li><li>Volume {{vm.volume.volumeNumber}}</li></ol></nav><div layout=row layout-padding><div layout=column flex=60><section class=\\\"content citation\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Bibliographic Information</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editBibInfo($event)><md-icon>edit</md-icon></md-button></div><p><span class=authors ng-if=\\\"vm.volume.authors && vm.volume.authors.length > 0\\\"><span class=author ng-repeat=\\\"author in vm.volume.authors\\\"><span ng-if=author.authorId><a ui-sref=\\\"editor.person({id: author.authorId})\\\">{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}</a>. </span><span ng-if=!author.authorId>{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}. </span></span></span><span class=title ng-if=vm.title>{{vm.title.title}}{{vm.title.title && vm.title.subtitle ? \\': \\' : \\'\\'}}{{vm.title.subtitle}}. </span><span class=publication ng-if=vm.volume.publicationInfo><span ng-if=vm.volume.publicationInfo.place><span class=place>{{vm.volume.publicationInfo.place}}</span>: </span><span ng-if=vm.volume.publicationInfo.publisher><span class=publisher>{{vm.volume.publicationInfo.publisher}}</span>, </span><span ng-if=vm.volume.publicationInfo.date><time class=date datetime={{vm.volume.publicationInfo.date.calendar}}>{{vm.volume.publicationInfo.date.description}}</time>.</span></span></p></section><section class=\\\"content summary\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Summary</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editSummary($event)><md-icon>edit</md-icon></md-button></div><p ng-if=vm.volume.summary ng-bind-html=vm.volume.summary></p></section></div><div layout=column flex=40><section class=\\\"content references\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Relationships</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addRelationship($event)><md-icon>add</md-icon></md-button></div><div ng-repeat=\\\"type in vm.relationships\\\"><h3 class=content-heading>{{type.label}}</h3><md-list><md-list-item ng-repeat=\\\"relationship in type.relationships\\\" ng-click=vm.openRelationship(relationship)><span ng-repeat=\\\"entity in relationship.entities\\\">{{entity.label}}.</span><md-button class=\\\"md-secondary md-warn md-icon-button\\\" ng-click=\\\"vm.deleteRelationship(relationship, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></div></section><section class=\\\"content copies\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addCopy($event)><md-icon>add</md-icon></md-button></div><md-list><md-list-item ng-repeat=\\\"copy in vm.volume.copies\\\" ng-click=\\\"vm.editCopy(copy, $event)\\\"><span>{{copy.title}}</span><md-button class=\\\"md-secondary md-icon-button\\\" ng-click=vm.copyToEdition(copy) aria-label=\\\"copy to parent edition\\\"><md-icon>file_upload</md-icon><md-tooltip>Copy to Edition</md-tooltip></md-button><md-button class=\\\"md-secondary md-icon-button md-warn\\\" ng-click=\\\"vm.deleteCopy(copy, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></section></div></div>\");\n$templateCache.put(\"app/work/work-edit-dialog.html\",\"<md-dialog flex=80><md-toolbar><div class=md-toolbar-tools><h3>Bibliographic Information Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><div class=md-dialog-content><section class=titles layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Titles</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addTitle($event)><md-icon>add</md-icon></md-button></div></md-toolbar><div class=title layout=row ng-repeat=\\\"title in vm.work.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteTitle(title, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Authors</h2><span flex></span><md-button class=md-icon-button ng-click=\\\"vm.addAuthor(\\'authors\\', $event)\\\"><md-icon>add</md-icon></md-button></div></md-toolbar><div class=author layout=row ng-repeat=\\\"author in vm.work.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"vm.deleteAuthor(\\'authors\\', author, $event)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section></div></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/work/work.html\",\"<nav layout=row layout-padding><ol class=breadcrumbs flex><li>{{vm.bcTitle.title}}{{vm.bcTitle && vm.bcTitle.subtitle ? \\': \\' : \\'\\'}}{{vm.bcTitle.subtitle}}</li></ol></nav><div layout=row layout-padding flex=noshrink><div layout=column flex=60><section class=\\\"content citation\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Bibliographic Information</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editBibInfo($event)><md-icon>edit</md-icon></md-button></div><p><span class=authors ng-if=\\\"vm.work.authors && vm.work.authors.length > 0\\\"><span class=author ng-repeat=\\\"author in vm.work.authors\\\"><span ng-if=author.authorId><a ui-sref=\\\"editor.person({id: author.authorId})\\\">{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}</a>. </span><span ng-if=!author.authorId>{{author.lastName}}{{author.lastName && author.firstName ? \\', \\' : \\'\\'}}{{author.firstName}}. </span></span></span><span class=title ng-if=vm.title>{{vm.title.title}}{{vm.title.title && vm.title.subtitle ? \\': \\' : \\'\\'}}{{vm.title.subtitle}}.</span></p></section><section class=\\\"content summary\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Summary</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editSummary($event)><md-icon>edit</md-icon></md-button></div><p ng-if=vm.work.summary ng-bind-html=vm.work.summary></p></section><section class=\\\"content editions\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Editions</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addEdition($event)><md-icon>add</md-icon></md-button></div><md-list><md-list-item ng-repeat=\\\"edition in vm.work.editions\\\" ui-sref=\\\"editor.edition({workId: vm.work.id, editionId: edition.id})\\\"><span>{{edition.editionName}}</span><md-button class=\\\"md-secondary md-icon-button md-warn\\\" ng-click=\\\"vm.deleteEdition(edition, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></section><section class=\\\"content bibliography\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Bibliography</h2><span flex></span><md-button class=md-icon-button ng-click=vm.editBibliography($event)><md-icon>edit</md-icon></md-button></div><bibliography collection=vm.references></bibliography></section></div><div layout=column flex=40><section class=\\\"content references\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Relationships</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addRelationship($event)><md-icon>add</md-icon></md-button></div><div ng-repeat=\\\"type in vm.relationships\\\"><h3 class=content-heading>{{type.label}}</h3><md-list><md-list-item ng-repeat=\\\"relationship in type.relationships\\\" ng-click=vm.openRelationship(relationship)><span ng-repeat=\\\"entity in relationship.entities\\\">{{entity.label}}.</span><md-button class=\\\"md-secondary md-warn md-icon-button\\\" ng-click=\\\"vm.deleteRelationship(relationship, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></div></section><section class=\\\"content copies\\\"><div class=toolbar layout=row layout-align=\\\"start center\\\"><h2 class=content-heading>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=vm.addCopy($event)><md-icon>add</md-icon></md-button></div><md-list><md-list-item ng-repeat=\\\"copy in vm.work.copies\\\" ng-click=\\\"vm.editCopy(copy, $event)\\\"><span>{{copy.title}}</span><md-button class=\\\"md-secondary md-icon-button md-warn\\\" ng-click=\\\"vm.deleteCopy(copy, $event)\\\"><md-icon>delete</md-icon></md-button></md-list-item></md-list></section></div></div><div layout=row layout-align=end layout-margin><div><md-button aria-label=\\\"Delete this work\\\" class=\\\"md-warn md-icon-button\\\" ng-click=\\\"vm.deleteWork($event, vm.work)\\\"><md-icon>delete</md-icon><md-tooltip md-direction=left>Delete</md-tooltip></md-button></div></div>\");\n$templateCache.put(\"app/zotero/creator-field.html\",\"<div layout=row layout-margin><md-input-container><label>Role</label><md-select ng-model=$ctrl.creator.creatorType ng-disabled=\\\"!$ctrl.roles || $ctrl.roles.length == 0\\\"><md-option ng-value=role.role ng-repeat=\\\"role in $ctrl.roles\\\">{{role.label}}</md-option></md-select></md-input-container><md-input-container ng-if=verbatim flex><label>Name</label><input type=text ng-model=$ctrl.creator.name></md-input-container><md-input-container ng-if=!verbatim flex><label>First Name</label><input type=text ng-model=$ctrl.creator.firstName></md-input-container><md-input-container ng-if=!verbatim flex><label>Last Name</label><input type=text ng-model=$ctrl.creator.lastName></md-input-container><div layout=column layout-align=\\\"center center\\\"><md-button ng-show=verbatim ng-click=\\\"verbatim = false\\\" class=md-icon-button aria-label=\\\"First/Last Names\\\"><md-icon>people</md-icon><md-tooltip>First/Last Names</md-tooltip></md-button><md-button ng-hide=verbatim ng-click=\\\"verbatim = true\\\" class=md-icon-button aria-label=\\\"Single Name\\\"><md-icon>domain</md-icon><md-tooltip>Single Name</md-tooltip></md-button></div></div>\");\n$templateCache.put(\"app/zotero/editor.html\",\"<div layout=column flex><div layout=row layout-margin><md-autocomplete md-search-text=$ctrl.itemTypeSearchText md-items=\\\"type in $ctrl.types | filter: {label: $ctrl.itemTypeSearchText}\\\" md-item-text=type.label md-selected-item=$ctrl.itemType md-selected-item-change=$ctrl.selectType($ctrl.itemType) md-min-length=0 md-floating-label=\\\"Item Type\\\" required><md-item-template><span md-highlight-text=$ctrl.itemTypeSearchText md-highlight-flags=^i>{{type.label}}</span></md-item-template></md-autocomplete></div><div layout=row ng-repeat=\\\"creator in $ctrl.item.creators\\\" layout-align=\\\"start center\\\"><zotero-creator-field creator=creator roles=$ctrl.roles flex></zotero-creator-field><md-button ng-click=\\\"$ctrl.item.creators.splice($index+1, 0, {})\\\" class=md-icon-button aria-label=\\\"New Creator\\\"><md-icon>add</md-icon><md-tooltip>New</md-tooltip></md-button><md-button ng-disabled=\\\"$ctrl.item.creators.length <= 1\\\" ng-click=\\\"$ctrl.item.creators.splice($index, 1)\\\" class=\\\"md-icon-button md-warn\\\" aria-label=\\\"Delete Creator\\\"><md-icon>remove</md-icon><md-tooltip>Delete</md-tooltip></md-button></div><div layout=row layout-margin ng-repeat=\\\"field in $ctrl.fields\\\"><md-input-container flex><label>{{field.label}}</label><input type=text ng-model=$ctrl.item[field.id]></md-input-container></div><div ng-if=!$ctrl.itemType layout-margin><p>Please select an item type first.</p></div></div>\");\n$templateCache.put(\"app/components/citation-edit-dialog/citation-edit-dialog.html\",\"<md-dialog aria-label=\\\"Edit Citation\\\" flex=50 layout=column><form ng-cloak><md-toolbar><div class=md-toolbar-tools><h2>Edit Citation</h2><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon aria-label=Cancel>close</md-icon></md-button></div></md-toolbar><md-dialog-content><div class=md-dialog-content><citation-editor references=vm.references citation=vm.citation></citation-editor></div></md-dialog-content><md-dialog-actions layout=row><md-button ng-click=vm.cancel()>Cancel</md-button><md-button ng-click=vm.done()>Save</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/components/citation-edit-dialog/citation-editor.html\",\"<div class=citation-editor-layout layout=column flex><div class=citation-editor-container ng-hide=$ctrl.zoteroItem layout=column flex><div layout=row layout-wrap><div layout=row layout-align=\\\"start center\\\" layout-margin class=md-whiteframe-2dp ng-repeat=\\\"item in $ctrl.citation.items\\\"><span ng-bind-html=item.label></span><md-button class=md-icon-button aria-label=Edit ng-click=$ctrl.edit(item)><md-icon>edit</md-icon><md-tooltip>Edit Item</md-tooltip></md-button><md-button class=\\\"md-icon-button md-warn\\\" aria-label=Remove ng-click=\\\"$ctrl.citation.items.splice($index, 1)\\\"><md-icon>remove</md-icon><md-tooltip>Remove Item</md-tooltip></md-button></div></div><div layout=column><md-autocomplete md-autoselect md-floating-label=\\\"Referenced Item\\\" md-selected-item=$ctrl.selectedBiblioItem md-selected-item-change=$ctrl.selectBiblioItem($ctrl.selectedBiblioItem) md-search-text=$ctrl.searchText md-items=\\\"item in $ctrl.search($ctrl.searchText)\\\" md-item-text=\\\"item.label | stripTags\\\" md-delay=200 md-require-match required><md-item-template><span ng-bind-html=item.label></span></md-item-template><md-not-found>No matches found.<md-button ng-click=$ctrl.createZoteroItem($event)>Create</md-button></md-not-found></md-autocomplete><div layout=row><md-input-container><label>Locator Type</label><md-select ng-model=$ctrl.activeCitationItem.locatorType><md-option></md-option><md-option ng-repeat=\\\"type in $ctrl.locatorTypes\\\" ng-value=type>{{type}}</md-option></md-select></md-input-container><md-input-container flex><label>Locator</label><input type=text ng-model=$ctrl.activeCitationItem.locator></md-input-container></div><md-checkbox ng-model=$ctrl.activeCitationItem.suppressAuthor>Suppress Author Name in In-Text Citation</md-checkbox></div><div layout=row layout-align=end><md-button class=md-raised ng-click=$ctrl.addCitationItem($ctrl.activeCitationItem)>Save Item</md-button></div></div><div class=zotero-item-editor-container ng-if=$ctrl.zoteroItem layout=row flex><div layout=column><md-button class=md-icon-button ng-click=$ctrl.cancelZoteroItem($event)><md-icon>cancel</md-icon><md-tooltip md-direction=right>Cancel New Item</md-tooltip></md-button><md-button class=md-icon-button ng-click=\\\"$ctrl.saveZoteroItem($event, $ctrl.zoteroItem)\\\"><md-icon>check_circle</md-icon><md-tooltip md-direction=right>Save and Cite Item</md-tooltip></md-button></div><zotero-editor item=$ctrl.zoteroItem flex></zotero-editor></div></div>\");\n$templateCache.put(\"app/components/ckeditor-footnotes/footnote-edit-dialog.html\",\"<md-bottom-sheet aria-label=\\\"Insert Footnote\\\" layout=column><md-toolbar><div class=md-toolbar-tools><h2>Insert Footnote</h2><span flex></span><md-button ng-click=vm.cancel()>Cancel</md-button><md-button ng-click=vm.done()>Save</md-button></div></md-toolbar><div ng-if=vm.references ng-model=vm.footnote.content ckeditor ckeditor-bibliography=vm.references></div><div ng-if=!vm.references ng-model=vm.footnote.content ckeditor></div></md-bottom-sheet>\");\n$templateCache.put(\"app/components/date-editor/date-editor.html\",\"<div layout=row><md-input-container flex><label>date</label><input type=text ng-model=date.description></md-input-container><md-input-container flex><label>ISO-8601 date</label><input type=datetime ng-model=date.calendar ng-change=\\\"calendarAutoSet = false\\\"></md-input-container></div>\");\n$templateCache.put(\"app/components/navbar/navbar.html\",\"<md-toolbar><div class=md-toolbar-tools><md-button ng-if=$ctrl.sidenavId class=\\\"md-accent md-icon-button\\\" ng-click=$ctrl.toggleSidenav($ctrl.sidenavId) title=\\\"toggle menu\\\" hide-gt-sm><md-icon>menu</md-icon></md-button><img class=logo src=assets/images/sda-logo-light.png><h2><span>{{$ctrl.title}}</span><!-- make this change based on page --></h2><span flex></span><md-button ui-sref=editor>People and Works</md-button><md-button ui-sref=article>Article</md-button><md-button ui-sref=task>Tasks</md-button></div></md-toolbar>\");\n$templateCache.put(\"app/components/summary-edit-dialog/summary-edit-dialog.html\",\"<md-dialog flex=50><md-toolbar><div class=md-toolbar-tools><h3>Summary Editor</h3><span flex></span><md-button class=md-icon-button ng-click=vm.cancel()><md-icon>close</md-icon></md-button></div></md-toolbar><form ng-submit=vm.close()><md-dialog-content><!-- material-compliant padding not used since WYSIWYG text editor *is* the UI --><summary-editor ng-model=vm.summary></summary-editor></md-dialog-content><md-dialog-actions><md-button ng-click=vm.cancel()>Cancel</md-button><md-button class=md-primary type=submit>Done</md-button></md-dialog-actions></form></md-dialog>\");\n$templateCache.put(\"app/components/summary-editor/summary-editor.html\",\"<div ckeditor ng-model=summary></div>\");\n$templateCache.put(\"app/zotero/test/test.html\",\"<div layout=column flex><md-content><zotero-editor item=vm.item types=vm.types></zotero-editor></md-content></div>\");\n$templateCache.put(\"app/admin/editors/articles/article-editor.html\",\"<form flex layout=column layout-padding><!-- title editor bar --><md-content layout=row><md-input-container flex=60 layout-sm=column layout-align=\\\"begin end\\\"><label>Title</label><input type=text ng-model=vm.article.title></md-input-container><section flex=40 layout=row layout-sm=column layout-align=\\\"end center\\\" layout-wrap><md-button class=md-raised ng-click=vm.cancel()>Cancel</md-button><md-button class=\\\"md-raised md-primary\\\" ng-click=vm.save()>Save</md-button></section></md-content><!-- TODO add space for authors --><!-- TODO add save button and auto-save --><!-- TODO add sidebar for notes, biblio, links, etc --><div id=article_editor flex layout=column><div ng-model=vm.article.body ckeditor=vm.editor.config ckeditor-bibliography=vm.references ckeditor-footnotes=vm.article.footnotes></div><md-tabs flex><md-tab label=Abstract><div ckeditor=vm.abstractEditor.config ng-model=vm.article.abstract></div></md-tab><md-tab label=Bibliography><bibliography collection=vm.references></bibliography></md-tab><md-tab label=Footnotes><div class=footnotes ng-repeat=\\\"footnote in vm.article.footnotes\\\" layout=row><div class=footnote ng-bind-html=footnote.content flex></div><md-button class=md-icon-button aria-label=\\\"edit footnote\\\" ng-click=\\\"vm.editFootnote($event, footnote)\\\"><md-icon>edit</md-icon><md-tooltip>Edit Footnote</md-tooltip></md-button></div></md-tab></md-tabs></div><!-- TODO how to make this fill all available space --></form>\");\n$templateCache.put(\"app/admin/editors/articles/article.html\",\"<md-content flex layout=column><navbar title=Articles sidenav-id=left></navbar><md-content flex layout=row><md-sidenav md-component-id=left md-is-locked-open=\\\"$mdMedia(\\'gt-sm\\')\\\" layout=column><md-tabs flex><md-tab><md-tab-label><md-icon>format_list_bulleted</md-icon><md-tooltip md-direction=bottom>Thematic Overviews</md-tooltip></md-tab-label><md-tab-body><tree-categorization-editor scope-id=sda scheme=overviews></tree-categorization-editor></md-tab-body></md-tab><md-tab><md-tab-label><md-icon>book</md-icon><md-tooltip md-direction=bottom>Book Reviews</md-tooltip></md-tab-label><md-tab-body></md-tab-body></md-tab><md-tab><md-tab-label><md-icon>person</md-icon><md-tooltip md-direction=bottom>Biographies</md-tooltip></md-tab-label><md-tab-body></md-tab-body></md-tab><md-tab><md-tab-label><md-icon>school</md-icon><md-tooltip md-direction=bottom>Scholarly Articles</md-tooltip></md-tab-label><md-tab-body></md-tab-body></md-tab></md-tabs></md-sidenav><md-content flex layout=column ui-view></md-content><md-fab-speed-dial md-direction=up class=\\\"md-scale md-fab-bottom-right\\\"><md-fab-trigger><md-button aria-label=New... class=md-fab><md-icon>add</md-icon></md-button></md-fab-trigger><md-fab-actions><md-button aria-label=\\\"New Article\\\" class=\\\"md-fab md-mini\\\" ng-click=vm.createArticle($event)><md-tooltip md-direction=left>New Article</md-tooltip><md-icon>description</md-icon></md-button></md-fab-actions></md-fab-speed-dial></md-content></md-content>\");\n$templateCache.put(\"app/admin/editors/articles/thematic-overview.html\",\"<div id=thematic_overviews><script type=text/ng-template id=treeCategoryEntry.html><div class=\\\"category-node\\\" layout=\\\"row\\\" layout-align=\\\"start center\\\">\\n     <!--  Display label for the category node-->\\n     <span ng-if=\\\"node.entryRef == null\\\" class=\\\"node-label\\\">{{ node.label }}</span>\\n     <a ui-sref=\\\"article.edit({id:node.entryRef.id})\\\" ng-if=\\\"node.entryRef != null\\\" class=\\\"node-label\\\">{{ node.label }}</a>\\n\\n     <!-- push buttons to edge -->\\n     <span flex></span>\\n\\n     <!-- node action menu -->\\n     <md-menu class=\\\"action\\\">\\n       <!-- activate handle -->\\n       <md-button ng-click=\\\"$mdOpenMenu($event)\\\" class=\\\"md-icon-button\\\">\\n         <md-icon>arrow_drop_down</md-icon>\\n       </md-button>\\n\\n       <md-menu-content>\\n         <!-- Associate/Remove  -->\\n         <md-menu-item>\\n           <md-button ng-if=\\\"node.entryRef.id == null\\\"\\n                      ng-click=\\\"vm.handleAssociateEntry($event, node)\\\">\\n             <md-icon>add_circle_outline</md-icon>\\n             Create Article\\n           </md-button>\\n           <md-button ng-if=\\\"node.entryRef.id != null\\\"\\n                      ng-click=\\\"vm.handleRemoveEntry($event, node)\\\">\\n             <md-icon>remove_circle_outline</md-icon>\\n             Remove Article\\n           </md-button>\\n         </md-menu-item>\\n\\n         <md-menu-item>\\n           <md-button ng-click=\\\"vm.handleCreateChild($event, node)\\\">\\n             <!-- Will create a child node at the end of this list. User can drag to re-arrange -->\\n             <md-icon>create_new_folder</md-icon>\\n             Create Sub-Category\\n           </md-button>\\n         </md-menu-item>\\n\\n         <md-menu-item>\\n           <md-button ng-click=\\\"vm.handleDeleteNode($event, node, parent)\\\">\\n             <!-- Will delete this node, all children and associated articles. If leaf node,\\n             displays delete instead of delete sweep. Prompts user to confirm. -->\\n             <md-icon>delete{{ node.children.length == 0 ? \\'\\' : \\'_sweep\\' }}</md-icon>\\n             Remove Category\\n           </md-button>\\n         </md-menu-item>\\n       </md-menu-content>\\n     </md-menu>\\n   </div>\\n\\n   <ol ng-if=\\\"node.children.length > 0\\\">\\n     <li ng-repeat=\\\"node in node.children\\\" ng-include=\\\"\\'treeCategoryEntry.html\\'\\\" ng-init=\\\"parent = $parent.$parent.node\\\"></li>\\n   </ol></script><ol><li ng-repeat=\\\"node in vm.overviews.root.children\\\" ng-include=\\\"\\'treeCategoryEntry.html\\'\\\" ng-init=\\\"parent = vm.overviews.root\\\"></li></ol><div layout=row layout-align=\\\"center center\\\"><!-- TODO need additional styling --><md-button ng-click=\\\"vm.handleCreateChild($event, vm.overviews.root)\\\" class=md-raised aria-label=\\\"create category\\\">Create Category</md-button></div></div>\");\n$templateCache.put(\"app/person/components/event-editor/event-editor.html\",\"<div layout=column><div layout=row><md-input-container flex><label>location</label><input type=text ng-model=event.location></md-input-container><date-editor ng-model=event.date flex></date-editor></div><div layout=row layout-padding><div flex><h2>Description</h2><div flex ckeditor ng-model=event.description></div></div></div></div>\");\n$templateCache.put(\"app/person/components/name-editor/name-editor.html\",\"<div layout=column><div layout=row><md-input-container flex=10><label>title</label><input type=text ng-model=name.title></md-input-container><md-input-container flex=30><label>given</label><input type=text ng-model=name.givenName></md-input-container><md-input-container flex=20><label>middle</label><input type=text ng-model=name.middleName></md-input-container><md-input-container flex=30><label>family</label><input type=text ng-model=name.familyName></md-input-container><md-input-container flex=10><label>suffix</label><input type=text ng-model=name.suffix></md-input-container></div><md-input-container><label>display label</label><input type=text ng-model=name.label required></md-input-container></div>\");\n$templateCache.put(\"app/task/components/edition-editor/edition-editor.html\",\"<div layout=row><md-input-container flex><label>edition name</label><input type=text ng-model=edition.editionName required></md-input-container></div><section class=publication layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Publication Information</h2></div></md-toolbar><publication-info-editor ng-model=edition.publicationInfo flex></publication-info-editor></section><section class=titles layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Titles</h2><span flex></span><md-button class=md-icon-button ng-click=edition.titles.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=title layout=row ng-repeat=\\\"title in edition.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"edition.titles.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Authors</h2><span flex></span><md-button class=md-icon-button ng-click=edition.authors.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=author layout=row ng-repeat=\\\"author in edition.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"edition.authors.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=summary><h2>Summary</h2><summary-editor ng-model=edition.summary flex></summary-editor></section><section class=volumes><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Volumes</h2><span flex></span><md-button class=md-icon-button ng-click=vm.createVolume()><md-icon>add</md-icon></md-button></div></md-toolbar><md-whiteframe class=volume layout=column layout-margin ng-repeat=\\\"volume in vm.volumes\\\" ng-class=\\\"{\\'md-whiteframe-2dp\\': !volume.focused, \\'md-whiteframe-8dp\\': volume.focused}\\\"><h3 layout=row><div flex layout=row layout-align=\\\"start center\\\" ng-click=\\\"volume.focused = !volume.focused\\\"><md-icon>{{ edition.focused ? \\'expand_less\\' : \\'expand_more\\'}}</md-icon><span>Volume {{volume.model.volumeNumber}}</span> <span flex></span></div><md-button class=\\\"md-icon-button md-warn\\\" ng-click=vm.deleteVolume($index)><md-icon>delete</md-icon></md-button></h3><div slide-toggle=volume.focused><volume-editor ng-model=volume.model flex></volume-editor></div></md-whiteframe></section><section class=copies><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=edition.copies.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=copy layout=column ng-repeat=\\\"copy in edition.copies\\\"><div layout=row><copy-editor ng-model=copy flex></copy-editor><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"edition.copies.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></div></div></section>\");\n$templateCache.put(\"app/task/components/volume-editor/volume-editor.html\",\"<div layout=row><md-input-container flex><label>volume number</label><input type=text ng-model=volume.volumeNumber required></md-input-container></div><section class=publication layout=column><h2>Publication Information</h2><publication-info-editor ng-model=volume.publicationInfo></publication-info-editor></section><section class=titles layout=column><h2 layout=row><span flex>Titles</span><md-button class=md-icon-button ng-click=volume.titles.push({})><md-icon>add</md-icon></md-button></h2><div class=title layout=row ng-repeat=\\\"title in volume.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"volume.titles.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><h2 layout=row><span flex>Authors</span><md-button class=md-icon-button ng-click=volume.authors.push({})><md-icon>add</md-icon></md-button></h2><div class=author layout=row ng-repeat=\\\"author in volume.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"volume.authors.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=summary><h2>Summary</h2><summary-editor ng-model=volume.summary flex></summary-editor></section><section class=copies><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=volume.copies.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=copy layout=column ng-repeat=\\\"copy in volume.copies\\\"><div layout=row><copy-editor ng-model=copy flex></copy-editor><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"volume.copies.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></div></div></section>\");\n$templateCache.put(\"app/task/components/work-editor/work-editor.html\",\"<section class=titles layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Titles</h2><span flex></span><md-button class=md-icon-button ng-click=work.titles.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=title layout=row ng-repeat=\\\"title in work.titles\\\"><title-editor ng-model=title flex></title-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"work.titles.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=authors layout=column><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Authors</h2><span flex></span><md-button class=md-icon-button ng-click=work.authors.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=author layout=row ng-repeat=\\\"author in work.authors\\\"><author-ref-editor ng-model=author flex></author-ref-editor><md-input-container><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"work.authors.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></md-input-container></div></section><section class=summary><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Summary</h2></div></md-toolbar><summary-editor ng-model=work.summary flex></summary-editor></section><section class=editions><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Editions</h2><span flex></span><md-button class=md-icon-button ng-click=vm.createEdition()><md-icon>add</md-icon></md-button></div></md-toolbar><md-whiteframe class=edition layout=column layout-margin ng-repeat=\\\"edition in vm.editions\\\" ng-class=\\\"{ \\'md-whiteframe-2dp\\': !edition.focused, \\'md-whiteframe-8dp\\': edition.focused }\\\"><h3 layout=row><div flex layout=row layout-align=\\\"start center\\\" ng-click=\\\"edition.focused = !edition.focused\\\"><md-icon>{{ edition.focused ? \\'expand_less\\' : \\'expand_more\\'}}</md-icon><span>{{edition.model.editionName}}</span> <span flex></span></div><md-button class=\\\"md-icon-button md-warn\\\" ng-click=vm.deleteEdition($index)><md-icon>delete</md-icon></md-button></h3><div slide-toggle=edition.focused><edition-editor ng-model=edition.model flex></edition-editor></div></md-whiteframe></section><section class=copies><md-toolbar class=md-hue-3><div class=md-toolbar-tools><h2>Digital Copies</h2><span flex></span><md-button class=md-icon-button ng-click=work.copies.push({})><md-icon>add</md-icon></md-button></div></md-toolbar><div class=copy layout=column ng-repeat=\\\"copy in work.copies\\\"><div layout=row><copy-editor ng-model=copy flex></copy-editor><md-button class=\\\"md-icon-button md-warn\\\" ng-click=\\\"work.copies.splice($index, 1)\\\"><md-icon>delete</md-icon></md-button></div></div></section>\");\n$templateCache.put(\"app/task/components/work-editor-item/work-editor-item.html\",\"<div layout=row layout-align=\\\"center center\\\" ng-if=!vm.loaded><md-progress-circular md-mode=indeterminate></md-progress-circular></div><div ng-if=vm.loaded><work-editor ng-model=vm.work></work-editor></div>\");\n$templateCache.put(\"app/vwise/components/panel/panel.html\",\"<div class=panel ng-class=\\\"{ resizing: vm.resizing }\\\" ng-style=\\\"{ left: vp.xPosition, top: vp.yPosition, zIndex: vp.zPosition, width: vp.width, height: vp.height }\\\" jqyoui-draggable=\\\"{ onDrag: \\'vm.movePanel()\\', onStop: \\'vm.stopMove()\\' }\\\" ng-click=vm.activatePanel($event) data-jqyoui-options=\\\"{ handle: \\'.drag-handle\\' }\\\" data-drag=true layout=column><div class=\\\"panel-control drag-handle\\\" layout=column layout-align=\\\"center center\\\"><md-icon>open_with</md-icon></div><button class=\\\"panel-control close\\\" ng-click=vm.closePanel($event) layout=column layout-align=\\\"center center\\\"><md-icon>close</md-icon></button><div class=\\\"panel-control resize-handle\\\" ng-style=\\\"{ left: vp.width, top: vp.height }\\\" jqyoui-draggable=\\\"{ onStart: \\'vm.startResize()\\', onDrag: \\'vm.resizePanel()\\', onStop:\\'vm.stopResize()\\'}\\\" data-drag=true layout=column layout-align=\\\"center center\\\"><md-icon>crop</md-icon></div><div class=\\\"panel-control panel-area panel-area-top\\\" layout=row layout-align=\\\"end center\\\"><button ng-repeat=\\\"button in vm.actionButtons\\\" ng-click=button.handler($event) title={{button.label}} layout=column layout-align=\\\"center center\\\"><md-icon ng-if=button.icon>{{button.icon}}</md-icon><span ng-if=!button.icon>{{button.label}}</span></button></div><div class=\\\"panel-control panel-area panel-area-right\\\" layout=column layout-align=\\\"start center\\\"><button ng-repeat=\\\"button in vm.propertyButtons\\\" ng-click=button.handler($event) title={{button.label}} layout=column layout-align=\\\"center center\\\"><md-icon ng-if=button.icon>{{button.icon}}</md-icon><span ng-if=!button.icon>{{button.label}}</span></button></div><div class=\\\"panel-control panel-area panel-area-bottom\\\"></div><div class=\\\"panel-control panel-area panel-area-left\\\"></div><div class=content flex layout=column></div></div>\");\n$templateCache.put(\"app/vwise/components/person-panel/person-panel.html\",\"<div class=panel-person flex layout=column><h1><span class=\\\"panel-label name\\\">{{name}}</span></h1><md-tabs flex><md-tab ng-if=person.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=person.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"panel.works &amp;&amp; panel.works.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in panel.works\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.label}}</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"panel.relatedPeople &amp;&amp; panel.relatedPeople.length > 0\\\"><md-tab-label><md-icon>link</md-icon></md-tab-label><md-tab-body><div ng-repeat=\\\"group in panel.relatedPeople\\\"><h3>{{group.label}}</h3><md-list><md-list-item ng-repeat=\\\"item in group.relationships\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.name.label}}</div></md-list-item></md-list></div></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/edition-panel.html\",\"<div class=panel-edition flex layout=column><h1><span class=authors><span class=author ng-repeat=\\\"author in edition.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span> <span class=edition-name>{{edition.editionName}}.</span></h1><md-tabs flex><md-tab ng-if=edition.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=edition.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"edition.volumes.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in edition.volumes\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>Volume {{item.volumeNumber}} ({{item.publicationInfo.date.description}})</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"edition.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in edition.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/volume-panel.html\",\"<div class=panel-volume flex layout=column><h1><span class=authors><span class=author ng-repeat=\\\"author in volume.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span> <span class=edition-name>{{edition.editionName}}.</span> <span class=volume-name>Volume {{volume.volumeNumber}}.</span></h1><md-tabs flex><md-tab ng-if=volume.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=volume.summary></div></md-tab-body></md-tab><md-tab ng-if=\\\"volume.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in volume.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/work-panel/work-panel.html\",\"<div class=panel-work flex layout=column><h1><span class=panel-label><span class=authors><span class=author ng-repeat=\\\"author in work.authors\\\">{{author.lastName}}. </span></span><span class=title>{{title.title}}<span ng-if=title.subtitle>: {{title.subtitle}}</span>.</span></span></h1><md-tabs flex><md-tab ng-if=work.summary><md-tab-label><md-icon>subject</md-icon></md-tab-label><md-tab-body><div class=summary ng-bind-html=work.summary></div></md-tab-body></md-tab><md-tab><md-tab-label><md-icon>link</md-icon></md-tab-label><md-tab-body><div ng-repeat=\\\"group in relationships\\\"><h3>{{group.label}}</h3><md-list><div ng-repeat=\\\"relationship in group.relationships\\\"><md-list-item ng-repeat=\\\"item in relationship.entities\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text><span class=authors><span class=author ng-repeat=\\\"author in item.entity.authors\\\">{{author.lastName}}.</span></span> <span class=title>{{item.title.title}}{{item.title.subtitle ? \\': \\' : \\'\\'}}<span ng-if=item.title.subtitle class=subtitle>{{item.title.subtitle}}</span></span></div></md-list-item></div></md-list></div></md-tab-body></md-tab><md-tab ng-if=\\\"work.editions.length > 0\\\"><md-tab-label><md-icon>content_copy</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in work.editions\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.editionName}} ({{item.publicationInfo.date.description}})</div></md-list-item></md-list></md-tab-body></md-tab><md-tab ng-if=\\\"work.copies.length > 0\\\"><md-tab-label><md-icon>book</md-icon></md-tab-label><md-tab-body><md-list><md-list-item ng-repeat=\\\"item in work.copies\\\" jqyoui-draggable={animate:false} data-jqyoui-options=\\\"{revert:\\'invalid\\',helper:\\'clone\\',appendTo:\\'body\\'}\\\" data-drag=true><div class=md-list-item-text>{{item.title}}</div></md-list-item></md-list></md-tab-body></md-tab></md-tabs></div>\");\n$templateCache.put(\"app/vwise/components/workspace/workspace.html\",\"<div flex jqyoui-droppable=\\\"{stack: true, onDrop:\\'vm.thingDropped()\\'}\\\" data-drop=true class=workspace ng-click=vm.workspaceClicked($event)><vwise-panel ng-repeat=\\\"panel in workspace.panels track by panel.id\\\" panel=panel></vwise-panel></div>\");\n$templateCache.put(\"app/work/components/author-ref-editor/author-ref-editor.html\",\"<div layout=column><div layout=row><md-autocomplete required md-items=\\\"item in vm.authorRoles\\\" md-item-text=role md-min-length=0 md-search-text=ref.role md-selected-item-change=\\\"ref.role = item\\\" md-floating-label=role><md-item-template><span md-highlight-text=ref.role>{{item}}</span></md-item-template></md-autocomplete><md-input-container flex><label>first name</label><input type=text ng-model=ref.firstName></md-input-container><md-input-container flex><label>last name</label><input type=text ng-model=ref.lastName></md-input-container></div><div layout=row><md-autocomplete flex md-items=\\\"person in vm.getResults(vm.linkAuthorSearchText)\\\" md-item-text=person.label md-search-text=vm.linkAuthorSearchText md-search-text-change=vm.searchPeople(vm.linkAuthorSearchText) md-selected-item-change=vm.setLinkedAuthor(person) md-floating-label=\\\"linked author\\\"><span md-highlight-text=vm.linkAuthorSearchText>{{person.label}}</span></md-autocomplete></div></div>\");\n$templateCache.put(\"app/work/components/copy-editor/copy-editor.html\",\"<ng-form name=copyForm layout=column flex><md-input-container><label for=title>Title</label><input type=text name=title id=title ng-model=copy.title></md-input-container><div layout=row><md-input-container><label for=type>Type</label><md-select name=type id=type ng-model=copy.type required ng-change=\\\"vm.setProperties(copy.type, copyUrl)\\\"><md-option ng-repeat=\\\"handler in vm.refHandlers\\\" value={{handler.id}}>{{handler.display}}</md-option></md-select></md-input-container><md-input-container flex><label for=url>URL</label><input type=url name=url id=url ng-model=copyUrl ng-change=\\\"vm.setProperties(copy.type, copyUrl)\\\"></md-input-container></div><ul class=\\\"properties properties-inline\\\"><li ng-repeat=\\\"(key, value) in copy.properties\\\"><span class=label>{{key}}</span> <span class=value>{{value}}</span></li></ul><md-input-container><label for=rights>Description of Rights</label><input type=text name=rights id=rights ng-model=copy.rights></md-input-container><h3>Summary</h3><summary-editor ng-model=copy.summary flex></summary-editor></ng-form>\");\n$templateCache.put(\"app/work/components/publication-info-editor/publication-info-editor.html\",\"<div layout=row><md-input-container flex><label>publisher</label><input type=text ng-model=pubInfo.publisher></md-input-container><md-input-container flex><label>location</label><input type=text ng-model=pubInfo.place></md-input-container><date-editor ng-model=pubInfo.date flex></date-editor></div>\");\n$templateCache.put(\"app/work/components/title-editor/title-editor.html\",\"<div layout=row><md-input-container><label>type</label><md-select ng-model=title.type required><md-option value=bibliographic>bibliographic</md-option><md-option value=canonical>canonical</md-option><md-option value=short>short</md-option></md-select></md-input-container><md-input-container flex><label>title</label><input type=text ng-model=title.title required><div ng-switch=title.type><small ng-switch-when=bibliographic>the full title as published on the work</small> <small ng-switch-when=canonical>title by which the work is commonly known in the academic realm</small> <small ng-switch-when=short>shortened title coloquially used by the public</small></div></md-input-container><md-input-container flex><label>subtitle</label><input type=text ng-model=title.subtitle></md-input-container></div>\");}]);"],"sourceRoot":"/source/"}